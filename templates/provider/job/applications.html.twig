{% extends 'provider/base.html.twig' %}

{% block title %}My Applications{% endblock %}

{% block provider_body %}

<style>
/* COMPLETE RESET - Remove ALL conflicting styles and apply clean spacing to match dashboard */

/* Reset app-wrapper - remove all custom.css overrides */
body.app .app-wrapper,
.app-wrapper {
    display: block !important;
    justify-content: unset !important;
    align-items: unset !important;
    width: 100% !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
}

/* Shift app-wrapper to the left to eliminate gap */
@media (min-width: 1200px) {
    body.app .app-wrapper,
    .app-wrapper {
        margin-left: 250px !important;
        transform: translateX(-150px) !important;
        width: calc(100% - 250px + 150px) !important;
    }
}

/* Reset app-content - remove all custom.css overrides */
body.app .app-wrapper .app-content,
.app-wrapper .app-content,
.app-content {
    padding-left: 0 !important;
    padding-right: 0 !important;
    padding-top: 20px !important;
    padding-bottom: 0 !important;
    max-width: 100% !important;
    width: 100% !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    position: relative !important;
    box-sizing: border-box !important;
}

/* Override custom.css width constraints at 1200px breakpoint */
@media (min-width: 1200px) {
    body.app .app-wrapper .app-content,
    .app-wrapper .app-content,
    .app-content {
        width: 100% !important;
        max-width: 100% !important;
    }
}

/* Reset container-xl - apply clean spacing matching dashboard */
body.app .app-wrapper .app-content .container-xl,
.app-wrapper .app-content .container-xl,
.app-content .container-xl,
body .app-content .container-xl,
div.container-xl,
[class*="container-xl"],
.container-xl {
    position: relative !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    padding-left: 0 !important;
    padding-right: 30px !important;
    max-width: 100% !important;
    width: 100% !important;
    transform: none !important;
    box-sizing: border-box !important;
}

/* Override ALL media queries from custom.css */
@media (min-width: 576px) {
    body.app .app-wrapper .app-content .container-xl,
    .app-wrapper .app-content .container-xl,
    .app-content .container-xl,
    body .app-content .container-xl,
    div.container-xl,
    [class*="container-xl"],
    .container-xl {
        padding-left: 0 !important;
        padding-right: 30px !important;
    }
}

@media (min-width: 992px) {
    body.app .app-wrapper .app-content .container-xl,
    .app-wrapper .app-content .container-xl,
    .app-content .container-xl,
    body .app-content .container-xl,
    div.container-xl,
    [class*="container-xl"],
    .container-xl {
        padding-left: 0 !important;
        padding-right: 30px !important;
    }
}

@media (min-width: 1200px) {
    body.app .app-wrapper {
        position: relative !important;
        margin-left: 250px !important;
        transform: translateX(-150px) !important;
        width: calc(100% - 250px + 150px) !important;
    }
    
    body.app .app-wrapper .app-content,
    .app-wrapper .app-content,
.app-content {
        position: relative !important;
        max-width: 100% !important;
        width: 100% !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    padding-left: 0 !important;
        padding-right: 0 !important;
    }
    
    body.app .app-wrapper .app-content .container-xl,
    .app-wrapper .app-content .container-xl,
    .app-content .container-xl,
    body .app-content .container-xl,
    div.container-xl,
    [class*="container-xl"],
    .container-xl {
        position: relative !important;
        padding-left: 0 !important;
        padding-right: 30px !important;
        max-width: 100% !important;
        width: 100% !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
}

@media (min-width: 1600px) {
    body.app .app-wrapper .app-content,
    .app-wrapper .app-content,
    .app-content {
        max-width: 100% !important;
        width: 100% !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
    
    body.app .app-wrapper .app-content .container-xl,
    .app-wrapper .app-content .container-xl,
    .app-content .container-xl,
    body .app-content .container-xl,
    div.container-xl,
    [class*="container-xl"],
    .container-xl {
        padding-left: 0 !important;
        padding-right: 30px !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
}

/* Make score field look editable with highlighting */
/* Todo Icon Styles */
.todo-icon {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #85BB65;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    box-shadow: 0 0 10px rgba(133, 187, 101, 0.6), 0 0 20px rgba(133, 187, 101, 0.4);
    animation: pulse-glow 2s ease-in-out infinite;
    pointer-events: auto;
}

.todo-icon * {
    pointer-events: none;
}

.todo-icon:hover {
    box-shadow: 0 0 15px rgba(133, 187, 101, 0.8), 0 0 30px rgba(133, 187, 101, 0.6);
    animation: none;
}

@keyframes pulse-glow {
    0%, 100% {
        box-shadow: 0 0 10px rgba(133, 187, 101, 0.6), 0 0 20px rgba(133, 187, 101, 0.4);
    }
    50% {
        box-shadow: 0 0 15px rgba(133, 187, 101, 0.8), 0 0 30px rgba(133, 187, 101, 0.6);
    }
}

.todo-icon svg {
    width: 12px;
    height: 12px;
    fill: white;
}

.todo-popup {
    position: fixed;
    background: #121C0C;
    color: white;
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 13px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    z-index: 99999;
    max-width: 250px;
    display: none;
    pointer-events: none;
}

.todo-popup.show {
    display: block;
    pointer-events: auto;
}

.todo-popup-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.todo-popup-title {
    font-weight: 600;
    font-size: 14px;
}

.todo-popup-close {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.7;
    transition: opacity 0.2s ease;
}

.todo-popup-close:hover {
    opacity: 1;
}

.todo-popup-content {
    line-height: 1.5;
}

.todo-icon-wrapper {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.rank-display {
    cursor: pointer !important;
    padding: 4px 8px !important;
    border-radius: 6px !important;
    transition: all 0.2s ease !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    min-width: 45px !important;
    text-align: center !important;
    background-color: #f0f9f0 !important;
    border: 1px solid #b3e6b3 !important;
    color: #2d7a2d !important;
    font-weight: 500 !important;
    margin: 0 auto !important;
}

.rank-display:hover {
    background-color: #e0f5e0 !important;
    border-color: #80d980 !important;
    box-shadow: 0 2px 4px rgba(45, 122, 45, 0.2) !important;
    transform: translateY(-1px) !important;
}

.rank-display:active {
    background-color: #ccefcc !important;
    transform: translateY(0) !important;
}

.rank-input {
    background-color: #fff !important;
    border: 2px solid #85BB65 !important;
    border-radius: 6px !important;
    padding: 4px 6px !important;
    font-weight: 500 !important;
    color: #2d7a2d !important;
    box-shadow: 0 2px 8px rgba(133, 187, 101, 0.3) !important;
    text-align: center !important;
    width: 50px !important;
    min-width: 50px !important;
    max-width: 50px !important;
    box-sizing: border-box !important;
    flex-shrink: 0 !important;
}

.rank-input:focus {
    outline: none !important;
    border-color: #6fa852 !important;
    box-shadow: 0 0 0 3px rgba(133, 187, 101, 0.2) !important;
}

/* Force remove any fixed/sticky positioning from status bar and buttons */
.job-section,
.application,
.actions-container {
    position: relative !important;
    top: auto !important;
    bottom: auto !important;
    left: auto !important;
    right: auto !important;
}

/* Exception: Allow filter panel and dropdowns to use absolute positioning - must come after the general rules */
/* These must override any parent container rules */
.filter-panel,
.custom-dropdown,
.columns-panel,
.menu-panel,
.dropdown-panel,
.position-relative .filter-panel,
.position-relative .custom-dropdown,
.actions-container .filter-panel,
.actions-container .custom-dropdown,
.job-actions-left .filter-panel,
.job-actions-left .custom-dropdown {
    position: absolute !important;
    /* Don't override top/left/right - let inline styles or .custom-dropdown class handle it */
    /* Ensure these are not affected by parent positioning rules */
}

/* Override any external sticky classes */
.application-sticky,
.job-section.application-sticky,
.application.application-sticky,
.actions-container.application-sticky {
    position: relative !important;
    top: auto !important;
    bottom: auto !important;
}

.job-header, .job-row {
    display: flex;
    align-items: center;
    min-width: 0;
    overflow: hidden;
}

.col-job,
.col-location,
.col-schedule,
.col-expiry,
.col-start,
.col-action {
    flex: 1;
    min-width: 130px;
}
.col-job {
    flex: 2;
}
.job-header {
    padding-left: 8px;
    padding-right: 8px;
    color: #121C0C;
    box-shadow: 0 2px 6px rgba(11,22,40,0.03);
    border-radius: 10px;
    border: 1px solid #e6eef6;
    height: 40px;
    margin-bottom: 2px;
    font-size: 13px;
    min-width: 0;
    overflow: hidden;
}
.job-row {
    border: none;
    padding: 8px 8px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin: 2px 0;
    align-items: center;
    margin: 2px 0;
    font-size: 13px;
    border-radius: 10px;
    background: #F4F9F1;
    border: 1px solid #e6eef6;
    box-shadow: 0 2px 6px rgba(11,22,40,0.03);
    min-width: 0;
    overflow: hidden;
}
.truncate-text {
    display: inline-block;
    max-width: 180px; /* Adjust as needed */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    vertical-align: middle;
}
.job-section {
    background-color: #fff;
    position: relative !important;
    z-index: 1;
    top: auto !important;
    bottom: auto !important;
    left: auto !important;
    right: auto !important;
    transform: none !important;
    /* Allow dropdowns to overflow */
    overflow: visible !important;
}
.job-check {
    margin-right: 8px;
    transform: scale(1.2);
}
#toggleActions {
    padding: 6px 16px;
    border-radius: 18px;
    border: 1px solid #ddd;
    font-size: 16px;
    color: #fff;
}
.job-meta {
    margin-top: 1px;
}
.ml-15-px {
    margin-left: 0 !important; /* Remove left margin to shift content left */
}
.mr-15-px {
    margin-right: 15px;
}
.action-btn {
    background: transparent;
    border: none;
    padding: 0 4px;
}

/* Note button visibility - show when job details are viewed */
#note-btn {
    display: none;
}

#note-btn[style*="flex"] {
    display: flex !important;
}

.custom-dropdown {
  position: absolute !important;
  top: 110% !important;
  left: 0 !important;
  background: #fff;
  padding: 10px;
  min-width: 150px;
  z-index: 1000 !important;
  border: 1px solid #e6eef6;
  box-shadow: 0 2px 6px rgba(11,22,40,0.03);
  border-radius: 10px;
}

/* Ensure filter panel specifically works as overlay */
#filter-panel.filter-panel.custom-dropdown {
  position: absolute !important;
  top: 100% !important;
  left: 0 !important;
  margin-top: 8px !important;
  z-index: 9999 !important;
  /* Ensure it's not clipped by parent containers */
  overflow: visible !important;
  /* Make sure it appears above everything */
  background: #fff !important;
  border: 1px solid #e6eef6 !important;
  box-shadow: 0 2px 6px rgba(11,22,40,0.03) !important;
  border-radius: 10px !important;
  padding: 0 !important;
  min-width: 280px !important;
}

/* Ensure filter panel content has proper spacing */
#filter-panel.filter-panel.custom-dropdown > div {
  padding: 16px !important;
}

/* Style form controls in filter panel */
#filter-panel .form-control {
  border: 1px solid #e6eef6;
  border-radius: 6px;
  width: 100%;
  box-sizing: border-box;
}

#filter-panel .form-control:focus {
  border-color: #85BB65;
  outline: none;
  box-shadow: 0 0 0 2px rgba(133, 187, 101, 0.1);
}

.hidden {
  display: none !important;
}

/* Ensure filter panel is visible when not hidden */
#filter-panel.filter-panel.custom-dropdown:not(.hidden) {
  display: block !important;
}

.columns-panel label {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
  cursor: pointer;
  font-weight: 400;
  color: #121C0C;
}

.menu-panel .menu-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 0;
  cursor: pointer;
  color: #121C0C;
}

.menu-panel svg {
    width: 16px;
    height: 16px;
}

.dropdown-cstm {
    background: #F4F9F1;
    border: 1px solid #e6eef6;
    box-shadow: 0 2px 6px rgba(11,22,40,0.03);
    border-radius: 10px;
    padding: 4px 12px;
}

.menu-panel {
    min-width: 160px;
}

.columns-panel input[type="checkbox"] {
    appearance: none;
    width: 16px;
    height: 16px;
    border: 1px solid #cfd9e3;
    border-radius: 4px;
    background-color: #fff;
    cursor: pointer;
    position: relative;
    transition: background-color 0.3s ease, border-color 0.3s ease;
}

.columns-panel input[type="checkbox"]:hover {
    border-color: #85BB65;
}

.columns-panel input[type="checkbox"]:checked {
    background-color: #85BB65;
    border-color: #85BB65;
}

.columns-panel input[type="checkbox"]:checked::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 5px;
    width: 4px;
    height: 8px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

.col-check input[type="checkbox"] {
    appearance: none;
    width: 16px;
    height: 16px;
    border: 1px solid #cfd9e3;
    border-radius: 4px;
    background-color: #fff;
    cursor: pointer;
    position: relative;
    transition: background-color 0.3s ease, border-color 0.3s ease;
}

.col-check input[type="checkbox"]:hover {
    border-color: #85BB65;
}

.col-check input[type="checkbox"]:checked {
    background-color: #85BB65;
    border-color: #85BB65;
}

.col-check input[type="checkbox"]:checked::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 5px;
    width: 4px;
    height: 8px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

/* Consistent rounded rectangle style for all checkboxes on applications table */
.job-list-container input[type="checkbox"] {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border: 1px solid #cfd9e3;
    border-radius: 4px;
    background: #fff;
    cursor: pointer;
    position: relative;
    display: inline-block;
    vertical-align: middle;
    margin: 0;
    transition: background-color 0.3s ease, border-color 0.3s ease;
}

/* Hover state - green border */
.job-list-container input[type="checkbox"]:hover {
  border-color: #85BB65;
}

/* Checked state - green filled with white checkmark */
.job-list-container input[type="checkbox"]:checked {
  background-color: #85BB65;
  border-color: #85BB65;
}

.job-list-container input[type="checkbox"]:checked::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 6px;
    width: 4px;
    height: 8px;
    border: solid #fff;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

.job-title {
    color: #121C0C;
    font-size: 16px;
}

.action-btn {
    border: 1px solid #e6eef6;
    box-shadow: 0 2px 6px rgba(11,22,40,0.03);
    border-radius: 10px;
    padding: 4px 12px;
    display: flex;
    gap: 6px;
    align-items: center;
    white-space: nowrap;
    flex-shrink: 0;
}
.action-btn, .dropdown-cstm {
    transition: all 0.2s ease;
}
.action-btn:hover, .dropdown-cstm:hover {
    color: #85BB65;
    border: 1px solid #85BB65;
    transition: all 0.2s ease;
}
.action-btn:hover svg {
    color: #85BB65;
}
#delete-btn:hover {
    color: #BA1824;
    border: 1px solid #BA1824;
    transition: all 0.2s ease; 
}
#delete-btn:hover svg {
    color: #BA1824;
}
.col-center {
    text-align: center;
}
.col-rank {
    min-width: 100px !important;
    max-width: none !important;
    width: 100px !important;
}
.application {
    padding-left: 16px;
    position: relative !important;
    top: auto !important;
    bottom: auto !important;
    left: auto !important;
    right: auto !important;
    transform: none !important;
    /* Allow dropdowns to overflow */
    overflow: visible !important;
}
.application .card {
    clip-path: polygon(0% 0%,calc(100% - 15px) 0%,100% 50%,calc(100% - 15px) 100%,0% 100%,15px 50%,0% 0%);
    display: flex;
    justify-content: center;
    align-items: center;
    margin-left: -15px;
    margin-bottom: 0 !important;
    cursor: pointer;
    height: 100%;
    width: 100%;
    flex: 1;
}

/* First card: no left cutout */
.application .col:first-child {
    max-width: 80px;
    display: flex;
}

.application .col:first-child > a {
    display: flex;
    width: 100%;
    flex: 1;
}

.application .col:first-child .card {
    clip-path:none;
    margin-left: 0;
    margin-bottom: 0 !important;
    align-items: center;
    justify-content: center;
    height: 100%;
    width: 100%;
    flex: 1;
}
.application .row .col {
    display: flex;
}

.application .row .col > a {
    display: flex;
    width: 100%;
    flex: 1;
}

.application .col .card-body {
    justify-content: center;
    flex-direction: column-reverse;
    text-align: center;
    align-items: center;
    display: flex;
    height: 100%;
    min-height: 100%;
    padding: 0.5rem 1rem;
}
.application .col .card-body .card-title {
    font-size: 16px;
}
.is-card.is-applied:hover *, .is-card.is-review:hover *, .is-card.is-interview:hover *, .is-card.is-rejected:hover *, .is-card.is-hired:hover *, .is-card.is-offered:hover *, .is-card.is-completed:hover *, .is-card.is-applied.active *, .is-card.is-review.active *, .is-card.is-interview.active *, .is-card.is-rejected.active *, .is-card.is-hired.active *, .is-card.is-offered.active *, .is-card.is-completed.active *, .is-card .card-body p, .is-card .card-body:hover, .application .col .card-body .card-title:hover, .is-card:hover {
    color: rgb(33, 37, 41);
}
.application .col .card-body p {
    font-size: 16px;
    color: #121C0C;
}
.application .col:first-child .card .card-body {
    align-items: center;
}
.application .col:nth-child(2) .card {
    clip-path: polygon(0% 0%,calc(100% - 15px) 0%,100% 50%,calc(100% - 15px) 100%,0% 100%,0% 0%);
    margin-left: 0;
}
.application .col:last-child .card {
    clip-path: polygon(0% 0%,100% 0%,100% 100%,0% 100%,15px 50%,0% 0%);
}
.application .col:first-child .card-body p {
    display: none;
}
.application .col:first-child .card-body .card-title {
    font-size: 16px;
}
.col:nth-child(1) .is-card {
    background-color: #D2E6C6;
}
.col:nth-child(2) .is-card {
    background-color: #C7E0B8;
}
.col:nth-child(3) .is-card {
    background-color: #BBDAAA;
}
.col:nth-child(4) .is-card {
    background-color: #AFD39C;
}
.col:nth-child(5) .is-card {
    background-color: #A4CC8E;
}
.col:nth-child(6) .is-card {
    background-color: #99C680;
}
.col:nth-child(7) .is-card {
    background-color: #8DC072;
}
.col:nth-child(8) .is-card {
    background-color: #82B964;
}

.col:nth-child(1) .is-card:hover {
    background-color: #B9F2FF;
}
.col:nth-child(2) .is-card:hover {
    background-color: #ADF0FF;
}
.col:nth-child(3) .is-card:hover {
    background-color: #99ECFF;
}
.col:nth-child(4) .is-card:hover {
    background-color: #85E9FF;
}
.col:nth-child(5) .is-card:hover {
    background-color: #70E5FF;
}
.col:nth-child(6) .is-card:hover {
    background-color: #5CE1FF;
}
.col:nth-child(7) .is-card:hover {
    background-color: #47DDFF;
}
.col:nth-child(8) .is-card:hover {
    background-color: #33DAFF;
}
.col .is-card.is-applied.active {
    background-color: #99ECFF;
}
.col .is-card.is-interview.active {
    background-color: #85E9FF;
}
.col .is-card.is-offered.active {
    background-color: #70E5FF;
}
.col .is-card.is-hired.active {
    background-color: #5CE1FF;
}
.col .is-card.is-completed.active {
    background-color: #47DDFF;
}
.badge.badge-pill {
    background: none;
    animation: colorChange 1s infinite alternate;
    font-weight: 400 !important;
}
@keyframes colorChange {
    0% {
        color: #0096B8;
    }
    100% {
        color: #33DAFF;
    }
}
.job-actions a {
    color : #000;
}
.job-actions a:hover {
    color : #85BB65;
}

.actions-container {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  gap: 16px;
  margin-top: 20px;
  margin-bottom: 12px;
  padding-left: 15px;
  padding-right: 15px;
  position: relative !important;
  top: auto !important;
  bottom: auto !important;
  left: auto !important;
  right: auto !important;
  transform: none !important;
  /* Ensure dropdowns are not clipped */
  overflow: visible !important;
}

/* Ensure parent containers don't clip the dropdown */
.job-actions-left {
  overflow: visible !important;
  position: relative;
}

.position-relative {
  overflow: visible !important;
}

/* Enhanced table alignment and typography */
.job-header {
    font-size: 13px;
    font-weight: 600;
    color: #121C0C;
    letter-spacing: 0.01em;
    line-height: 1.5;
    background: #F8FAF9;
    border-bottom: 2px solid #e6eef6;
}

.job-row {
    font-size: 13px;
    font-weight: 400;
    color: #1a1a1a;
    line-height: 1.5;
    transition: background-color 0.2s ease;
}

.job-row:hover {
    background-color: #F8FAF9;
}

/* Perfect alignment between headers and rows */
.job-header > div,
.job-row > div {
    display: flex;
    align-items: center;
    box-sizing: border-box;
    padding: 12px 8px;
    min-width: 0;
    overflow: hidden;
    height: 48px;
}

/* Ensure consistent vertical alignment */
.job-header {
    min-height: 48px;
    height: 48px;
}

/* Center content for numeric/text columns */
.job-header .col-start.col-center,
.job-row .col-start.col-center {
    justify-content: center;
    text-align: center;
}

/* Job column specific styling */
.col-job {
    font-weight: 500;
}

/* Improve text truncation */
.job-title {
    font-size: 13px;
    font-weight: 500;
    color: #121C0C;
    line-height: 1.4;
}

/* Consistent cell content styling */
.job-row > div {
    font-size: 13px;
    color: #1a1a1a;
}

/* Status and badge styling */
.job-row .badge {
    font-size: 11px;
    font-weight: 500;
    padding: 4px 8px;
    border-radius: 6px;
}

.job-actions-left {
  justify-self: start;
  flex-wrap: nowrap;
  overflow-x: auto;
  overflow-y: visible;
}

.job-actions-middle {
  justify-self: center;
  flex-wrap: nowrap;
}

.col-dropdowns {
    justify-self: end;
}

.table-responsive-wrapper {
    overflow-x: auto;
    overflow-y: visible;
    -webkit-overflow-scrolling: touch;
}

.table-responsive-wrapper::-webkit-scrollbar {
    height: 8px;
}

.table-responsive-wrapper::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.table-responsive-wrapper::-webkit-scrollbar-thumb {
    background: #85BB65;
    border-radius: 10px;
}

.table-responsive-wrapper::-webkit-scrollbar-thumb:hover {
    background: #6fa852;
}

.sort-toggle {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    line-height: 1;
    gap: 2px;
    margin-left: 6px;
    vertical-align: middle;
    position: relative;
    top: 1px;
}
.sort-toggle svg { width: 10px; height: 10px; }
.sort-toggle .arrow { opacity: 0.35; transition: opacity 0.15s ease; }
.sort-toggle .arrow.active { opacity: 1; }

.col-start.col-center {
    box-sizing: border-box;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    min-width: 0;
}

.job-row .col-start.col-center {
    max-width: 100%;
    word-wrap: break-word;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 0;
}

.job-header .col-start.col-center {
    box-sizing: border-box;
}

/* Loading spinner for hire button */
.loading-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #85BB65;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Success message styles */
.success-message {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #4CAF50;
    color: white;
    padding: 15px 20px;
    border-radius: 5px;
    z-index: 9999;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.error-message {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #f44336;
    color: white;
    padding: 15px 20px;
    border-radius: 5px;
    z-index: 9999;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.email-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.3);
  z-index: 9999;
}
.email-modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: min(700px, 95vw);
  max-height: 80vh;
  background: #fff;
  border: 1px solid #e6eef6;
  border-radius: 12px;
  box-shadow: 0 12px 30px rgba(17,24,39,0.12);
  display: flex;
  flex-direction: column;
  z-index: 10000;
}
.email-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 18px;
  border-bottom: 1px solid #e6eef6;
}
.email-modal-body {
  padding: 16px 18px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.email-modal-body label {
  font-size: 13px;
  font-weight: 600;
  color: #121C0C;
}
.email-modal-body input,
.email-modal-body textarea {
  width: 100%;
  border: 1px solid #e6eef6;
  border-radius: 8px;
  padding: 10px 12px;
  outline: none;
  font-size: 13px;
  box-shadow: inset 0 1px 2px rgba(17,24,39,0.05);
}
.email-modal-body textarea {
  min-height: 190px;
  resize: vertical;
  line-height: 1.5;
}
.email-modal-footer {
  display: flex;
  gap: 10px;
  padding: 14px 18px;
  border-top: 1px solid #e6eef6;
  background: #fafbfc;
}
.email-modal-close {
  background: transparent;
  border: none;
  font-size: 22px;
  cursor: pointer;
  color: #667085;
  transition: color 0.2s ease;
}
.email-modal-close:hover {
  color: #121C0C;
}
</style>

<script>
// Force apply styles via JavaScript - COMPLETE OVERRIDE - Run multiple times to ensure it sticks
function applySpacingStyles() {
    // Reset and apply container-xl styles
    const container = document.querySelector('.container-xl');
    if (container) {
        container.style.setProperty('position', 'relative', 'important');
        container.style.setProperty('padding-left', '0', 'important');
        container.style.setProperty('padding-right', '30px', 'important');
        container.style.setProperty('margin-left', '0', 'important');
        container.style.setProperty('margin-right', '0', 'important');
        container.style.setProperty('transform', 'none', 'important');
        container.style.setProperty('max-width', '100%', 'important');
        container.style.setProperty('width', '100%', 'important');
    }
    
    // Remove left padding from application status tracker
    const application = document.querySelector('.application');
    if (application) {
        application.style.setProperty('padding-left', '0', 'important');
        application.style.setProperty('margin-left', '0', 'important');
    }
    
    // Reset app-content
    const appContent = document.querySelector('.app-content');
    if (appContent) {
        appContent.style.setProperty('position', 'relative', 'important');
        appContent.style.setProperty('padding-left', '0', 'important');
        appContent.style.setProperty('padding-right', '0', 'important');
        appContent.style.setProperty('margin-left', '0', 'important');
        appContent.style.setProperty('margin-right', '0', 'important');
        appContent.style.setProperty('max-width', '100%', 'important');
        appContent.style.setProperty('width', '100%', 'important');
    }
    
    // Reset app-wrapper
    const appWrapper = document.querySelector('.app-wrapper');
    if (appWrapper) {
        appWrapper.style.setProperty('position', 'relative', 'important');
        if (window.innerWidth >= 1200) {
            appWrapper.style.setProperty('margin-left', '250px', 'important');
            appWrapper.style.setProperty('transform', 'translateX(-150px)', 'important');
            appWrapper.style.setProperty('width', 'calc(100% - 250px + 150px)', 'important');
        } else {
            appWrapper.style.setProperty('margin-left', '0', 'important');
            appWrapper.style.setProperty('transform', 'none', 'important');
            appWrapper.style.setProperty('width', '100%', 'important');
        }
        appWrapper.style.setProperty('margin-right', '0', 'important');
        appWrapper.style.setProperty('padding-left', '0', 'important');
        appWrapper.style.setProperty('padding-right', '0', 'important');
    }
    
    // Remove padding from all rows and first columns
    const rows = document.querySelectorAll('.container-xl .row');
    rows.forEach(row => {
        row.style.setProperty('margin-left', '0', 'important');
        row.style.setProperty('padding-left', '0', 'important');
    });
    
    const firstCols = document.querySelectorAll('.container-xl .row > [class*="col-"]:first-child');
    firstCols.forEach(col => {
        col.style.setProperty('padding-left', '0', 'important');
        col.style.setProperty('margin-left', '0', 'important');
    });
}

// Run immediately
document.addEventListener('DOMContentLoaded', applySpacingStyles);

// Run after a short delay to override any late-loading styles
setTimeout(applySpacingStyles, 100);
setTimeout(applySpacingStyles, 500);

// Re-apply on window resize to override any responsive changes
window.addEventListener('resize', function() {
    setTimeout(applySpacingStyles, 50);
});
</script>

<!-- Add CSRF token here -->
<meta name="csrf-token" content="{{ csrf_token('archive') }}">

    {% set statusColors = {
        'saved': 'saved',
        'applied': 'applied',
        'interview': 'interview',
        'negotiating': 'offered',
        'accepted' : 'hired',
        'completed': 'completed',
    } %}

    {% set allStatuses = ['saved', 'applied', 'interview', 'negotiating', 'accepted', 'completed'] %}

    <div class="container-xl">
        <div class="job-section shadow-lg p-3 rounded-3">

            <!-- Flash Messages -->
            {% for message in app.flashes('success') %}
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
            
            {% for message in app.flashes('error') %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}

            <div class="application">
                <div class="row g-2">
                    <div class="col">
                        <a href="{{ path('app_provider_jobs_applications') }}">
                            <div class="card is-card mb-3 is-applied {% if app.request.get('status') and app.request.get('status') == '' %}active{% endif %}">
                                <div class="card-body">
                                    <h6 class="card-title">All</h6>
                                    <p class="card-text">{{ totalApplications|number_format }}</p>
                                </div>
                            </div>
                        </a>
                    </div>

                    {% for status in allStatuses %}
                        {% set count = 0 %}
                        {% for item in statusCounts %}
                            {% if item.status == status %}
                                {% set count = item.count %}
                            {% endif %}
                        {% endfor %}
                        <div class="col">
                            <a href="{% if status == 'saved' %}{{ path('app_provider_jobs_saved') }}{% else %}{{ path('app_provider_jobs_applications', {'status': status}) }}{% endif %}">
                            <div class="card is-card mb-3 is-{{ statusColors[status] }} {% if app.request.get('status') == status or (status == 'saved' and app.request.get('_route') == 'app_provider_jobs_saved') %}active{% endif %}">
                                <div class="card-body">
                                    <h6 class="card-title">{{ status | replace({'_': ' '}) | title }}</h6>
                                    <p class="card-text">{{ count }}</p>
                                </div>
                            </div>
                            </a>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="actions-container ml-15-px mr-15-px">
                <!-- Left Group: Filter, Notify of hire, Say thank you, and conditional buttons -->
                <div class="job-actions-left" style="display: flex; gap: 8px; align-items: center; flex-wrap: nowrap; white-space: nowrap;">
                  <div class="position-relative" style="flex-shrink: 0;">
                    <button id="filter-btn" class="action-btn" title="Filter">
                    <svg class="icon-image" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 7H21M7 12H17M10 17H14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    Filter
                  </button>
                    <div id="filter-panel" class="filter-panel custom-dropdown hidden" style="position: absolute; top: 100%; left: 0; margin-top: 8px; min-width: 280px; z-index: 9999; background: #fff; border: 1px solid #e6eef6; box-shadow: 0 2px 6px rgba(11,22,40,0.03); border-radius: 10px; padding: 0;">
                      <div style="padding: 16px;">
                        <h6 style="margin-bottom: 12px; font-weight: 600; color: #121C0C;">Filter Applications</h6>
                        
                        <!-- Location Filter -->
                        <div style="margin-bottom: 16px;">
                          <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: #121C0C;">Location</label>
                          <input type="text" id="filter-location" class="form-control" placeholder="Enter location" style="font-size: 13px; padding: 6px 10px;">
                        </div>
                        
                        <!-- Salary Range Filter -->
                        <div style="margin-bottom: 16px;">
                          <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: #121C0C;">Salary Range</label>
                          <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="number" id="filter-salary-min" class="form-control" placeholder="Min" style="font-size: 13px; padding: 6px 10px; flex: 1;">
                            <span style="color: #6b7280;">-</span>
                            <input type="number" id="filter-salary-max" class="form-control" placeholder="Max" style="font-size: 13px; padding: 6px 10px; flex: 1;">
                          </div>
                        </div>
                        
                        <!-- Applied Date Filter -->
                        <div style="margin-bottom: 16px;">
                          <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: #121C0C;">Applied Within</label>
                          <select id="filter-date-applied" class="form-control" style="font-size: 13px; padding: 6px 10px;">
                            <option value="">Any time</option>
                            <option value="1">Last 24 hours</option>
                            <option value="7">Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 3 months</option>
                          </select>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 8px; margin-top: 16px;">
                          <button id="apply-filter-btn" class="action-btn" style="flex: 1; padding: 8px 12px; font-size: 13px;">Apply</button>
                          <button id="clear-filter-btn" class="action-btn" style="flex: 1; padding: 8px 12px; font-size: 13px; background: #f3f4f6; color: #6b7280;">Clear</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <button id="save-btn" class="action-btn" title="Save" style="display: none;">
                    <svg class="icon-image" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 10.5V12C22 16.714 22 19.0711 20.5355 20.5355C19.0711 22 16.714 22 12 22C7.28595 22 4.92893 22 3.46447 20.5355C2 19.0711 2 16.714 2 12C2 7.28595 2 4.92893 3.46447 3.46447C4.92893 2 7.28595 2 12 2H13.5" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/>
                    <circle cx="19" cy="5" r="3" stroke="#1C274C" stroke-width="1.5"/>
                    <path d="M7 14H16" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/>
                    <path d="M7 17.5H13" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg> Notify of hire
                  </button>
                  <button id="email-btn" class="action-btn" title="Email">
                    <svg class="icon-image" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g id="style=stroke">
                    <g id="email">
                    <path id="vector (Stroke)" fill-rule="evenodd" clip-rule="evenodd" d="M3.88534 5.2371C3.20538 5.86848 2.75 6.89295 2.75 8.5V15.5C2.75 17.107 3.20538 18.1315 3.88534 18.7629C4.57535 19.4036 5.61497 19.75 7 19.75H17C18.385 19.75 19.4246 19.4036 20.1147 18.7629C20.7946 18.1315 21.25 17.107 21.25 15.5V8.5C21.25 6.89295 20.7946 5.86848 20.1147 5.2371C19.4246 4.59637 18.385 4.25 17 4.25H7C5.61497 4.25 4.57535 4.59637 3.88534 5.2371ZM2.86466 4.1379C3.92465 3.15363 5.38503 2.75 7 2.75H17C18.615 2.75 20.0754 3.15363 21.1353 4.1379C22.2054 5.13152 22.75 6.60705 22.75 8.5V15.5C22.75 17.393 22.2054 18.8685 21.1353 19.8621C20.0754 20.8464 18.615 21.25 17 21.25H7C5.38503 21.25 3.92465 20.8464 2.86466 19.8621C1.79462 18.8685 1.25 17.393 1.25 15.5V8.5C1.25 6.60705 1.79462 5.13152 2.86466 4.1379Z" fill="currentColor"></path>
                    <path id="vector (Stroke)_2" fill-rule="evenodd" clip-rule="evenodd" d="M19.3633 7.31026C19.6166 7.63802 19.5562 8.10904 19.2285 8.3623L13.6814 12.6486C12.691 13.4138 11.3089 13.4138 10.3185 12.6486L4.77144 8.3623C4.44367 8.10904 4.38328 7.63802 4.63655 7.31026C4.88982 6.98249 5.36083 6.9221 5.6886 7.17537L11.2356 11.4616C11.6858 11.8095 12.3141 11.8095 12.7642 11.4616L18.3113 7.17537C18.6391 6.9221 19.1101 6.98249 19.3633 7.31026Z" fill="currentcolor"></path>
                    </g>
                    </g>
                    </svg> Email
                  </button>
                {% if app.request.get('status') not in ['saved', 'interview', 'negotiating', 'accepted', 'completed'] %}
                    <button id="request-response-btn" class="action-btn conditional-btn" disabled title="Request Response" style="display: none;">
                    <svg class="icon-image" fill="currentcolor" width="25" height="25" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <g data-name="Layer 2">
                    <g data-name="checkmark-circle">
                    <rect width="24" height="24" opacity="0"/>
                    <path d="M9.71 11.29a1 1 0 0 0-1.42 1.42l3 3A1 1 0 0 0 12 16a1 1 0 0 0 .72-.34l7-8a1 1 0 0 0-1.5-1.32L12 13.54z"/>
                    <path d="M21 11a1 1 0 0 0-1 1 8 8 0 0 1-8 8A8 8 0 0 1 6.33 6.36 7.93 7.93 0 0 1 12 4a8.79 8.79 0 0 1 1.9.22 a1 1 0 1 0 .47-1.94A10.54 10.54 0 0 0 12 2a10 10 0 0 0-7 17.09A9.93 9.93 0 0 0 12 22a10 10 0 0 0 10-10 1 1 0 0 0-1-1z"/>
                    </g>
                    </g>
                    </svg> Request Response
                  </button>
                {% endif %}
                {% if app.request.get('status') not in ['saved', 'applied', 'negotiating', 'accepted', 'completed'] %}
                  <button id="say-thank-you-btn" class="action-btn conditional-btn" title="Say thank you" style="display: none;">
                    <svg class="icon-image" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g id="style=stroke">
                    <g id="email">
                    <path id="vector (Stroke)" fill-rule="evenodd" clip-rule="evenodd" d="M3.88534 5.2371C3.20538 5.86848 2.75 6.89295 2.75 8.5V15.5C2.75 17.107 3.20538 18.1315 3.88534 18.7629C4.57535 19.4036 5.61497 19.75 7 19.75H17C18.385 19.75 19.4246 19.4036 20.1147 18.7629C20.7946 18.1315 21.25 17.107 21.25 15.5V8.5C21.25 6.89295 20.7946 5.86848 20.1147 5.2371C19.4246 4.59637 18.385 4.25 17 4.25H7C5.61497 4.25 4.57535 4.59637 3.88534 5.2371ZM2.86466 4.1379C3.92465 3.15363 5.38503 2.75 7 2.75H17C18.615 2.75 20.0754 3.15363 21.1353 4.1379C22.2054 5.13152 22.75 6.60705 22.75 8.5V15.5C22.75 17.393 22.2054 18.8685 21.1353 19.8621C20.0754 20.8464 18.615 21.25 17 21.25H7C5.38503 21.25 3.92465 20.8464 2.86466 19.8621C1.79462 18.8685 1.25 17.393 1.25 15.5V8.5C1.25 6.60705 1.79462 5.13152 2.86466 4.1379Z" fill="currentColor"></path>
                    <path id="vector (Stroke)_2" fill-rule="evenodd" clip-rule="evenodd" d="M19.3633 7.31026C19.6166 7.63802 19.5562 8.10904 19.2285 8.3623L13.6814 12.6486C12.691 13.4138 11.3089 13.4138 10.3185 12.6486L4.77144 8.3623C4.44367 8.10904 4.38328 7.63802 4.63655 7.31026C4.88982 6.98249 5.36083 6.9221 5.6886 7.17537L11.2356 11.4616C11.6858 11.8095 12.3141 11.8095 12.7642 11.4616L18.3113 7.17537C18.6391 6.9221 19.1101 6.98249 19.3633 7.31026Z" fill="currentcolor"></path>
                    </g>
                    </g>
                    </svg> Say thank you
                  </button>
                {% endif %}
                {% if app.request.get('status') not in ['saved', 'applied', 'interview', 'accepted', 'completed'] %}
                  <button id="follow-up-btn" class="action-btn conditional-btn" disabled title="Send Follow Up Note" style="display: none;">
                    <svg class="icon-image" fill="currentcolor" width="25" height="25" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <g data-name="Layer 2">
                    <g data-name="checkmark-circle">
                    <rect width="24" height="24" opacity="0"/>
                    <path d="M9.71 11.29a1 1 0 0 0-1.42 1.42l3 3A1 1 0 0 0 12 16a1 1 0 0 0 .72-.34l7-8a1 1 0 0 0-1.5-1.32L12 13.54z"/>
                    <path d="M21 11a1 1 0 0 0-1 1 8 8 0 0 1-8 8A8 8 0 0 1 6.33 6.36 7.93 7.93 0 0 1 12 4a8.79 8.79 0 0 1 1.9.22 a1 1 0 1 0 .47-1.94A10.54 10.54 0 0 0 12 2a10 10 0 0 0-7 17.09A9.93 9.93 0 0 0 12 22a10 10 0 0 0 10-10 1 1 0 0 0-1-1z"/>
                    </g>
                    </g>
                    </svg> Send Follow Up Note
                  </button>
                {% endif %}
                {% if app.request.get('status') not in ['saved', 'applied', 'interview', 'negotiating', 'completed'] %}
                  <button id="ask-details-btn" class="action-btn conditional-btn" disabled title="Ask for Details" style="display: none;">
                    <svg class="icon-image" fill="currentcolor" width="25" height="25" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <g data-name="Layer 2">
                    <g data-name="checkmark-circle">
                    <rect width="24" height="24" opacity="0"/>
                    <path d="M9.71 11.29a1 1 0 0 0-1.42 1.42l3 3A1 1 0 0 0 12 16a1 1 0 0 0 .72-.34l7-8a1 1 0 0 0-1.5-1.32L12 13.54z"/>
                    <path d="M21 11a1 1 0 0 0-1 1 8 8 0 0 1-8 8A8 8 0 0 1 6.33 6.36 7.93 7.93 0 0 1 12 4a8.79 8.79 0 0 1 1.9.22 a1 1 0 1 0 .47-1.94A10.54 10.54 0 0 0 12 2a10 10 0 0 0-7 17.09A9.93 9.93 0 0 0 12 22a10 10 0 0 0 10-10 1 1 0 0 0-1-1z"/>
                    </g>
                    </g>
                    </svg> Ask for Details
                  </button>
                {% endif %}
                {% if app.request.get('status') not in ['saved', 'applied', 'interview', 'negotiating', 'accepted'] %}
                  <button id="write-review-btn" class="action-btn conditional-btn" disabled title="Write Review" style="display: none;">
                    <svg class="icon-image" fill="currentcolor" width="25" height="25" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <g data-name="Layer 2">
                    <g data-name="checkmark-circle">
                    <rect width="24" height="24" opacity="0"/>
                    <path d="M9.71 11.29a1 1 0 0 0-1.42 1.42l3 3A1 1 0 0 0 12 16a1 1 0 0 0 .72-.34l7-8a1 1 0 0 0-1.5-1.32L12 13.54z"/>
                    <path d="M21 11a1 1 0 0 0-1 1 8 8 0 0 1-8 8A8 8 0 0 1 6.33 6.36 7.93 7.93 0 0 1 12 4a8.79 8.79 0 0 1 1.9.22 a1 1 0 1 0 .47-1.94A10.54 10.54 0 0 0 12 2a10 10 0 0 0-7 17.09A9.93 9.93 0 0 0 12 22a10 10 0 0 0 10-10 1 1 0 0 0-1-1z"/>
                    </g>
                    </g>
                    </svg> Write Review
                  </button>
                {% endif %}
                </div>
                
                <!-- Middle Group: Note, Archive, Delete -->
                <div class="job-actions-middle" style="display: flex; gap: 8px; align-items: center; flex-wrap: nowrap; white-space: nowrap;">
                  <button id="note-btn" class="action-btn d-none" title="Add Note" onclick="handleNoteClick()" style="display: none;">
                    <svg class="icon-image" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <!-- Sticky note with pencil icon -->
                      <path d="M8 3H14C16.7614 3 19 5.23858 19 8V14.5C19 15.0523 18.5523 15.5 18 15.5H14C12.3431 15.5 11 16.8431 11 18.5V20C11 20.5523 10.5523 21 10 21H8C5.23858 21 3 18.7614 3 16V8C3 5.23858 5.23858 3 8 3Z" stroke="currentColor" stroke-width="1.5"/>
                      <path d="M21 7L15 13L14 16L17 15L23 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Note
                  </button>
                  <button id="archive-btn" class="action-btn" title="Archive">
                    <svg class="icon-image" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 21L12 12M12 12L15 15.3333M12 12L9 15.3333" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M20.5 7V13C20.5 16.7712 20.5 18.6569 19.3284 19.8284C18.1569 21 16.2712 21 12.5 21H11.5C7.72876 21 5.84315 21 4.67157 19.8284C3.5 18.6569 3.5 16.7712 3.5 13V7" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/>
                    <path d="M2 5C2 4.05719 2 3.58579 2.29289 3.29289C2.58579 3 3.05719 3 4 3H20C20.9428 3 21.4142 3 21.7071 3.29289C22 3.58579 22 4.05719 22 5C22 5.94281 22 6.41421 21.7071 6.70711C21.4142 7 20.9428 7 20 7H4C3.05719 7 2.58579 7 2.29289 6.70711C2 6.41421 2 5.94281 2 5Z" stroke="currentcolor" stroke-width="1.5"/>
                    </svg> Archive
                  </button>
                  <button id="delete-btn" class="action-btn" title="Delete">
                    <svg class="icon-image" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9.17065 4C9.58249 2.83481 10.6937 2 11.9999 2C13.3062 2 14.4174 2.83481 14.8292 4" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/>
                    <path d="M20.5 6H3.49988" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/>
                    <path d="M18.3735 15.3991C18.1965 18.054 18.108 19.3815 17.243 20.1907C16.378 21 15.0476 21 12.3868 21H11.6134C8.9526 21 7.6222 21 6.75719 20.1907C5.89218 19.3815 5.80368 18.054 5.62669 15.3991L5.16675 8.5M18.8334 8.5L18.6334 11.5" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/>
                    <path d="M9.5 11L10 16" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/>
                    <path d="M14.5 11L14 16" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg> Delete
                  </button>
                </div>
                
                <!-- Right Group: Menu -->
                <div class="col-dropdowns d-flex gap-2">
                  <!-- Columns Dropdown -->
                  <div class="columns-dropdown position-relative" style = "display:none;">
                    <button type="button" class="columns-dropdown-btn dropdown-cstm"><span>Columns</span></button>
                    <div class="dropdown-panel columns-panel custom-dropdown hidden">
                      <label><input type="checkbox" value="salary"> Salary</label>
                      <label><input type="checkbox" value="location"> Location</label>
                      <label><input type="checkbox" value="date-posted"> Date Posted</label>
                      <label><input type="checkbox" value="deadline"> Deadline</label>
                      <label><input type="checkbox" value="date-applied"> Date Applied</label>
                      <label><input type="checkbox" value="excitement"> Score</label>
                    </div>
                  </div>

                  <!-- Menu Dropdown -->
                  <div class="menu-dropdown position-relative">
                    <button type="button" class="menu-dropdown-btn dropdown-cstm"><span>Menu</span></button>
                    <div class="dropdown-panel menu-panel custom-dropdown hidden">
                      <a href="{{ path('app_provider_jobs_archived') }}" class="menu-item" style="text-decoration: none; color: inherit;"><svg width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path opacity="0.5" d="M20.5 7V13C20.5 16.7712 20.5 18.6569 19.3284 19.8284C18.1569 21 16.2712 21 12.5 21H11.5C7.72876 21 5.84315 21 4.67157 19.8284C3.5 18.6569 3.5 16.7712 3.5 13V7" stroke="#121C0C" stroke-width="1.5" stroke-linecap="round"/>
                        <path d="M2 5C2 4.05719 2 3.58579 2.29289 3.29289C2.58579 3 3.05719 3 4 3H20C20.9428 3 21.4142 3 21.7071 3.29289C22 3.58579 22 4.05719 22 5C22 5.94281 22 6.41421 21.7071 6.70711C21.4142 7 20.9428 7 20 7H4C3.05719 7 2.58579 7 2.29289 6.70711C2 6.41421 2 5.94281 2 5Z" stroke="#121C0C" stroke-width="1.5"/>
                        <path d="M12 7L12 16M12 16L15 12.6667M12 16L9 12.6667" stroke="#121C0C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg> Archived Jobs</a>
                      <a href="{{ path('app_provider_download_data', {'type': 'applications'}) }}" class="menu-item" style="text-decoration: none; color: inherit;"><svg width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M16.44 8.8999C20.04 9.2099 21.51 11.0599 21.51 15.1099V15.2399C21.51 19.7099 19.72 21.4999 15.25 21.4999H8.73998C4.26998 21.4999 2.47998 19.7099 2.47998 15.2399V15.1099C2.47998 11.0899 3.92998 9.2399 7.46998 8.9099" stroke="#121C0C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 15.0001V3.62012" stroke="#121C0C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M15.35 5.85L12 2.5L8.65002 5.85" stroke="#121C0C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg> Export Report</a>
                    </div>
                  </div>
                </div>
            </div>

            {% if applications|length > 0 %}
            <div class="job-list-container bg-light p-3 rounded-3">
            <div class="table-responsive-wrapper" style="overflow-x: auto; width: 100%;">
            <div class="d-flex align-items-center job-lists">
                <div class="d-flex align-items-center flex-grow-1" style="width: 100%; min-width: 0;">
                    <div class="job-header d-flex align-items-center fw-semibold py-2 flex-grow-1" style="width: 100%; min-width: 0; gap: 0;">
                        <div class="col-check" style="width: 30px; flex-shrink: 0; padding: 0 8px; box-sizing: border-box; display: flex; align-items: center; justify-content: center;">
                          <input type="checkbox" id="select-all-checkbox" title="Select All" />
                        </div>
                        <div class="col-job sortable" data-sort="job" style="width: 200px; flex-shrink: 0; padding: 0 8px; box-sizing: border-box; display: flex; align-items: center; cursor: pointer;">Job Title<span class="sort-toggle"><svg class="arrow sort-up" width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="M6 15L12 9L18 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><svg class="arrow sort-down" width="12" height="12" viewBox="0 0 24 24" fill="none" style="transform: rotate(180deg);"><path d="M6 15L12 9L18 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span></div>
                        <div class="col-start col-center sortable" data-sort="location" style="width: 100px; flex-shrink: 0; padding: 0 8px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; cursor: pointer;">Location<span class="sort-toggle"><svg class="arrow sort-up" width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="M6 15L12 9L18 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><svg class="arrow sort-down" width="12" height="12" viewBox="0 0 24 24" fill="none" style="transform: rotate(180deg);"><path d="M6 15L12 9L18 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span></div>
                        <div class="col-start col-center sortable" data-sort="salary" style="width: 100px; flex-shrink: 0; padding: 0 8px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; cursor: pointer;">Salary<span class="sort-toggle"><svg class="arrow sort-up" width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="M6 15L12 9L18 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><svg class="arrow sort-down" width="12" height="12" viewBox="0 0 24 24" fill="none" style="transform: rotate(180deg);"><path d="M6 15L12 9L18 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span></div>
                        <div class="col-start col-center sortable" data-sort="employer" style="width: 120px; flex-shrink: 0; padding: 0 8px; box-sizing: border-box; display: flex; align-items: center; justify-content: center;">Employer</div>
                        <div class="col-start col-center sortable" data-sort="applied" style="width: 100px; flex-shrink: 0; padding: 0 8px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; cursor: pointer;">Date Applied<span class="sort-toggle"><svg class="arrow sort-up" width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="M6 15L12 9L18 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><svg class="arrow sort-down" width="12" height="12" viewBox="0 0 24 24" fill="none" style="transform: rotate(180deg);"><path d="M6 15L12 9L18 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span></div>
                        <div class="col-start col-center sortable" data-sort="category" style="width: 120px; flex-shrink: 0; padding: 0 8px; box-sizing: border-box; display: flex; align-items: center; justify-content: center;">Category</div>
                        <div class="col-start col-center" style="width: 80px; flex-shrink: 0; padding: 0 8px; box-sizing: border-box; display: flex; align-items: center; justify-content: center;">To Do</div>
                        <div class="col-start col-center col-rank sortable" data-sort="rank" style="width: 100px; min-width: 100px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; padding: 0 8px; box-sizing: border-box; cursor: pointer; overflow: visible; position: relative;">Score<span class="sort-toggle"><svg class="arrow sort-up" width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="M6 15L12 9L18 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><svg class="arrow sort-down" width="12" height="12" viewBox="0 0 24 24" fill="none" style="transform: rotate(180deg);"><path d="M6 15L12 9L18 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span></div>
                        <div class="col-start col-center sortable" data-sort="status" style="width: 120px; flex-shrink: 0; padding: 0 8px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; cursor: pointer;">Status<span class="sort-toggle"><svg class="arrow sort-up" width="12" height="12" viewBox="0 0 24 24" fill="none"><path d="M6 15L12 9L18 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><svg class="arrow sort-down" width="12" height="12" viewBox="0 0 24 24" fill="none" style="transform: rotate(180deg);"><path d="M6 15L12 9L18 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span></div>
                    </div>
                </div>
            </div>

            {% for application in applications %}
            {% set job = application.job %}
              <div class="d-flex align-items-center job-lists">
                <div class="job-row d-flex align-items-center flex-grow-1" style="gap: 0; min-width: 0; width: 100%;">
                  <div class="col-check" style="width: 30px; flex-shrink: 0; padding: 0 8px; box-sizing: border-box; display: flex; align-items: center;">
                      <input type="checkbox" class="job-check job-checkbox" data-job-id="{{ job.id }}" data-application-id="{{ application.id }}" data-status="{{ application.status }}" />
                  </div>
                  <div class="col-job d-flex align-items-center gap-2" style="width: 200px; flex-shrink: 0; padding: 0 4px; box-sizing: border-box; min-width: 0; overflow: hidden;">
                      <img src="{{ job.companyLogo|default(asset('assets/icons/job.png')) }}"
                          alt="Logo"
                          style="width: 40px; height: 40px; border-radius: 8px;" />
                      <div style="min-width: 0; overflow: hidden;">
                          <a class="job-title truncate-text d-block fw-semibold text-decoration-none"
                            href="{{ path('app_provider_jobs_application_detail', {'id': application.id}) }}"
                            style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px;">
                              {{ job.title }}
                          </a>
                      </div>
                  </div>
                  <div class="col-start col-center" style="width: 100px; flex-shrink: 0; padding: 0 8px; box-sizing: border-box; display: flex; align-items: center; justify-content: center;">{{ job.state }}</div>
                  <div class="col-start col-center" style="width: 100px; flex-shrink: 0; padding: 0 8px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; font-size: 13px;">{{ job.formattedHourlyRate }}</div>
                  <div class="col-start col-center" style="width: 120px; flex-shrink: 0; padding: 0 8px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; font-size: 13px;">{{ job.employer|default(job.companyName|default('')) }}</div>
                  <div class="col-start col-center" style="width: 100px; flex-shrink: 0; padding: 0 8px; box-sizing: border-box; display: flex; align-items: center; justify-content: center;">{{ application.createdAt|date('m/d/Y') }}</div>
                  <div class="col-start col-center" style="width: 120px; flex-shrink: 0; padding: 0 8px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; font-size: 13px; color: #121C0C;">
                    {% if job.workType == 'locums' %}
                        Locums
                    {% elseif job.workType == 'parttime' or job.workType == 'part-time' %}
                        Parttime
                    {% elseif job.workType == 'fulltime' or job.workType == 'full-time' %}
                        Full time
                    {% else %}
                        {{ job.workType|default('')|replace({'_': ' '})|title }}
                    {% endif %}
                  </div>
                  <div class="col-start col-center" style="width: 80px; flex-shrink: 0; padding: 0 8px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; overflow: visible; position: relative;">
                      {% set todoTask = null %}
                      {% if application.documentRequestedAt and not application.documentProvidedAt %}
                          {% set todoTask = 'Provide requested documents' %}
                      {% elseif application.contractSentAt and not application.contractSignedAt %}
                          {% set todoTask = 'Sign and return contract' %}
                      {% elseif application.oneFileRequestedAt and not application.oneFileProvidedAt %}
                          {% set todoTask = 'Provide OneFile documents' %}
                      {% elseif application.status == 'interview' %}
                          {% set todoTask = 'Prepare for interview' %}
                      {% elseif application.status == 'negotiating' %}
                          {% set todoTask = 'Review and respond to offer' %}
                      {% endif %}
                      
                      {% if todoTask %}
                          <div class="todo-icon-wrapper">
                              <div class="todo-icon" data-todo-action="{{ todoTask }}" data-todo-type="application">
                                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                      <path d="M9 11L12 14L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                      <path d="M21 12V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                  </svg>
                              </div>
                          </div>
                      {% else %}
                          
                      {% endif %}
                  </div>
                  <div class="col-start col-center col-rank" style="width: 100px; min-width: 100px; flex-shrink: 0; padding: 0 8px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; overflow: visible; position: relative;">
                      <span class="rank-display" data-application-id="{{ application.id }}" style="font-size: 13px;">
                        {{ application.rank is not null ? application.rank : '' }}
                      </span>
                      <div class="rank-input-wrapper hidden">
                      <input type="number"
                              class="rank-input"
                            value="{{ application.rank is not null ? application.rank : '' }}"
                            min="1"
                            max="10"
                            step="0.5"
                            data-application-id="{{ application.id }}"
                            data-original-value="{{ application.rank is not null ? application.rank : '' }}"
                            oninput="if(this.value>10) this.value=10; if(this.value<1)this.value=1;" />
                        <button type="button" class="rank-save-btn" data-application-id="{{ application.id }}" title="Save">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </button>
                      </div>
                    </div>
                  <div class="col-start col-center" style="width: 120px; flex-shrink: 0; padding: 0 8px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; color: #000;">
                      {{ application.status | replace({'_': ' '}) | title }}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
            </div>
        </div>
        {% else %}
            <p>Applications not found.</p>
        {% endif %}
        <div class="job-actions hidden-buttons ml-15-px" style="margin-bottom: 20px; display: flex; gap: 8px; align-items: center; visibility: hidden;">
          <button id="save-btn-bottom" class="action-btn" title="Save" style="display: none;">
            <svg class="icon-image" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M22 10.5V12C22 16.714 22 19.0711 20.5355 20.5355C19.0711 22 16.714 22 12 22C7.28595 22 4.92893 22 3.46447 20.5355C2 19.0711 2 16.714 2 12C2 7.28595 2 4.92893 3.46447 3.46447C4.92893 2 7.28595 2 12 2H13.5" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/>
            <circle cx="19" cy="5" r="3" stroke="#1C274C" stroke-width="1.5"/>
            <path d="M7 14H16" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M7 17.5H13" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
          </button>
        {% if app.request.get('status') not in ['saved', 'interview', 'negotiating', 'accepted', 'completed'] %}
            <button id="apply-btn" class="action-btn" disabled title="Apply">
            <svg class="icon-image" fill="currentcolor" width="25" height="25" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <g data-name="Layer 2">
            <g data-name="checkmark-circle">
            <rect width="24" height="24" opacity="0"/>
            <path d="M9.71 11.29a1 1 0 0 0-1.42 1.42l3 3A1 1 0 0 0 12 16a1 1 0 0 0 .72-.34l7-8a1 1 0 0 0-1.5-1.32L12 13.54z"/>
            <path d="M21 11a1 1 0 0 0-1 1 8 8 0 0 1-8 8A8 8 0 0 1 6.33 6.36 7.93 7.93 0 0 1 12 4a8.79 8.79 0 0 1 1.9.22 a1 1 0 1 0 .47-1.94A10.54 10.54 0 0 0 12 2a10 10 0 0 0-7 17.09A9.93 9.93 0 0 0 12 22a10 10 0 0 0 10-10 1 1 0 0 0-1-1z"/>
            </g>
            </g>
            </svg>
          </button>
        {% endif %}
        {% if app.request.get('status') not in ['saved', 'applied', 'negotiating', 'accepted', 'completed'] %}
          <button id="email-btn" class="action-btn" title="Email">
            <svg class="icon-image" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g id="style=stroke">
            <g id="email">
            <path id="vector (Stroke)" fill-rule="evenodd" clip-rule="evenodd" d="M3.88534 5.2371C3.20538 5.86848 2.75 6.89295 2.75 8.5V15.5C2.75 17.107 3.20538 18.1315 3.88534 18.7629C4.57535 19.4036 5.61497 19.75 7 19.75H17C18.385 19.75 19.4246 19.4036 20.1147 18.7629C20.7946 18.1315 21.25 17.107 21.25 15.5V8.5C21.25 6.89295 20.7946 5.86848 20.1147 5.2371C19.4246 4.59637 18.385 4.25 17 4.25H7C5.61497 4.25 4.57535 4.59637 3.88534 5.2371ZM2.86466 4.1379C3.92465 3.15363 5.38503 2.75 7 2.75H17C18.615 2.75 20.0754 3.15363 21.1353 4.1379C22.2054 5.13152 22.75 6.60705 22.75 8.5V15.5C22.75 17.393 22.2054 18.8685 21.1353 19.8621C20.0754 20.8464 18.615 21.25 17 21.25H7C5.38503 21.25 3.92465 20.8464 2.86466 19.8621C1.79462 18.8685 1.25 17.393 1.25 15.5V8.5C1.25 6.60705 1.79462 5.13152 2.86466 4.1379Z" fill="currentColor"></path>
            <path id="vector (Stroke)_2" fill-rule="evenodd" clip-rule="evenodd" d="M19.3633 7.31026C19.6166 7.63802 19.5562 8.10904 19.2285 8.3623L13.6814 12.6486C12.691 13.4138 11.3089 13.4138 10.3185 12.6486L4.77144 8.3623C4.44367 8.10904 4.38328 7.63802 4.63655 7.31026C4.88982 6.98249 5.36083 6.9221 5.6886 7.17537L11.2356 11.4616C11.6858 11.8095 12.3141 11.8095 12.7642 11.4616L18.3113 7.17537C18.6391 6.9221 19.1101 6.98249 19.3633 7.31026Z" fill="currentcolor"></path>
            </g>
            </g>
            </svg>
          </button>
        {% endif %}
        {% if app.request.get('status') not in ['saved', 'applied', 'interview', 'accepted', 'completed'] %}
          <button id="apply-btn" class="action-btn" disabled title="Apply">
            <svg class="icon-image" fill="currentcolor" width="25" height="25" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <g data-name="Layer 2">
            <g data-name="checkmark-circle">
            <rect width="24" height="24" opacity="0"/>
            <path d="M9.71 11.29a1 1 0 0 0-1.42 1.42l3 3A1 1 0 0 0 12 16a1 1 0 0 0 .72-.34l7-8a1 1 0 0 0-1.5-1.32L12 13.54z"/>
            <path d="M21 11a1 1 0 0 0-1 1 8 8 0 0 1-8 8A8 8 0 0 1 6.33 6.36 7.93 7.93 0 0 1 12 4a8.79 8.79 0 0 1 1.9.22 a1 1 0 1 0 .47-1.94A10.54 10.54 0 0 0 12 2a10 10 0 0 0-7 17.09A9.93 9.93 0 0 0 12 22a10 10 0 0 0 10-10 1 1 0 0 0-1-1z"/>
            </g>
            </g>
            </svg>
          </button>
        {% endif %}
        {% if app.request.get('status') not in ['saved', 'applied', 'interview', 'negotiating', 'completed'] %}
          <button id="apply-btn" class="action-btn" disabled title="Apply">
            <svg class="icon-image" fill="currentcolor" width="25" height="25" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <g data-name="Layer 2">
            <g data-name="checkmark-circle">
            <rect width="24" height="24" opacity="0"/>
            <path d="M9.71 11.29a1 1 0 0 0-1.42 1.42l3 3A1 1 0 0 0 12 16a1 1 0 0 0 .72-.34l7-8a1 1 0 0 0-1.5-1.32L12 13.54z"/>
            <path d="M21 11a1 1 0 0 0-1 1 8 8 0 0 1-8 8A8 8 0 0 1 6.33 6.36 7.93 7.93 0 0 1 12 4a8.79 8.79 0 0 1 1.9.22 a1 1 0 1 0 .47-1.94A10.54 10.54 0 0 0 12 2a10 10 0 0 0-7 17.09A9.93 9.93 0 0 0 12 22a10 10 0 0 0 10-10 1 1 0 0 0-1-1z"/>
            </g>
            </g>
            </svg>
          </button>
        {% endif %}
        {% if app.request.get('status') not in ['saved', 'applied', 'interview', 'negotiating', 'accepted'] %}
          <button id="apply-btn" class="action-btn" disabled title="Apply">
            <svg class="icon-image" fill="currentcolor" width="25" height="25" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <g data-name="Layer 2">
            <g data-name="checkmark-circle">
            <rect width="24" height="24" opacity="0"/>
            <path d="M9.71 11.29a1 1 0 0 0-1.42 1.42l3 3A1 1 0 0 0 12 16a1 1 0 0 0 .72-.34l7-8a1 1 0 0 0-1.5-1.32L12 13.54z"/>
            <path d="M21 11a1 1 0 0 0-1 1 8 8 0 0 1-8 8A8 8 0 0 1 6.33 6.36 7.93 7.93 0 0 1 12 4a8.79 8.79 0 0 1 1.9.22 a1 1 0 1 0 .47-1.94A10.54 10.54 0 0 0 12 2a10 10 0 0 0-7 17.09A9.93 9.93 0 0 0 12 22a10 10 0 0 0 10-10 1 1 0 0 0-1-1z"/>
            </g>
            </g>
            </svg>
          </button>
        {% endif %}
          <button id="email-btn" class="action-btn" title="Email">
            <svg class="icon-image" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g id="style=stroke">
            <g id="email">
            <path id="vector (Stroke)" fill-rule="evenodd" clip-rule="evenodd" d="M3.88534 5.2371C3.20538 5.86848 2.75 6.89295 2.75 8.5V15.5C2.75 17.107 3.20538 18.1315 3.88534 18.7629C4.57535 19.4036 5.61497 19.75 7 19.75H17C18.385 19.75 19.4246 19.4036 20.1147 18.7629C20.7946 18.1315 21.25 17.107 21.25 15.5V8.5C21.25 6.89295 20.7946 5.86848 20.1147 5.2371C19.4246 4.59637 18.385 4.25 17 4.25H7C5.61497 4.25 4.57535 4.59637 3.88534 5.2371ZM2.86466 4.1379C3.92465 3.15363 5.38503 2.75 7 2.75H17C18.615 2.75 20.0754 3.15363 21.1353 4.1379C22.2054 5.13152 22.75 6.60705 22.75 8.5V15.5C22.75 17.393 22.2054 18.8685 21.1353 19.8621C20.0754 20.8464 18.615 21.25 17 21.25H7C5.38503 21.25 3.92465 20.8464 2.86466 19.8621C1.79462 18.8685 1.25 17.393 1.25 15.5V8.5C1.25 6.60705 1.79462 5.13152 2.86466 4.1379Z" fill="currentColor"></path>
            <path id="vector (Stroke)_2" fill-rule="evenodd" clip-rule="evenodd" d="M19.3633 7.31026C19.6166 7.63802 19.5562 8.10904 19.2285 8.3623L13.6814 12.6486C12.691 13.4138 11.3089 13.4138 10.3185 12.6486L4.77144 8.3623C4.44367 8.10904 4.38328 7.63802 4.63655 7.31026C4.88982 6.98249 5.36083 6.9221 5.6886 7.17537L11.2356 11.4616C11.6858 11.8095 12.3141 11.8095 12.7642 11.4616L18.3113 7.17537C18.6391 6.9221 19.1101 6.98249 19.3633 7.31026Z" fill="currentcolor"></path>
            </g>
            </g>
            </svg>
          </button>
          <button id="delete-btn-bottom" class="action-btn" title="Delete">
            <svg class="icon-image" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9.17065 4C9.58249 2.83481 10.6937 2 11.9999 2C13.3062 2 14.4174 2.83481 14.8292 4" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M20.5 6H3.49988" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M18.3735 15.3991C18.1965 18.054 18.108 19.3815 17.243 20.1907C16.378 21 15.0476 21 12.3868 21H11.6134C8.9526 21 7.6222 21 6.75719 20.1907C5.89218 19.3815 5.80368 18.054 5.62669 15.3991L5.16675 8.5M18.8334 8.5L18.6334 11.5" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M9.5 11L10 16" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M14.5 11L14 16" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
          </button>
          <button id="archive-btn" class="action-btn" title="Archive">
            <svg class="icon-image" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 21L12 12M12 12L15 15.3333M12 12L9 15.3333" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M20.5 7V13C20.5 16.7712 20.5 18.6569 19.3284 19.8284C18.1569 21 16.2712 21 12.5 21H11.5C7.72876 21 5.84315 21 4.67157 19.8284C3.5 18.6569 3.5 16.7712 3.5 13V7" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M2 5C2 4.05719 2 3.58579 2.29289 3.29289C2.58579 3 3.05719 3 4 3H20C20.9428 3 21.4142 3 21.7071 3.29289C22 3.58579 22 4.05719 22 5C22 5.94281 22 6.41421 21.7071 6.70711C21.4142 7 20.9428 7 20 7H4C3.05719 7 2.58579 7 2.29289 6.70711C2 6.41421 2 5.94281 2 5Z" stroke="currentcolor" stroke-width="1.5"/>
            </svg>
          </button>
        </div>
    </div>
</div>

    <!-- Send Contract Modal -->
    <div class="modal fade" id="contractModal" tabindex="-1" role="dialog" aria-labelledby="contractModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contractModalLabel">Send Contract</h5>
                </div>
                <form method="post" action="" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="form-group">
                            <input type="file" name="contractFile" required />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Send</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Communication Template Modals -->
    <div id="email-modal-overlay" class="email-modal-overlay" style="display:none;"></div>

    <div id="template-request-modal" class="email-modal template-modal" aria-hidden="true" style="display:none;">
      <div class="email-modal-header">
        <h5>Email Template: Request Response</h5>
        <button type="button" class="email-modal-close" data-close>&times;</button>
      </div>
      <div class="email-modal-body">
        <label for="template-request-subject">Subject</label>
        <input id="template-request-subject" type="text" readonly>
        <label for="template-request-message">Message</label>
        <textarea id="template-request-message" readonly></textarea>
      </div>
      <div class="email-modal-footer">
        <button class="dropdown-cstm" data-copy-subject="#template-request-subject">Copy Subject</button>
        <button class="dropdown-cstm" data-copy-message="#template-request-message">Copy Message</button>
        <button class="action-btn" data-open-gmail data-sub="#template-request-subject" data-body="#template-request-message">Open in Gmail</button>
      </div>
    </div>

    <div id="template-thank-modal" class="email-modal template-modal" aria-hidden="true" style="display:none;">
      <div class="email-modal-header">
        <h5>Email Template: Send Thank You</h5>
        <button type="button" class="email-modal-close" data-close>&times;</button>
      </div>
      <div class="email-modal-body">
        <label for="template-thank-subject">Subject</label>
        <input id="template-thank-subject" type="text" readonly>
        <label for="template-thank-message">Message</label>
        <textarea id="template-thank-message" readonly></textarea>
      </div>
      <div class="email-modal-footer">
        <button class="dropdown-cstm" data-copy-subject="#template-thank-subject">Copy Subject</button>
        <button class="dropdown-cstm" data-copy-message="#template-thank-message">Copy Message</button>
        <button class="action-btn" data-open-gmail data-sub="#template-thank-subject" data-body="#template-thank-message">Open in Gmail</button>
      </div>
    </div>

    <div id="template-follow-modal" class="email-modal template-modal" aria-hidden="true" style="display:none;">
      <div class="email-modal-header">
        <h5>Email Template: Follow Up Note</h5>
        <button type="button" class="email-modal-close" data-close>&times;</button>
      </div>
      <div class="email-modal-body">
        <label for="template-follow-subject">Subject</label>
        <input id="template-follow-subject" type="text" readonly>
        <label for="template-follow-message">Message</label>
        <textarea id="template-follow-message" readonly></textarea>
      </div>
      <div class="email-modal-footer">
        <button class="dropdown-cstm" data-copy-subject="#template-follow-subject">Copy Subject</button>
        <button class="dropdown-cstm" data-copy-message="#template-follow-message">Copy Message</button>
        <button class="action-btn" data-open-gmail data-sub="#template-follow-subject" data-body="#template-follow-message">Open in Gmail</button>
      </div>
    </div>

    <div id="template-details-modal" class="email-modal template-modal" aria-hidden="true" style="display:none;">
      <div class="email-modal-header">
        <h5>Email Template: Ask for Details</h5>
        <button type="button" class="email-modal-close" data-close>&times;</button>
      </div>
      <div class="email-modal-body">
        <label for="template-details-subject">Subject</label>
        <input id="template-details-subject" type="text" readonly>
        <label for="template-details-message">Message</label>
        <textarea id="template-details-message" readonly></textarea>
      </div>
      <div class="email-modal-footer">
        <button class="dropdown-cstm" data-copy-subject="#template-details-subject">Copy Subject</button>
        <button class="dropdown-cstm" data-copy-message="#template-details-message">Copy Message</button>
        <button class="action-btn" data-open-gmail data-sub="#template-details-subject" data-body="#template-details-message">Open in Gmail</button>
      </div>
    </div>

    <div id="template-review-modal" class="email-modal template-modal" aria-hidden="true" style="display:none;">
      <div class="email-modal-header">
        <h5>Email Template: Write Review</h5>
        <button type="button" class="email-modal-close" data-close>&times;</button>
      </div>
      <div class="email-modal-body">
        <label for="template-review-subject">Subject</label>
        <input id="template-review-subject" type="text" readonly>
        <label for="template-review-message">Message</label>
        <textarea id="template-review-message" readonly></textarea>
      </div>
      <div class="email-modal-footer">
        <button class="dropdown-cstm" data-copy-subject="#template-review-subject">Copy Subject</button>
        <button class="dropdown-cstm" data-copy-message="#template-review-message">Copy Message</button>
        <button class="action-btn" data-open-gmail data-sub="#template-review-subject" data-body="#template-review-message">Open in Gmail</button>
      </div>
    </div>

    <style>
    .email-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.3);
      z-index: 999;
    }
    .email-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: min(600px, 90vw);
      max-height: 85vh;
      background: #fff;
      border: 1px solid #e6eef6;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(11,22,40,0.15);
      display: flex;
      flex-direction: column;
      z-index: 1000;
      overflow-y: auto;
    }
    .email-modal-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 12px 14px; 
      border-bottom: 1px solid #e6eef6; 
    }
    .email-modal-body { 
      padding: 14px; 
      display: flex; 
      flex-direction: column; 
      gap: 8px; 
    }
    .email-modal-body label {
      font-size: 13px;
      font-weight: 500;
      color: #121C0C;
    }
    .email-modal-body input, 
    .email-modal-body textarea {
      width: 100%; 
      border: 1px solid #e6eef6; 
      border-radius: 8px; 
      padding: 10px; 
      outline: none;
      font-size: 13px;
    }
    .email-modal-body textarea { 
      min-height: 180px; 
      resize: vertical; 
    }
    .email-modal-footer { 
      display: flex; 
      gap: 8px; 
      padding: 12px 14px; 
      border-top: 1px solid #e6eef6; 
    }
    .email-modal-close { 
      background: transparent; 
      border: none; 
      font-size: 22px; 
      cursor: pointer; 
      color: #666; 
    }
    </style>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
      const overlay = document.getElementById('email-modal-overlay');
      const modals = document.querySelectorAll('.template-modal');

      const templateConfig = {
        request: {
          subject: (jobTitle) => `Quick check-in on ${jobTitle}`,
          message: (jobTitle, company) => `Hi there,\n\nI hope you're doing well. I'm reaching out to check in on the ${jobTitle} opportunity with ${company}. I'm still very interested and would be happy to provide any additional information you might need from me.\n\nThanks so much for your time!\n\nBest,\n[YOUR NAME]`
        },
        thank: {
          subject: (jobTitle) => `Thank you for the ${jobTitle} conversation`,
          message: (jobTitle, company) => `Hi there,\n\nThank you again for the time you spent discussing the ${jobTitle} position at ${company}. I appreciated the conversation and learning more about the team.\n\nIf there's anything else you need from me, please let me knowI'm excited about the opportunity.\n\nWarm regards,\n[YOUR NAME]`
        },
        follow: {
          subject: (jobTitle) => `Following up on ${jobTitle}`,
          message: (jobTitle, company) => `Hi there,\n\nI wanted to follow up regarding the ${jobTitle} role with ${company}. I'm still very enthusiastic about the opportunity and happy to share any additional information that would be helpful.\n\nThanks again for your time and consideration.\n\nBest,\n[YOUR NAME]`
        },
        details: {
          subject: (jobTitle) => `Request for additional details about ${jobTitle}`,
          message: (jobTitle, company) => `Hi there,\n\nThanks for the update on the ${jobTitle} role at ${company}. Could you share any additional details or next steps so I can prepare accordingly?\n\nI appreciate the guidance and look forward to hearing from you.\n\nBest regards,\n[YOUR NAME]`
        },
        review: {
          subject: (jobTitle) => `Feedback on the ${jobTitle} process`,
          message: (jobTitle, company) => `Hi there,\n\nI wanted to share feedback on the recent ${jobTitle} process with ${company}. Below are a few notes that might be helpful. Please feel free to edit or add your own comments.\n\n[Add your review or feedback here]\n\nThank you for the experience!\n\nBest,\n[YOUR NAME]`
        }
      };

      function getJobContext() {
        let jobTitle = 'this opportunity';
        let company = 'your team';

        const detailTitle = document.querySelector('#job-detail-content .job-detail-title');
        const detailCompany = document.querySelector('#job-detail-content .job-detail-company');

        if (detailTitle && detailTitle.textContent.trim()) {
          jobTitle = detailTitle.textContent.trim();
        }
        if (detailCompany && detailCompany.textContent.trim()) {
          company = detailCompany.textContent.trim();
        }

        const selectedCheckbox = document.querySelector('.job-checkbox:checked');
        if (selectedCheckbox) {
          const row = selectedCheckbox.closest('.job-row');
          const rowTitle = row?.querySelector('.job-title');
          const rowCompany = row?.querySelector('.job-company-name');
          if (rowTitle && rowTitle.textContent.trim()) {
            jobTitle = rowTitle.textContent.trim();
          }
          if (rowCompany && rowCompany.textContent.trim()) {
            company = rowCompany.textContent.trim();
          }
        }

        return { jobTitle, company };
      }

      function closeAllTemplateModals() {
        modals.forEach(modal => {
          modal.style.display = 'none';
          modal.setAttribute('aria-hidden', 'true');
        });
        if (overlay) overlay.style.display = 'none';
      }

      function openTemplateModal(type) {
        const config = templateConfig[type];
        if (!config) return;

        const modal = document.getElementById(`template-${type}-modal`);
        if (!modal) return;

        const subjectEl = document.getElementById(`template-${type}-subject`);
        const messageEl = document.getElementById(`template-${type}-message`);

        const { jobTitle, company } = getJobContext();
        if (subjectEl) subjectEl.value = config.subject(jobTitle, company);
        if (messageEl) messageEl.value = config.message(jobTitle, company);

        modals.forEach(m => {
          m.style.display = 'none';
          m.setAttribute('aria-hidden', 'true');
        });

        if (overlay) overlay.style.display = 'block';
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden', 'false');
        
        // Reset modal position to center
        modal.style.top = '50%';
        modal.style.left = '50%';
        modal.style.right = 'auto';
        modal.style.bottom = 'auto';
        modal.style.transform = 'translate(-50%, -50%)';
        
        // Ensure modal is visible in viewport - scroll into view smoothly
        setTimeout(() => {
          modal.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
          
          // After scrolling, check if modal needs position adjustment
          setTimeout(() => {
            const rect = modal.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;
            const padding = 20;
            
            // Adjust vertical position if needed
            if (rect.top < padding) {
              modal.style.top = padding + 'px';
              modal.style.transform = 'translate(-50%, 0)';
            } else if (rect.bottom > viewportHeight - padding) {
              modal.style.top = 'auto';
              modal.style.bottom = padding + 'px';
              modal.style.transform = 'translate(-50%, 0)';
            }
            
            // Adjust horizontal position if needed
            if (rect.left < padding) {
              modal.style.left = padding + 'px';
              modal.style.transform = modal.style.transform.replace('translate(-50%', 'translate(0');
            } else if (rect.right > viewportWidth - padding) {
              modal.style.right = padding + 'px';
              modal.style.left = 'auto';
              modal.style.transform = modal.style.transform.replace('translate(-50%', 'translate(0');
            }
          }, 300); // Wait for scroll animation to complete
        }, 10);
      }

      if (overlay) {
        overlay.addEventListener('click', closeAllTemplateModals);
      }

      document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
          closeAllTemplateModals();
        }
      });

      // Close handlers - use data-close attribute
      document.querySelectorAll('.email-modal [data-close]').forEach(btn => {
        btn.addEventListener('click', closeAllTemplateModals);
      });

      const triggerMap = {
        'request-response-btn': 'request',
        'say-thank-you-btn': 'thank',
        'follow-up-btn': 'follow',
        'ask-details-btn': 'details',
        'write-review-btn': 'review'
      };

      Object.entries(triggerMap).forEach(([btnId, type]) => {
        const btn = document.getElementById(btnId);
        if (btn) {
          btn.addEventListener('click', function (event) {
            event.preventDefault();
            event.stopPropagation();
            openTemplateModal(type);
          });
        }
      });

      // Copy handlers - use data-copy-subject and data-copy-message
      document.querySelectorAll('[data-copy-subject]').forEach(btn => {
        btn.addEventListener('click', () => {
          const sel = btn.getAttribute('data-copy-subject');
          const input = document.querySelector(sel);
          if (!input) return;
          navigator.clipboard.writeText(input.value || '').then(() => {
            if (typeof showToast === 'function') {
              showToast('Subject copied', 'success');
            }
          }).catch(() => {});
        });
      });
      
      document.querySelectorAll('[data-copy-message]').forEach(btn => {
        btn.addEventListener('click', () => {
          const sel = btn.getAttribute('data-copy-message');
          const input = document.querySelector(sel);
          if (!input) return;
          navigator.clipboard.writeText(input.value || '').then(() => {
            if (typeof showToast === 'function') {
              showToast('Message copied', 'success');
            }
          }).catch(() => {});
        });
      });

      // Open in Gmail handlers
      document.querySelectorAll('[data-open-gmail]').forEach(btn => {
        btn.addEventListener('click', () => {
          const subSel = btn.getAttribute('data-sub');
          const bodySel = btn.getAttribute('data-body');
          const subEl = document.querySelector(subSel);
          const bodyEl = document.querySelector(bodySel);
          const su = encodeURIComponent(subEl ? subEl.value : '');
          const body = encodeURIComponent(bodyEl ? bodyEl.value : '');
          const url = `https://mail.google.com/mail/?view=cm&fs=1&su=${su}&body=${body}`;
          window.open(url, '_blank');
        });
      });
    });
    </script>

    <!-- Notify Hire JavaScript -->
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const saveBtn = document.getElementById('save-btn');
        const saveBtnBottom = document.getElementById('save-btn-bottom');
        const applyBtn = document.getElementById('apply-btn');
        
        if (saveBtn) {
            saveBtn.addEventListener('click', handleNotifyHireFromApplications);
        }
        
        if (saveBtnBottom) {
            saveBtnBottom.addEventListener('click', handleNotifyHireFromApplications);
        }
        
        // Show/hide buttons based on selection
        function updateActionButtons() {
            const selectedCheckboxes = Array.from(document.querySelectorAll('.job-checkbox:checked'));
            const hasSelection = selectedCheckboxes.length > 0;
            
            if (applyBtn) {
                applyBtn.disabled = !hasSelection;
            }
            
            // Show/hide notify of hire button
            if (saveBtn) {
                if (hasSelection) {
                    saveBtn.style.display = 'flex';
                    saveBtn.disabled = false;
                } else {
                    saveBtn.style.display = 'none';
                    saveBtn.disabled = true;
                }
            }
            
            if (saveBtnBottom) {
                if (hasSelection) {
                    saveBtnBottom.style.display = 'flex';
                    saveBtnBottom.disabled = false;
                } else {
                    saveBtnBottom.style.display = 'none';
                    saveBtnBottom.disabled = true;
                }
            }
            
            // Update tooltips
            if (hasSelection) {
                if (saveBtn) saveBtn.title = "Notify Hire for Selected Jobs";
                if (saveBtnBottom) saveBtnBottom.title = "Notify Hire for Selected Jobs";
                if (applyBtn) applyBtn.title = "Apply to selected jobs";
            } else {
                if (saveBtn) saveBtn.title = "Notify of Hire";
                if (saveBtnBottom) saveBtnBottom.title = "Notify of Hire";
                if (applyBtn) applyBtn.title = "Apply";
            }
        }
        
        // Update buttons when checkboxes change
        document.querySelectorAll('.job-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateActionButtons);
        });
        
        // Initial update
        updateActionButtons();
    });

    function handleNotifyHireFromApplications() {
        const selectedCheckboxes = Array.from(document.querySelectorAll('.job-checkbox:checked'));
        
        if (selectedCheckboxes.length === 0) {
            showToast('Please select at least one job to notify hire.', 'warning');
            return;
        }
        
        const selectedJobIds = selectedCheckboxes.map(cb => cb.dataset.jobId);
        
        // Show confirmation modal
        showNotifyHireModal(selectedJobIds);
    }

    function showNotifyHireModal(jobIds) {
        const modalHtml = `
            <div class="modal fade" id="notifyHireModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Notify Hire for Selected Jobs</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p>This action will:</p>
                            <ul>
                                <li>Mark providers as hired for jobs you've applied to</li>
                                <li>Move successfully processed jobs to "Accepted" status</li>
                                <li>Notify the admin about the hire</li>
                            </ul>
                            <div class="alert alert-warning">
                                <strong>Note:</strong> Only jobs you have already applied to can be processed. 
                                Jobs without applications will be skipped.
                            </div>
                            <p>Are you sure you want to proceed?</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-success" id="confirm-notify-hire-btn">
                                Yes, Notify Hire
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('notifyHireModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to DOM
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        const modal = new bootstrap.Modal(document.getElementById('notifyHireModal'));
        modal.show();
        
        // Handle confirm button
        document.getElementById('confirm-notify-hire-btn').addEventListener('click', function() {
            modal.hide();
            processNotifyHire(jobIds);
        });
    }

    function processNotifyHire(jobIds) {
        // Show loading state
        const saveBtn = document.getElementById('save-btn');
        const saveBtnBottom = document.getElementById('save-btn-bottom');
        const originalHtml = saveBtn ? saveBtn.innerHTML : '';
        
        if (saveBtn) {
            saveBtn.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Processing...';
            saveBtn.disabled = true;
        }
        if (saveBtnBottom) {
            saveBtnBottom.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
            saveBtnBottom.disabled = true;
        }
        
        fetch('{{ path("app_provider_saved_jobs_notify_hire") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ jobIds: jobIds })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showResultsModal(data.results);
                // Remove successful jobs from the UI
                removeSuccessfulJobsFromUI(data.results.successful);
                // Uncheck all checkboxes
                uncheckAllCheckboxes();
            } else {
                showToast('Error: ' + (data.message || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Network error. Please try again.', 'error');
        })
        .finally(() => {
            // Reset button
            if (saveBtn) {
                saveBtn.innerHTML = originalHtml;
                saveBtn.disabled = false;
            }
            if (saveBtnBottom) {
                saveBtnBottom.innerHTML = '<svg class="icon-image" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 10.5V12C22 16.714 22 19.0711 20.5355 20.5355C19.0711 22 16.714 22 12 22C7.28595 22 4.92893 22 3.46447 20.5355C2 19.0711 2 16.714 2 12C2 7.28595 2 4.92893 3.46447 3.46447C4.92893 2 7.28595 2 12 2H13.5" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/><circle cx="19" cy="5" r="3" stroke="#1C274C" stroke-width="1.5"/><path d="M7 14H16" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/><path d="M7 17.5H13" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/></svg>';
                saveBtnBottom.disabled = false;
            }
        });
    }

    function showResultsModal(results) {
        const successfulCount = results.successful ? results.successful.length : 0;
        const notAppliedCount = results.notApplied ? results.notApplied.length : 0;
        const failedCount = results.failed ? results.failed.length : 0;
        
        let resultsHtml = `
            <div class="modal fade" id="resultsModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Hire Notification Results</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
    `;
        
        // Successful results
        if (successfulCount > 0) {
            resultsHtml += `
                <div class="alert alert-success">
                    <h6> Successfully Hired (${successfulCount})</h6>
                    <small>The following jobs have been moved to "Accepted" status:</small>
                    <ul class="mb-0 mt-2">
            `;
            results.successful.forEach(job => {
                resultsHtml += `<li>${job.jobTitle || job.title || 'Job #' + job.jobId}</li>`;
            });
            resultsHtml += `</ul></div>`;
        }
        
        // Not applied jobs
        if (notAppliedCount > 0) {
            resultsHtml += `
                <div class="alert alert-warning">
                    <h6> Not Applied (${notAppliedCount})</h6>
                    <small>These jobs need to be applied to first:</small>
                    <ul class="mb-0 mt-2">
            `;
            results.notApplied.forEach(job => {
                resultsHtml += `<li>${job.jobTitle || job.title || 'Job #' + job.jobId}</li>`;
            });
            resultsHtml += `</ul></div>`;
        }
        
        // Failed jobs
        if (failedCount > 0) {
            resultsHtml += `
                <div class="alert alert-danger">
                    <h6> Failed (${failedCount})</h6>
                    <small>These jobs could not be processed:</small>
                    <ul class="mb-0 mt-2">
            `;
            results.failed.forEach(job => {
                resultsHtml += `<li>${job.jobTitle || job.title || 'Job #' + job.jobId} - ${job.reason || 'Unknown error'}</li>`;
            });
            resultsHtml += `</ul></div>`;
        }
        
        resultsHtml += `
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Continue</button>
                            ${notAppliedCount > 0 ? 
                                '<button type="button" class="btn btn-success" id="apply-remaining-btn">Apply to Remaining Jobs</button>' : 
                                ''
                            }
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('resultsModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to DOM
        document.body.insertAdjacentHTML('beforeend', resultsHtml);
        
        const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
        modal.show();
        
        // Handle apply remaining button
        if (notAppliedCount > 0) {
            document.getElementById('apply-remaining-btn').addEventListener('click', function() {
                modal.hide();
                // Apply to the not applied jobs
                const notAppliedJobIds = results.notApplied.map(job => job.jobId);
                applyToSelectedJobs(notAppliedJobIds);
            });
        }
    }

    function removeSuccessfulJobsFromUI(successfulJobs) {
        successfulJobs.forEach(job => {
            // Remove from list view
            const jobRow = document.querySelector(`.job-checkbox[data-job-id="${job.jobId}"]`)?.closest('.job-lists');
            if (jobRow) {
                jobRow.remove();
            }
        });
        
        // Refresh page to update counters and status
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    }

    function uncheckAllCheckboxes() {
        const checkboxes = document.querySelectorAll('.job-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        // Trigger change event on first checkbox to update buttons
        if (checkboxes.length > 0) {
            checkboxes[0].dispatchEvent(new Event('change', { bubbles: true }));
        }
    }

    function applyToSelectedJobs(jobIds) {
        if (!jobIds || jobIds.length === 0) {
            showToast('No jobs to apply to.', 'warning');
            return;
        }
        
        // Show loading state
        const applyBtn = document.getElementById('apply-btn');
        const applyBtnBottom = document.getElementById('apply-btn-bottom');
        const originalHtml = applyBtn ? applyBtn.innerHTML : '';
        
        if (applyBtn) {
            applyBtn.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Applying...';
            applyBtn.disabled = true;
        }
        if (applyBtnBottom) {
            applyBtnBottom.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
            applyBtnBottom.disabled = true;
        }
        
        // Apply to each job
        const applyPromises = jobIds.map(jobId => {
            return applyToJob(jobId);
        });
        
        // Execute all apply operations
        Promise.allSettled(applyPromises).then(results => {
            const successful = results.filter(r => r.status === 'fulfilled').length;
            const failed = results.filter(r => r.status === 'rejected').length;
            
            // Reset button
            if (applyBtn) {
                applyBtn.innerHTML = originalHtml;
                applyBtn.disabled = false;
            }
            if (applyBtnBottom) {
                applyBtnBottom.innerHTML = '<svg class="icon-image" fill="currentcolor" width="25" height="25" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g data-name="Layer 2"><g data-name="checkmark-circle"><rect width="24" height="24" opacity="0"/><path d="M9.71 11.29a1 1 0 0 0-1.42 1.42l3 3A1 1 0 0 0 12 16a1 1 0 0 0 .72-.34l7-8a1 1 0 0 0-1.5-1.32L12 13.54z"/><path d="M21 11a1 1 0 0 0-1 1 8 8 0 0 1-8 8A8 8 0 0 1 6.33 6.36 7.93 7.93 0 0 1 12 4a8.79 8.79 0 0 1 1.9.22 a1 1 0 1 0 .47-1.94A10.54 10.54 0 0 0 12 2a10 10 0 0 0-7 17.09A9.93 9.93 0 0 0 12 22a10 10 0 0 0 10-10 1 1 0 0 0-1-1z"/></g></g></svg>';
                applyBtnBottom.disabled = false;
            }
            
            // Show results
            if (failed === 0) {
                showToast(`Successfully applied to ${successful} job(s)!`, 'success');
            } else {
                showToast(`Applied to ${successful} job(s), ${failed} failed.`, 'warning');
            }
            
            // Refresh the page to update the UI
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        });
    }

    function applyToJob(jobId) {
        return new Promise((resolve, reject) => {
            fetch(`/provider/jobs/apply/${jobId}?redirect_route=app_provider_jobs_applications`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.ok) {
                    resolve();
                } else {
                    reject(new Error('Apply failed'));
                }
            })
            .catch(error => reject(error));
        });
    }

    // Toast notification function (if not already defined)
    if (typeof showToast === 'undefined') {
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container') || createToastContainer();
            
            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'success' ? 'text-bg-success' : 
                           type === 'error' ? 'text-bg-danger' : 
                           type === 'warning' ? 'text-bg-warning' : 'text-bg-info';
            
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center ${bgClass} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Remove toast from DOM after it hides
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }
        
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
            return container;
        }
    }
    </script>
{% endblock %}

{% block footer_scripts %}
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function() {
            $('#contractModal').on('show.bs.modal', function(event) {
                var button = $(event.relatedTarget); // Button that triggered the modal
                var applicationId = button.data('application_id'); // Get application ID
                var form = $(this).find('form'); // Find the form inside the modal
                var actionUrl = "{{ path('app_provider_application_sendcontract', {'id': 'APPLICATION_ID'}) }}".replace('APPLICATION_ID', applicationId);
                form.attr('action', actionUrl); // Set the form action
            });
            
            // Ensure job-section, application, and actions-container are not fixed or sticky
            function removeFixedPositioning() {
                const jobSection = document.querySelector('.job-section');
                const application = document.querySelector('.application');
                const actionsContainer = document.querySelector('.actions-container');
                
                [jobSection, application, actionsContainer].forEach(element => {
                    if (element) {
                        // Don't modify if it contains filter panel or dropdowns
                        const hasDropdowns = element.querySelector('.filter-panel, .custom-dropdown, .columns-panel, .menu-panel');
                        if (hasDropdowns) {
                            // Only modify the container itself, not children with dropdowns
                            element.style.setProperty('position', 'relative', 'important');
                            element.style.setProperty('top', 'auto', 'important');
                            element.style.setProperty('bottom', 'auto', 'important');
                            element.style.setProperty('left', 'auto', 'important');
                            element.style.setProperty('right', 'auto', 'important');
                            element.style.setProperty('transform', 'none', 'important');
                            // Don't set z-index to auto - keep it for dropdowns
                            
                            // Remove sticky class
                            element.classList.remove('application-sticky');
                            return; // Skip parent checking for containers with dropdowns
                        }
                        
                        // Force remove any positioning
                        element.style.setProperty('position', 'relative', 'important');
                        element.style.setProperty('top', 'auto', 'important');
                        element.style.setProperty('bottom', 'auto', 'important');
                        element.style.setProperty('left', 'auto', 'important');
                        element.style.setProperty('right', 'auto', 'important');
                        element.style.setProperty('transform', 'none', 'important');
                        element.style.setProperty('z-index', 'auto', 'important');
                        
                        // Remove sticky class
                        element.classList.remove('application-sticky');
                        
                        // Also check parent elements - but skip if they contain dropdowns
                        let parent = element.parentElement;
                        while (parent && parent !== document.body) {
                            if (parent.classList.contains('application-sticky')) {
                                parent.classList.remove('application-sticky');
                                parent.style.setProperty('position', 'relative', 'important');
                                parent.style.setProperty('top', 'auto', 'important');
                            }
                            parent = parent.parentElement;
                        }
                    }
                });
            }
            
            // Get elements for observer
            const jobSection = document.querySelector('.job-section');
            const application = document.querySelector('.application');
            const actionsContainer = document.querySelector('.actions-container');
            
            // Run immediately
            removeFixedPositioning();
            
            // Run on window load
            window.addEventListener('load', removeFixedPositioning);
            
            // Run after a short delay to catch any dynamically added styles
            setTimeout(removeFixedPositioning, 100);
            setTimeout(removeFixedPositioning, 500);
            setTimeout(removeFixedPositioning, 1000);
            
            // Continuously check and fix positioning (run every 200ms for first 3 seconds)
            let checkCount = 0;
            const intervalId = setInterval(function() {
                removeFixedPositioning();
                checkCount++;
                if (checkCount >= 15) { // Stop after 3 seconds (15 * 200ms)
                    clearInterval(intervalId);
                }
            }, 200);
            
            // Watch for any style changes and remove fixed/sticky positioning
            // Use throttling to prevent excessive calls
            let observerTimeout = null;
            const throttledRemoveFixed = function() {
                if (observerTimeout) return;
                observerTimeout = setTimeout(function() {
                    removeFixedPositioning();
                    observerTimeout = null;
                }, 100); // Throttle to max once per 100ms
            };
            
            const observer = new MutationObserver(function(mutations) {
                let shouldUpdate = false;
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && (mutation.attributeName === 'style' || mutation.attributeName === 'class')) {
                        const target = mutation.target;
                        if (target.classList && (target.classList.contains('job-section') || 
                            target.classList.contains('application') || 
                            target.classList.contains('actions-container') ||
                            target.classList.contains('application-sticky'))) {
                            shouldUpdate = true;
                        }
                    }
                });
                if (shouldUpdate) {
                    throttledRemoveFixed();
                }
            });
            
            // Observe ONLY the specific elements (not the entire body!)
            [jobSection, application, actionsContainer].forEach(element => {
                if (element) {
                    observer.observe(element, {
                        attributes: true,
                        attributeFilter: ['style', 'class'],
                        subtree: false // Only watch direct children, not entire subtree
                    });
                }
            });
        });
    </script>
    <script>
  document.addEventListener('DOMContentLoaded', function () {
    const checkboxes = document.querySelectorAll('.job-checkbox');
    const applyBtn = document.getElementById('apply-btn');
    const saveBtn = document.getElementById('save-btn');
    const deleteBtn = document.getElementById('delete-btn');
    const columnsBtn = document.querySelector('.columns-dropdown-btn');
    const menuBtn = document.querySelector('.menu-dropdown-btn');
    const columnsPanel = document.querySelector('.columns-panel');
    const menuPanel = document.querySelector('.menu-panel');
    const emailBtn = document.getElementById('email-btn');

    // Link email button to email template modal
    if (emailBtn) {
      emailBtn.addEventListener('click', () => {
        const overlay = document.getElementById('email-modal-overlay');
        const modal = document.getElementById('template-request-modal');
        if (overlay && modal) {
          // Get job context from selected checkbox or job details
          const selectedCheckbox = document.querySelector('.job-checkbox:checked');
          let jobTitle = 'this opportunity';
          let company = 'your team';
          
          if (selectedCheckbox) {
            const row = selectedCheckbox.closest('.job-row');
            const rowTitle = row?.querySelector('.job-title');
            const rowCompany = row?.querySelector('.job-company-name');
            if (rowTitle && rowTitle.textContent.trim()) {
              jobTitle = rowTitle.textContent.trim();
            }
            if (rowCompany && rowCompany.textContent.trim()) {
              company = rowCompany.textContent.trim();
            }
          }
          
          // Populate the template
          const subjectEl = document.getElementById('template-request-subject');
          const messageEl = document.getElementById('template-request-message');
          if (subjectEl && messageEl) {
            subjectEl.value = `Quick check-in on ${jobTitle}`;
            messageEl.value = `Hi there,\n\nI hope you're doing well. I'm reaching out to check in on the ${jobTitle} opportunity with ${company}. I'm still very interested and would be happy to provide any additional information you might need from me.\n\nThanks so much for your time!\n\nBest,\n[YOUR NAME]`;
          }
          
          overlay.style.display = 'block';
          modal.style.display = 'flex';
          modal.setAttribute('aria-hidden', 'false');
          
          // Reset modal position to center
          modal.style.top = '50%';
          modal.style.left = '50%';
          modal.style.right = 'auto';
          modal.style.bottom = 'auto';
          modal.style.transform = 'translate(-50%, -50%)';
          
          // Ensure modal is visible in viewport - scroll into view smoothly
          setTimeout(() => {
            modal.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
            
            // After scrolling, check if modal needs position adjustment
            setTimeout(() => {
              const rect = modal.getBoundingClientRect();
              const viewportHeight = window.innerHeight;
              const viewportWidth = window.innerWidth;
              const padding = 20;
              
              // Adjust vertical position if needed
              if (rect.top < padding) {
                modal.style.top = padding + 'px';
                modal.style.transform = 'translate(-50%, 0)';
              } else if (rect.bottom > viewportHeight - padding) {
                modal.style.top = 'auto';
                modal.style.bottom = padding + 'px';
                modal.style.transform = 'translate(-50%, 0)';
              }
              
              // Adjust horizontal position if needed
              if (rect.left < padding) {
                modal.style.left = padding + 'px';
                modal.style.transform = modal.style.transform.replace('translate(-50%', 'translate(0');
              } else if (rect.right > viewportWidth - padding) {
                modal.style.right = padding + 'px';
                modal.style.left = 'auto';
                modal.style.transform = modal.style.transform.replace('translate(-50%', 'translate(0');
              }
            }, 300); // Wait for scroll animation to complete
          }, 10);
        }
      });
    }

    function toggleDropdown(panel, btn) {
        if (!panel || !btn) return;
        const isOpen = !panel.classList.contains('hidden');
        closeAllDropdowns();
        if (!isOpen) panel.classList.remove('hidden');
    }

    function closeAllDropdowns() {
        if (columnsPanel) columnsPanel.classList.add('hidden');
        if (menuPanel) menuPanel.classList.add('hidden');
    }

    if (columnsBtn && columnsPanel) {
    columnsBtn.addEventListener('click', e => {
        e.stopPropagation();
        toggleDropdown(columnsPanel, columnsBtn);
    });
    }

    if (menuBtn && menuPanel) {
    menuBtn.addEventListener('click', e => {
        e.stopPropagation();
        toggleDropdown(menuPanel, menuBtn);
    });
    }

    document.addEventListener('click', e => {
        // Only close if click is outside both dropdowns and buttons
        if (
          (!columnsPanel || !columnsPanel.contains(e.target)) &&
          (!columnsBtn || !columnsBtn.contains(e.target)) &&
          (!menuPanel || !menuPanel.contains(e.target)) &&
          (!menuBtn || !menuBtn.contains(e.target))
        ) {
          closeAllDropdowns();
        }
    });


    function toggleActionsVisibility() {
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      
      // Hide all conditional buttons first
      const requestResponseBtn = document.getElementById('request-response-btn');
      const sayThankYouBtn = document.getElementById('say-thank-you-btn');
      const followUpBtn = document.getElementById('follow-up-btn');
      const askDetailsBtn = document.getElementById('ask-details-btn');
      const writeReviewBtn = document.getElementById('write-review-btn');
      
      // Hide all conditional buttons by default
      if (requestResponseBtn) requestResponseBtn.style.display = 'none';
      if (sayThankYouBtn) sayThankYouBtn.style.display = 'none';
      if (followUpBtn) followUpBtn.style.display = 'none';
      if (askDetailsBtn) askDetailsBtn.style.display = 'none';
      if (writeReviewBtn) writeReviewBtn.style.display = 'none';
      
      // If exactly one job is selected, show the appropriate button based on status
      if (checkedCount === 1) {
        const checkedCheckbox = Array.from(checkboxes).find(cb => cb.checked);
        if (checkedCheckbox) {
          const status = checkedCheckbox.dataset.status ? checkedCheckbox.dataset.status.toLowerCase().replace(/\s+/g, '_') : '';
          
          // Show the appropriate button based on status
          // applied and in_review/in review show the same button (Request Response)
          if ((status === 'applied' || status === 'in_review') && requestResponseBtn) {
            requestResponseBtn.style.display = 'flex';
            requestResponseBtn.disabled = false;
          } else if (status === 'interview' && sayThankYouBtn) {
            sayThankYouBtn.style.display = 'flex';
            sayThankYouBtn.disabled = false;
          } else if (status === 'negotiating' && followUpBtn) {
            followUpBtn.style.display = 'flex';
            followUpBtn.disabled = false;
          } else if ((status === 'accepted' || status === 'hired') && askDetailsBtn) {
            askDetailsBtn.style.display = 'flex';
            askDetailsBtn.disabled = false;
          } else if (status === 'completed' && writeReviewBtn) {
            writeReviewBtn.style.display = 'flex';
            writeReviewBtn.disabled = false;
          }
        }
      }
      
      // Show/hide Note button (show when job details are viewed)
      const noteBtn = document.getElementById('note-btn');
      if (noteBtn) {
        const hasJobDetailsOpen = window.selectedJobId !== null && window.selectedJobId !== undefined;
        const activeCard = document.querySelector('.split-job-card.active');
        const hasActiveCard = activeCard !== null;
        const jobDetailContent = document.getElementById('job-detail-content');
        const hasJobDetailContent = jobDetailContent && jobDetailContent.style.display !== 'none' && jobDetailContent.innerHTML.trim() !== '';
        
        // Show ONLY when job details are actually being viewed
        noteBtn.style.display = (hasJobDetailsOpen || hasActiveCard || hasJobDetailContent) ? 'flex' : 'none';
      }
    }

    // Single-selection feature: prevent multiple checkboxes from being selected
    // Delegated change listener to catch any checkbox state changes reliably
    document.addEventListener('change', (e) => {
      const target = e.target;
      if (!target) return;
      if (target.classList && target.classList.contains('job-checkbox')) {
        // Enforce single selection
        if (target.checked) {
          // Get all checkboxes (including split view ones)
          const allCheckboxes = document.querySelectorAll('.job-checkbox');
          const otherChecked = Array.from(allCheckboxes).find(cb => cb !== target && cb.checked);
          if (otherChecked) {
            // Prevent this checkbox from being checked and show alert
            target.checked = false;
                   showWarningAlert('Multiple Selection', 'You cannot select multiple values');
            return;
          }
        }
        toggleActionsVisibility();
      }
    });

    // Initial check in case some boxes are pre-checked
    toggleActionsVisibility();

    function updateActions() {
      const checked = Array.from(checkboxes).filter(cb => cb.checked);
      const anyChecked = checked.length > 0;
      
      // Get all conditional buttons
      const requestResponseBtn = document.getElementById('request-response-btn');
      const sayThankYouBtn = document.getElementById('say-thank-you-btn');
      const followUpBtn = document.getElementById('follow-up-btn');
      const askDetailsBtn = document.getElementById('ask-details-btn');
      const writeReviewBtn = document.getElementById('write-review-btn');
      
      // If exactly one job is selected, enable the appropriate button based on status
      if (checked.length === 1) {
        const checkedCheckbox = checked[0];
        const status = checkedCheckbox.dataset.status ? checkedCheckbox.dataset.status.toLowerCase().replace(/\s+/g, '_') : '';
        
        // Enable the button that should be shown for this status
        // applied and in_review/in review show the same button (Request Response)
        // accepted and hired show the same button (Ask Details)
        if ((status === 'applied' || status === 'in_review') && requestResponseBtn) {
          requestResponseBtn.disabled = false;
        } else if (status === 'interview' && sayThankYouBtn) {
          sayThankYouBtn.disabled = false;
        } else if (status === 'negotiating' && followUpBtn) {
          followUpBtn.disabled = false;
        } else if ((status === 'accepted' || status === 'hired') && askDetailsBtn) {
          askDetailsBtn.disabled = false;
        } else if (status === 'completed' && writeReviewBtn) {
          writeReviewBtn.disabled = false;
        }
      } else {
        // Disable all conditional buttons if no selection or multiple selections
        if (requestResponseBtn) requestResponseBtn.disabled = true;
        if (sayThankYouBtn) sayThankYouBtn.disabled = true;
        if (followUpBtn) followUpBtn.disabled = true;
        if (askDetailsBtn) askDetailsBtn.disabled = true;
        if (writeReviewBtn) writeReviewBtn.disabled = true;
      }
      
      // Update applyBtn if it exists
      if (applyBtn) {
        applyBtn.disabled = checked.length === 0;
      }
    }

    checkboxes.forEach(cb => {
      cb.addEventListener('change', updateActions);
    });

    applyBtn && applyBtn.addEventListener('click', () => {
      const selected = Array.from(checkboxes).filter(cb => cb.checked);
      if (selected.length === 1) {
        const jobId = selected[0].dataset.jobId;
        // Trigger apply logic here
        console.log('Applying to job:', jobId);
      }
    });
    
    // Handle Note button click (for detail-note-btn in job details)
    function handleNoteClick() {
      let jobId = null;
      
      // First check if job details are open (split view or detail page)
      if (window.selectedJobId) {
        jobId = window.selectedJobId;
      } else {
        // Check for active card in split view
        const activeCard = document.querySelector('.split-job-card.active');
        if (activeCard) {
          jobId = activeCard.dataset.jobId;
        }
      }
      
      // Try to get job ID from the job detail content
      if (!jobId) {
        const jobDetailContent = document.querySelector('.job-detail-content');
        if (jobDetailContent) {
          // Try to extract job ID from data attribute or other means
          const jobIdAttr = jobDetailContent.getAttribute('data-job-id');
          if (jobIdAttr) {
            jobId = jobIdAttr;
          }
        }
      }
      
      // Fallback to checked checkbox
      if (!jobId) {
        const single = Array.from(document.querySelectorAll('.job-checkbox')).filter(cb => cb.checked);
        if (single.length === 1) {
          jobId = single[0].dataset.jobId;
        }
      }
      
      if (jobId) {
        // Open notes panel if it exists, otherwise just log
        if (typeof openNotesPanel === 'function') {
          openNotesPanel(jobId);
        } else {
          console.log('Opening notes for job:', jobId);
        }
      }
    }
    
    // Add event listener for detail-note-btn when job details are loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Use event delegation for dynamically loaded content
      document.addEventListener('click', function(e) {
        if (e.target.closest('#detail-note-btn')) {
          handleNoteClick();
        }
      });
    });

    saveBtn && saveBtn.addEventListener('click', () => {
      const selectedIds = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.dataset.jobId);
      // Trigger batch save logic here
      console.log('Saving jobs:', selectedIds);
    });

    deleteBtn && deleteBtn.addEventListener('click', () => {
      const selectedIds = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.dataset.jobId);
      // Trigger batch delete logic here
      console.log('Deleting jobs:', selectedIds);
    });
  });

// Function to show success/error message
function showMessage(message, type = 'success') {
    const messageId = type === 'success' ? 'success-message' : 'error-message';
    let messageEl = document.getElementById(messageId);
    
    if (!messageEl) {
        messageEl = document.createElement('div');
        messageEl.id = messageId;
        messageEl.className = type === 'success' ? 'success-message' : 'error-message';
        document.body.appendChild(messageEl);
    }
    
    messageEl.textContent = message;
    messageEl.style.display = 'block';
    
    setTimeout(() => {
        messageEl.style.display = 'none';
    }, 3000);
}

// Function to remove application from current view
function removeApplicationFromView(applicationId) {
    const applicationRow = document.querySelector(`.job-checkbox[data-application-id="${applicationId}"]`)?.closest('.job-lists');
    if (applicationRow) {
        applicationRow.remove();
    }
    
    // If no applications left, show "not found" message
    const remainingApplications = document.querySelectorAll('.job-lists .job-checkbox');
    const notFoundMessage = document.querySelector('.job-list-container p');
    if (remainingApplications.length === 0 && !notFoundMessage) {
        const jobListContainer = document.querySelector('.job-list-container');
        jobListContainer.innerHTML = '<p>Applications not found.</p>';
    }
}

// Function to update status counts
function updateStatusCounts() {
    // This would ideally make an AJAX call to get updated counts
    console.log('Status counts should be updated here');
}

// Handle Note button click
function handleNoteClick() {
    let jobId = null;
    
    if (window.selectedJobId) {
        jobId = window.selectedJobId;
    } else {
        const activeCard = document.querySelector('.split-job-card.active');
        if (activeCard) {
            jobId = activeCard.dataset.jobId;
        }
    }
    
    if (!jobId) {
        const jobDetailContent = document.querySelector('.job-detail-content');
        if (jobDetailContent) {
            const jobIdAttr = jobDetailContent.getAttribute('data-job-id');
            if (jobIdAttr) {
                jobId = jobIdAttr;
            }
        }
    }
    
    if (!jobId) {
        const single = Array.from(document.querySelectorAll('.job-checkbox')).filter(cb => cb.checked);
        if (single.length === 1) {
            jobId = single[0].dataset.applicationId;
        }
    }
    
    if (jobId) {
        if (typeof openNotesPanel === 'function') {
            openNotesPanel(jobId);
        } else {
            console.log('Opening notes for job:', jobId);
        }
    }
}

// Add event listener for detail-note-btn when job details are loaded
document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(e) {
        if (e.target.closest('#detail-note-btn')) {
            handleNoteClick();
        }
    });
});
</script>

<script>
// Make rank editing initialization reusable
function initializeRankEditing() {
    const rankDisplays = document.querySelectorAll('.rank-display');
    const rankInputs = document.querySelectorAll('.rank-input');

    function saveRank(input) {
        let value = parseFloat(input.value);
        const applicationId = input.dataset.applicationId;
        const wrapper = input.closest('.rank-input-wrapper');
        const display = wrapper ? wrapper.previousElementSibling : input.previousElementSibling;

        if (isNaN(value)) {
            showErrorAlert('Invalid Score', 'Score must be a number between 1 and 10.');
            input.value = input.dataset.originalValue || '';
            return;
        }

        // Clamp and round to nearest 0.5
        if (value < 1) value = 1;
        if (value > 10) value = 10;
        value = Math.round(value * 2) / 2;

        if (value === parseFloat(input.dataset.originalValue)) {
            if (wrapper) {
                wrapper.classList.add('hidden');
            } else {
            input.classList.add('hidden');
            }
            if (display) display.classList.remove('hidden');
            return;
        }

        // AJAX request
        fetch('{{ path("app_update_application_rank") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ applicationId, rank: value })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                if (display) {
                display.textContent = value;
                    display.classList.remove('hidden');
                }
                input.dataset.originalValue = value;
                if (wrapper) {
                    wrapper.classList.add('hidden');
                } else {
                input.classList.add('hidden');
                }
                // Show toast
                let msg = document.getElementById('rank-success-msg');
                if (!msg) {
                    msg = document.createElement('div');
                    msg.id = 'rank-success-msg';
                    msg.style.position = 'fixed';
                    msg.style.top = '20px';
                    msg.style.right = '20px';
                    msg.style.backgroundColor = '#4CAF50';
                    msg.style.color = 'white';
                    msg.style.padding = '10px 15px';
                    msg.style.borderRadius = '5px';
                    msg.style.zIndex = '9999';
                    document.body.appendChild(msg);
                }
                msg.textContent = 'Score updated successfully!';
                msg.style.display = 'block';
                if (msg.timeoutId) clearTimeout(msg.timeoutId);
                msg.timeoutId = setTimeout(() => { msg.style.display = 'none'; }, 2000);
            } else {
                showErrorAlert('Update Failed', 'Failed to update score: ' + (data.message || 'Unknown error'));
                input.value = input.dataset.originalValue || '';
            }
        })
        .catch(err => {
            console.error('Fetch error:', err);
            input.value = input.dataset.originalValue || '';
        });
    }

    // Initialize original values
    rankInputs.forEach(input => input.dataset.originalValue = input.value || '');

    // Click to edit
    rankDisplays.forEach(display => {
        display.addEventListener('click', function () {
            const wrapper = this.nextElementSibling;
            if (wrapper && wrapper.classList.contains('rank-input-wrapper')) {
                const input = wrapper.querySelector('.rank-input');
                wrapper.classList.remove('hidden');
            this.classList.add('hidden');
                if (input) {
            input.focus();
            input.select();
                }
            }
        });
    });

    // Tick button click handlers
    document.querySelectorAll('.rank-save-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const applicationId = this.dataset.applicationId;
            const wrapper = this.closest('.rank-input-wrapper');
            const input = wrapper ? wrapper.querySelector('.rank-input') : null;
            if (input && input.dataset.applicationId === applicationId) {
                saveRank(input);
            }
        });
    });

    // Blur & key events
    rankInputs.forEach(input => {
        // Don't save on blur - only on tick button or Enter key
        input.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveRank(input);
            }
            if (e.key === 'Escape') {
                const wrapper = input.closest('.rank-input-wrapper');
                const display = wrapper ? wrapper.previousElementSibling : input.previousElementSibling;
                input.value = input.dataset.originalValue || '';
                if (wrapper) {
                    wrapper.classList.add('hidden');
                } else {
                input.classList.add('hidden');
                }
                if (display) display.classList.remove('hidden');
            }
        });
    });
}

// Initialize todo popup functionality - runs immediately and on DOM ready
(function() {
    // Create popup element if it doesn't exist
    function createTodoPopup() {
        if (!window.todoPopup) {
            window.todoPopup = document.getElementById('todo-popup');
        }
        if (!window.todoPopup) {
            window.todoPopup = document.createElement('div');
            window.todoPopup.id = 'todo-popup';
            window.todoPopup.className = 'todo-popup';
            window.todoPopup.innerHTML = `
                <div class="todo-popup-header">
                    <div class="todo-popup-title">To Do Action</div>
                    <button class="todo-popup-close" type="button">&times;</button>
                </div>
                <div class="todo-popup-content"></div>
            `;
            if (document.body) {
                document.body.appendChild(window.todoPopup);
            } else {
                document.addEventListener('DOMContentLoaded', function() {
                    document.body.appendChild(window.todoPopup);
                });
            }
            
            // Close button handler
            const closeBtn = window.todoPopup.querySelector('.todo-popup-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    window.todoPopup.classList.remove('show');
                });
            }
        }
    }
    
    // Initialize popup click handler using event delegation
    function initTodoPopupHandler() {
        if (window.todoPopupHandlerInitialized) {
            return;
        }
        
        // Use event delegation on document to catch all clicks
        document.addEventListener('click', function(e) {
            // Check if click is on todo icon or its children
            const todoIcon = e.target.closest('.todo-icon');
            if (todoIcon) {
                e.stopPropagation();
                e.preventDefault();
                
                // Ensure popup exists
                if (!window.todoPopup) {
                    createTodoPopup();
                }
                
                const action = todoIcon.dataset.todoAction;
                if (action && window.todoPopup) {
                    const content = window.todoPopup.querySelector('.todo-popup-content');
                    if (content) {
                        content.textContent = action;
                        
                        // Position popup near the icon
                        const rect = todoIcon.getBoundingClientRect();
                        const popupWidth = 250;
                        const popupHeight = 100;
                        let left = rect.left + (rect.width / 2) - (popupWidth / 2);
                        let top = rect.top - popupHeight - 10;
                        
                        // Adjust if popup goes off screen
                        if (left < 10) left = 10;
                        if (left + popupWidth > window.innerWidth - 10) {
                            left = window.innerWidth - popupWidth - 10;
                        }
                        if (top < 10) {
                            top = rect.bottom + 10;
                        }
                        
                        window.todoPopup.style.left = left + 'px';
                        window.todoPopup.style.top = top + 'px';
                        window.todoPopup.classList.add('show');
                    }
                }
                return;
            }
            
            // Close popup if clicking outside
            if (window.todoPopup && window.todoPopup.classList.contains('show') && 
                !window.todoPopup.contains(e.target) && 
                !e.target.closest('.todo-icon')) {
                window.todoPopup.classList.remove('show');
            }
        });
        
        window.todoPopupHandlerInitialized = true;
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            createTodoPopup();
            initTodoPopupHandler();
        });
    } else {
        createTodoPopup();
        initTodoPopupHandler();
    }
})();

document.addEventListener('DOMContentLoaded', function () {
    initializeRankEditing();
});

<script>
document.addEventListener("DOMContentLoaded", function () {
    const archiveBtn = document.getElementById("archive-btn");

    archiveBtn.addEventListener("click", async function () {
        // 1 Collect selected application IDs
        const selectedIds = Array.from(document.querySelectorAll(".job-check.job-checkbox:checked"))
                                 .map(cb => cb.dataset.applicationId || cb.dataset.jobId)
                                 .filter(id => id); // Filter out undefined values

        if (selectedIds.length === 0) {
            showWarningAlert('No Selection', 'Please select at least one application to archive.');
            return;
        }

        showConfirmAlert(
            'Archive Applications',
            `Are you sure you want to archive ${selectedIds.length} application(s)?`,
            'Archive',
            'Cancel',
            async function(confirmed) {
                if (!confirmed) return;
                
                try {
                    // 2 Send archive request
                    const response = await fetch("/provider/application/archive/bulk", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ ids: selectedIds })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showSuccessAlert('Success', result.message);

                        // 3 Remove archived rows from DOM
                        selectedIds.forEach(id => {
                            // Try to find by application-id first, then by job-id
                            let checkbox = document.querySelector(`.job-check.job-checkbox[data-application-id="${id}"]`);
                            if (!checkbox) {
                                checkbox = document.querySelector(`.job-check.job-checkbox[data-job-id="${id}"]`);
                            }
                            
                            if (checkbox) {
                                // Remove the entire job-lists container (parent of job-row)
                                const jobList = checkbox.closest(".job-lists");
                                if (jobList) {
                                    jobList.remove();
                                } else {
                                    // Fallback: remove just the job-row
                                    const row = checkbox.closest(".job-row");
                                if (row) row.remove();
                                }
                            }
                        });
                        
                        // Update UI after removal
                        const remainingRows = document.querySelectorAll('.job-lists');
                        if (remainingRows.length === 0) {
                            const container = document.querySelector('.job-list-container');
                            if (container) {
                                container.innerHTML = '<p class="mb-0">No applications found.</p>';
                            }
                        }
                        
                        // Uncheck all checkboxes and update button states
                        document.querySelectorAll('.job-checkbox').forEach(cb => cb.checked = false);
                        if (typeof toggleActionsVisibility === 'function') {
                            toggleActionsVisibility();
                        }
                        if (typeof updateButtonStates === 'function') {
                            updateButtonStates();
                        }


                    } else {
                        showErrorAlert('Error', result.message || "Something went wrong.");
                    }
                } catch (error) {
                    console.error("Error archiving applications:", error);
                    showErrorAlert('Error', 'An error occurred while archiving applications.');
                }
            }
        );
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const headers = document.querySelectorAll('.sortable');
  let currentSort = { key: null, direction: 'asc' };

  headers.forEach(header => {
    header.addEventListener('click', () => {
      const key = header.dataset.sort;
      const direction = (currentSort.key === key && currentSort.direction === 'asc') ? 'desc' : 'asc';
      currentSort = { key, direction };

      // Reset all arrows to inactive
      document.querySelectorAll('.sort-toggle .arrow').forEach(a => a.classList.remove('active'));
      // Activate the appropriate arrow on current header
      const up = header.querySelector('.sort-toggle .sort-up');
      const down = header.querySelector('.sort-toggle .sort-down');
      if (direction === 'asc' && up) up.classList.add('active');
      if (direction === 'desc' && down) down.classList.add('active');

      sortApplications(key, direction);
    });
  });

  function sortApplications(key, direction) {
    const rows = Array.from(document.querySelectorAll('.job-row')).map(row => {
      const cells = Array.from(row.children);
      // Structure: [0]checkbox, [1]job, [2]location, [3]salary, [4]category, [5]applied(cond), [6]rank(cond), [7]todo(cond), [8]interview(cond), [9]status
      
      // Find cells by their content/class rather than index since columns are conditional
      const locationCell = cells.find(c => c.classList.contains('col-start') && c.classList.contains('col-center') && c.textContent.trim() && !c.querySelector('select') && c !== cells[1]);
      const salaryCell = cells.find(c => c.classList.contains('col-start') && c.classList.contains('col-center') && c !== locationCell && !c.querySelector('select') && c !== cells[1]);
      const appliedCell = cells.find(c => c.textContent.trim().match(/\d{2}\/\d{2}\/\d{4}/) && c !== salaryCell && c !== locationCell);
      const rankCell = row.querySelector('.col-rank');
      const todoCell = cells.find(c => c.textContent.trim() && c !== locationCell && c !== salaryCell && c !== appliedCell && c !== rankCell && !c.querySelector('select') && !c.classList.contains('col-job'));
      const interviewCell = cells.find(c => c.textContent.trim() && c !== locationCell && c !== salaryCell && c !== appliedCell && c !== rankCell && c !== todoCell && !c.querySelector('select') && !c.classList.contains('col-job'));
      // Status is the last cell with text content that's not a checkbox, select, or other special cell
      const statusCell = Array.from(cells).reverse().find(c => {
        const text = c.textContent.trim();
        const hasStatusText = text && 
               (text.match(/^(Applied|Interview|Hired|Rejected|Saved|In Review|Offered|Completed)$/i) ||
                (text.length > 0 && !text.match(/^\d+$/) && !text.match(/^\d+\/\d+\/\d+$/) && text !== '' && text !== 'To Do Actions'));
        return hasStatusText &&
               !c.querySelector('select') && 
               !c.querySelector('input[type="checkbox"]') && 
               !c.querySelector('.job-title') &&
               !c.querySelector('.rank-display') &&
               !c.querySelector('.rank-input') &&
               c !== locationCell && 
               c !== salaryCell && 
               c !== appliedCell && 
               c !== rankCell && 
               c !== todoCell && 
               c !== interviewCell;
      });
      
      return {
        element: row,
        job: {
          job: row.querySelector('.job-title')?.textContent.trim().toLowerCase() || '',
          location: locationCell?.textContent.trim().toLowerCase() || '',
          salary: parseFloat(salaryCell?.textContent.trim().replace(/[^0-9.]/g, '')) || 0,
          applied: appliedCell?.textContent.trim() || '',
          rank: parseInt(rankCell?.textContent.trim()) || 0,
          todo: todoCell?.textContent.trim() || '',
          interview: interviewCell?.textContent.trim() || '',
          status: statusCell?.textContent.trim().toLowerCase() || ''
        }
      };
    });

    rows.sort((a, b) => {
      const valA = a.job[key];
      const valB = b.job[key];
      if (typeof valA === 'string') {
        return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
      } else {
        return direction === 'asc' ? valA - valB : valB - valA;
      }
    });

    const container = document.querySelector('.job-list-container');
    if (container) {
      rows.forEach(row => {
        if (row.element && row.element.parentElement) {
          container.appendChild(row.element.parentElement);
        }
      });
    }
  }
});
</script>

<script>
// Filter functionality
document.addEventListener('DOMContentLoaded', function() {
  const filterBtn = document.getElementById('filter-btn');
  const filterPanel = document.getElementById('filter-panel');
  const applyFilterBtn = document.getElementById('apply-filter-btn');
  const clearFilterBtn = document.getElementById('clear-filter-btn');
  
  if (!filterBtn || !filterPanel) return;
  
  // Toggle filter panel - ONLY toggle, don't apply filters
  filterBtn.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    // Toggle the hidden class to show/hide the overlay
    const isHidden = filterPanel.classList.contains('hidden');
    if (isHidden) {
      filterPanel.classList.remove('hidden');
      filterPanel.style.display = 'block';
    } else {
      filterPanel.classList.add('hidden');
      filterPanel.style.display = 'none';
    }
  });
  
  // Close filter panel when clicking outside
  document.addEventListener('click', function(e) {
    if (filterPanel && filterBtn && !filterPanel.contains(e.target) && !filterBtn.contains(e.target)) {
      filterPanel.classList.add('hidden');
      filterPanel.style.display = 'none';
    }
  });
  
  // Apply filters - only when Apply button is clicked
  if (applyFilterBtn) {
    applyFilterBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      try {
    applyFilters();
        if (filterPanel) filterPanel.classList.add('hidden');
      } catch (error) {
        console.error('Error applying filters:', error);
        // Show all rows if there's an error
        showAllRows();
      }
    });
  }
  
  // Clear filters
  if (clearFilterBtn) {
    clearFilterBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      const locationInput = document.getElementById('filter-location');
      const salaryMinInput = document.getElementById('filter-salary-min');
      const salaryMaxInput = document.getElementById('filter-salary-max');
    const dateApplied = document.getElementById('filter-date-applied');
      
      if (locationInput) locationInput.value = '';
      if (salaryMinInput) salaryMinInput.value = '';
      if (salaryMaxInput) salaryMaxInput.value = '';
    if (dateApplied) dateApplied.value = '';
      
      // Reload page to show all applications
      window.location.href = "{{ path('app_provider_jobs_applications') }}";
    });
  }
  
  function showAllRows() {
    // Only target .job-lists wrapper, not .job-row
    const rowWrappers = document.querySelectorAll('.job-lists');
    console.log('Showing all rows, found:', rowWrappers.length, 'wrappers');
    rowWrappers.forEach(wrapper => {
      // Force show the element by removing any inline styles
      wrapper.style.display = '';
      wrapper.style.removeProperty('display');
      // Also remove hidden class if present
      wrapper.classList.remove('hidden');
      wrapper.classList.remove('d-none');
    });
  }
  
  // Ensure all rows are visible on page load - run after a short delay to ensure DOM is ready
  setTimeout(function() {
    showAllRows();
  }, 100);
  
  // Also run on window load to be sure
  window.addEventListener('load', function() {
    setTimeout(showAllRows, 200);
  });
  
  function applyFilters() {
    const locationInput = document.getElementById('filter-location');
    const salaryMinInput = document.getElementById('filter-salary-min');
    const salaryMaxInput = document.getElementById('filter-salary-max');
    const dateAppliedInput = document.getElementById('filter-date-applied');
    const container = document.querySelector('.job-list-container')?.parentElement || document.querySelector('.table-responsive-wrapper')?.parentElement || document.querySelector('.job-section');
    
    if (!container) {
      console.error('Container not found');
      return;
    }
    
    if (!locationInput || !salaryMinInput || !salaryMaxInput) {
      console.warn('Filter inputs not found');
      return;
    }
    
    // Build filter parameters
    const params = new URLSearchParams();
    if (locationInput.value) params.append('location', locationInput.value);
    if (salaryMinInput.value) params.append('salaryMin', salaryMinInput.value);
    if (salaryMaxInput.value) params.append('salaryMax', salaryMaxInput.value);
    if (dateAppliedInput?.value) params.append('days', dateAppliedInput.value);
    
    // Get current status from URL if present
    const urlParams = new URLSearchParams(window.location.search);
    const status = urlParams.get('status');
    if (status) params.append('status', status);
    
    // Show loading spinner
    const listContainer = document.querySelector('.job-list-container');
    if (listContainer) {
      listContainer.innerHTML = `
        <div class="text-center p-4">
          <div class="spinner-border text-success mb-3" role="status"></div>
          <p>Filtering applications...</p>
        </div>
      `;
    }
    
    // Use Symfony route dynamically
    const applicationsUrl = "{{ path('app_provider_jobs_applications') }}";
    
    // Make AJAX request
    fetch(`${applicationsUrl}?${params.toString()}`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then(res => res.json())
      .then(data => {
        if (listContainer) {
          listContainer.outerHTML = data.html;
        } else if (container) {
          // Find where to insert the new content
          const oldContainer = container.querySelector('.job-list-container');
          if (oldContainer) {
            oldContainer.outerHTML = data.html;
          } else {
            // Insert before actions-container or at end
            const actionsContainer = container.querySelector('.actions-container');
            if (actionsContainer) {
              actionsContainer.insertAdjacentHTML('beforebegin', data.html);
            } else {
              container.insertAdjacentHTML('beforeend', data.html);
            }
          }
        }
        filterPanel.classList.add('hidden');
        
        // Use setTimeout to ensure DOM is fully updated
        setTimeout(function() {
          // Re-initialize rank editing after AJAX update
          if (typeof initializeRankEditing === 'function') {
            initializeRankEditing();
          }
          
          // Ensure todo popup is initialized after AJAX update
          // Since we use event delegation, we just need to ensure the popup element exists
          if (!window.todoPopup) {
            window.todoPopup = document.getElementById('todo-popup');
          }
          if (!window.todoPopup) {
            window.todoPopup = document.createElement('div');
            window.todoPopup.id = 'todo-popup';
            window.todoPopup.className = 'todo-popup';
            window.todoPopup.innerHTML = `
                <div class="todo-popup-header">
                    <div class="todo-popup-title">To Do Action</div>
                    <button class="todo-popup-close" type="button">&times;</button>
                </div>
                <div class="todo-popup-content"></div>
            `;
            document.body.appendChild(window.todoPopup);
            
            const closeBtn = window.todoPopup.querySelector('.todo-popup-close');
            if (closeBtn) {
              closeBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                window.todoPopup.classList.remove('show');
              });
            }
          }
          
          // Event delegation handler should already be set up from main initialization
          // No need to re-initialize as it's attached to document and works for all elements
        }, 50);
      })
      .catch(err => {
        console.error('Filter error:', err);
        if (listContainer) {
          listContainer.innerHTML = `<p class="text-danger p-4">Failed to load filtered applications.</p>`;
      }
    });
  }
});
</script>
{% endblock %}