{% extends 'provider/base.html.twig' %}

{% block title %}Archived Jobs{% endblock %}

{% block provider_body %}
<style>
/* COMPLETE RESET - Remove ALL conflicting styles and apply clean spacing to match dashboard */

/* Reset app-wrapper - remove all custom.css overrides */
body.app .app-wrapper,
.app-wrapper {
    display: block !important;
    justify-content: unset !important;
    align-items: unset !important;
    width: 100% !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
}

/* Shift app-wrapper to the left to eliminate gap */
@media (min-width: 1200px) {
    body.app .app-wrapper,
    .app-wrapper {
        margin-left: 250px !important;
        transform: translateX(-150px) !important;
        width: calc(100% - 250px + 150px) !important;
    }
}

/* Reset app-content - remove all custom.css overrides */
body.app .app-wrapper .app-content,
.app-wrapper .app-content,
.app-content {
    padding-left: 0 !important;
    padding-right: 0 !important;
    padding-top: 20px !important;
    padding-bottom: 0 !important;
    max-width: 100% !important;
    width: 100% !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    position: relative !important;
    box-sizing: border-box !important;
}

/* Override custom.css width constraints at 1200px breakpoint */
@media (min-width: 1200px) {
    body.app .app-wrapper .app-content,
    .app-wrapper .app-content,
    .app-content {
        width: 100% !important;
        max-width: 100% !important;
    }
}

/* Reset container-xl - apply clean spacing matching dashboard */
body.app .app-wrapper .app-content .container-xl,
.app-wrapper .app-content .container-xl,
.app-content .container-xl,
body .app-content .container-xl,
div.container-xl,
[class*="container-xl"],
.container-xl {
    position: relative !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    padding-left: 0 !important;
    padding-right: 30px !important;
    max-width: 100% !important;
    width: 100% !important;
    transform: none !important;
    box-sizing: border-box !important;
}

/* Override ALL media queries from custom.css */
@media (min-width: 576px) {
    body.app .app-wrapper .app-content .container-xl,
    .app-wrapper .app-content .container-xl,
    .app-content .container-xl,
    body .app-content .container-xl,
    div.container-xl,
    [class*="container-xl"],
    .container-xl {
        padding-left: 0 !important;
        padding-right: 30px !important;
    }
}

@media (min-width: 992px) {
    body.app .app-wrapper .app-content .container-xl,
    .app-wrapper .app-content .container-xl,
    .app-content .container-xl,
    body .app-content .container-xl,
    div.container-xl,
    [class*="container-xl"],
    .container-xl {
        padding-left: 0 !important;
        padding-right: 30px !important;
    }
}

@media (min-width: 1200px) {
    body.app .app-wrapper {
        position: relative !important;
        margin-left: 250px !important;
        transform: translateX(-150px) !important;
        width: calc(100% - 250px + 150px) !important;
    }
    
    body.app .app-wrapper .app-content,
    .app-wrapper .app-content,
    .app-content {
        position: relative !important;
        max-width: 100% !important;
        width: 100% !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
    }
    
    body.app .app-wrapper .app-content .container-xl,
    .app-wrapper .app-content .container-xl,
    .app-content .container-xl,
    body .app-content .container-xl,
    div.container-xl,
    [class*="container-xl"],
    .container-xl {
        position: relative !important;
        padding-left: 0 !important;
        padding-right: 30px !important;
        max-width: 100% !important;
        width: 100% !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
}

@media (min-width: 1600px) {
    body.app .app-wrapper .app-content,
    .app-wrapper .app-content,
    .app-content {
        max-width: 100% !important;
        width: 100% !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
    
    body.app .app-wrapper .app-content .container-xl,
    .app-wrapper .app-content .container-xl,
    .app-content .container-xl,
    body .app-content .container-xl,
    div.container-xl,
    [class*="container-xl"],
    .container-xl {
        padding-left: 0 !important;
        padding-right: 30px !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
}

.job-header, .job-row {
    display: flex;
    align-items: center;
}

.col-job,
.col-location,
.col-schedule,
.col-expiry,
.col-start,
.col-action {
    flex: 1;
    min-width: 130px;
}
.col-job {
    flex: 2;
}
.job-header {
    padding-left: 14px;
    padding-right: 14px;
    color: #121C0C;
    box-shadow: 0 2px 6px rgba(11,22,40,0.03);
    border-radius: 10px;
    border: 1px solid #e6eef6;
    height: 48px;
    margin-bottom: 2px;
    font-size: 18px;
}
.job-row {
    border: none;
    padding: 20px 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 4px 0;
    font-size: 18px;
    border-radius: 10px;
    background: #F4F9F1;
    border: 1px solid #e6eef6;
    box-shadow: 0 2px 6px rgba(11,22,40,0.03);
}
.truncate-text {
    display: inline-block;
    max-width: 180px; /* Adjust as needed */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    vertical-align: middle;
}
.job-section {
    background-color: #fff;
}
.job-check {
    margin-right: 8px;
    transform: scale(1.2);
}
#toggleActions {
    padding: 6px 16px;
    border-radius: 18px;
    border: 1px solid #ddd;
    font-size: 16px;
    color: #fff;
}
.job-meta {
    margin-top: 1px;
}
.ml-15-px {
    margin-left: 15px;
}
.mr-15-px {
    margin-right: 15px;
}
.action-btn {
    background: transparent;
    border: none;
    padding: 0 4px;
}

.custom-dropdown {
  position: absolute;
  top: 110%;
  left: 0;
  background: #fff;
  padding: 10px;
  min-width: 150px;
  z-index: 1000;
  border: 1px solid #e6eef6;
  box-shadow: 0 2px 6px rgba(11,22,40,0.03);
  border-radius: 10px;
}

.hidden {
  display: none;
}

.columns-panel label {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
  cursor: pointer;
  font-weight: 400;
  color: #121C0C;
}

.menu-panel .menu-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 0;
  cursor: pointer;
  color: #121C0C;
}

.menu-panel svg {
  width: 16px;
  height: 16px;
}

.dropdown-cstm {
    background: #F4F9F1;
    border: 1px solid #e6eef6;
    box-shadow: 0 2px 6px rgba(11,22,40,0.03);
    border-radius: 10px;
    padding: 4px 12px;
}

.menu-panel {
    min-width: 160px;
}

.columns-panel input[type="checkbox"] {
  appearance: none;
  width: 16px;
  height: 16px;
  border: 1px solid #cfd9e3;
  border-radius: 4px;
  background-color: #fff;
  cursor: pointer;
  position: relative;
  transition: background-color 0.3s ease, border-color 0.3s ease;
}

.columns-panel input[type="checkbox"]:hover {
  border-color: #85BB65;
}

.columns-panel input[type="checkbox"]:checked {
  background-color: #85BB65;
  border-color: #85BB65;
}

.columns-panel input[type="checkbox"]:checked::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 5px;
  width: 4px;
  height: 8px;
  border: solid white;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}

.col-check input[type="checkbox"] {
  appearance: none;
  width: 16px;
  height: 16px;
  border: 1px solid #cfd9e3;
  border-radius: 4px;
  background-color: #fff;
  cursor: pointer;
  position: relative;
  transition: background-color 0.3s ease, border-color 0.3s ease;
}

.col-check input[type="checkbox"]:hover {
  border-color: #85BB65;
}

.col-check input[type="checkbox"]:checked {
  background-color: #85BB65;
  border-color: #85BB65;
}

.col-check input[type="checkbox"]:checked::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 5px;
  width: 4px;
  height: 8px;
  border: solid white;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}

/* Consistent rounded-square style for all job list checkboxes */
.job-list-container input[type="checkbox"].job-check,
.split-job-list input[type="checkbox"].job-checkbox,
#select-all-checkbox {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  border: 1px solid #cfd9e3;
  border-radius: 4px;
  background: #fff;
  cursor: pointer;
  position: relative;
  display: inline-block;
  vertical-align: middle;
  margin: 0;
  transition: background-color 0.3s ease, border-color 0.3s ease;
}

/* Hover state - green border */
.job-list-container input[type="checkbox"].job-check:hover,
.split-job-list input[type="checkbox"].job-checkbox:hover,
#select-all-checkbox:hover {
  border-color: #85BB65;
}

/* Checked state - green filled with white checkmark */
.job-list-container input[type="checkbox"].job-check:checked,
.split-job-list input[type="checkbox"].job-checkbox:checked,
#select-all-checkbox:checked {
  background-color: #85BB65;
  border-color: #85BB65;
}

.job-list-container input[type="checkbox"].job-check:checked::after,
.split-job-list input[type="checkbox"].job-checkbox:checked::after,
#select-all-checkbox:checked::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 6px;
  width: 4px;
  height: 8px;
  border: solid #fff;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}

/* Remove previous scale that distorted shape */
.job-check { transform: none; margin-right: 8px; }

.job-title {
    color: #121C0C;
    font-size: 20px;
}

.action-btn {
    // background: #F4F9F1;
    border: 1px solid #e6eef6;
    box-shadow: 0 2px 6px rgba(11,22,40,0.03);
    border-radius: 10px;
    padding: 4px 12px;
    display: flex;
    gap: 6px;
    align-items: center;
}
.action-btn, .dropdown-cstm {
    transition: all 0.2s ease;
}
.action-btn:hover, .dropdown-cstm:hover {
    color: #85BB65;
    border: 1px solid #85BB65;
    transition: all 0.2s ease;
}
.action-btn:hover svg {
    color: #85BB65;
}
#delete-btn:hover {
    color: #BA1824;
    border: 1px solid #BA1824;
    transition: all 0.2s ease; 
}
#delete-btn:hover svg {
    color: #BA1824;
}
.col-center {
    text-align: center;
}
.col-rank {
    min-width: 100px !important;
    max-width: none !important;
    width: 100px !important;
    overflow: visible !important;
    position: relative !important;
}

/* Prevent score duplication - ensure only one rank display is visible */
.col-rank .rank-display {
    display: inline-flex !important;
}

.col-rank .rank-display.hidden {
    display: none !important;
}

.col-rank .rank-display::before,
.col-rank .rank-display::after {
    content: none !important;
}

/* Hide any duplicate rank displays */
.col-rank > .rank-display:not(:first-of-type) {
    display: none !important;
}

/* Ensure rank input wrapper is hidden by default, but can be shown when not hidden */
.col-rank .rank-input-wrapper.hidden {
    display: none !important;
}

.col-rank .rank-input-wrapper:not(.hidden) {
    display: inline-flex !important;
}

/* Critical: When wrapper is visible, ensure the display that comes before it is hidden */
/* Since display comes before wrapper, we need to hide display when wrapper is visible */
.col-rank:has(.rank-input-wrapper:not(.hidden)) .rank-display:not(.hidden) {
    display: none !important;
}
.application .card {
  clip-path: polygon(0% 0%,calc(100% - 15px) 0%,100% 50%,calc(100% - 15px) 100%,0% 100%,15px 50%,0% 0%);
  display: flex;
  justify-content: center;
  align-items: center;
  flex: 1 0 auto;
  margin-left: -15px;
  cursor: pointer;
}

/* First card: arrow on right only */
.application .col:first-child .card {
    clip-path: polygon(0% 0%,calc(100% - 15px) 0%,100% 50%,calc(100% - 15px) 100%,0% 100%,0% 0%);
    margin-left: 0;
    height: 65px;
    align-items: center;
    justify-content: center;
}
.application .col:first-child {
    max-width: 150px;
}
.application .col .card-body {
    justify-content: center;
    flex-direction: column-reverse;
    text-align: center;
    align-items: center;
}
.application .col .card-body .card-title {
    font-size: 16px;
}
.is-card.is-applied:hover *, .is-card.is-review:hover *, .is-card.is-interview:hover *, .is-card.is-rejected:hover *, .is-card.is-hired:hover *, .is-card.is-offered:hover *, .is-card.is-completed:hover *, .is-card.is-applied.active *, .is-card.is-review.active *, .is-card.is-interview.active *, .is-card.is-rejected.active *, .is-card.is-hired.active *, .is-card.is-offered.active *, .is-card.is-completed.active *, .is-card .card-body p, .is-card .card-body:hover, .application .col .card-body .card-title:hover, .is-card:hover {
    color: rgb(33, 37, 41);
}
.application .col .card-body p {
    font-size: 18px;
    color: #121C0C;
}
.application .col:first-child .card .card-body {
    align-items: center;
}
.application .col:nth-child(2) .card {
  clip-path: polygon(0% 0%,calc(100% - 15px) 0%,100% 50%,calc(100% - 15px) 100%,0% 100%,0% 0%);
  margin-left: 0;
}
.application .col:last-child .card {
    clip-path: polygon(0% 0%,100% 0%,100% 100%,0% 100%,15px 50%,0% 0%);
}
.application .col:first-child .card-body .card-title {
    font-size: 16px;
}
.col:nth-child(1) .is-card {
  background-color: #D2E6C6;
}
.col:nth-child(2) .is-card {
  background-color: #C7E0B8;
}
.col:nth-child(3) .is-card {
  background-color: #BBDAAA;
}
.col:nth-child(4) .is-card {
  background-color: #AFD39C;
}
.col:nth-child(5) .is-card {
  background-color: #A4CC8E;
}
.col:nth-child(6) .is-card {
  background-color: #99C680;
}
.col:nth-child(7) .is-card {
  background-color: #8DC072;
}
.col:nth-child(8) .is-card {
  background-color: #82B964;
}

.col:nth-child(1) .is-card:hover {
  background-color: #B9F2FF;
}
.col:nth-child(2) .is-card:hover {
  background-color: #ADF0FF;
}
.col:nth-child(3) .is-card:hover {
  background-color: #99ECFF;
}
.col:nth-child(4) .is-card:hover {
  background-color: #85E9FF;
}
.col:nth-child(5) .is-card:hover {
  background-color: #70E5FF;
}
.col:nth-child(6) .is-card:hover {
  background-color: #5CE1FF;
}
.col:nth-child(7) .is-card:hover {
  background-color: #47DDFF;
}
.col:nth-child(8) .is-card:hover {
  background-color: #33DAFF;
}
.col .is-card.is-saved.active {
    background-color: #ADF0FF;
}
.sort-toggle {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  line-height: 1;
  gap: 2px;
  margin-left: 6px;
  vertical-align: middle;
  position: relative;
  top: 1px; /* nudges to visually center with text */
}
.sort-toggle svg { width: 10px; height: 10px; }
.sort-toggle .arrow { opacity: 0.35; transition: opacity 0.15s ease; }
.sort-toggle .arrow.active { opacity: 1; }

.actions-container {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  gap: 16px;
}

/* Enhanced table alignment and typography */
.job-header {
  font-size: 13px;
  font-weight: 600;
  color: #121C0C;
  letter-spacing: 0.01em;
  line-height: 1.5;
  background: #F8FAF9;
  border-bottom: 2px solid #e6eef6;
}

.job-row {
  font-size: 13px;
  font-weight: 400;
  color: #1a1a1a;
  line-height: 1.5;
  transition: background-color 0.2s ease;
}

.job-row:hover {
  background-color: #F8FAF9;
}

/* Perfect alignment between headers and rows */
.job-header > div,
.job-row > div {
  display: flex;
  align-items: center;
  box-sizing: border-box;
  padding: 12px 8px;
  min-width: 0;
  overflow: hidden;
  height: 48px;
}

/* Ensure consistent vertical alignment */
.job-header {
  min-height: 48px;
  height: 48px;
}

/* Center content for numeric/text columns */
.job-header .col-start.col-center,
.job-row .col-start.col-center {
  justify-content: center;
  text-align: center;
}

/* Job column specific styling */
.col-job {
  font-weight: 500;
}

/* Improve text truncation */
.job-title {
  font-size: 13px;
  font-weight: 500;
  color: #121C0C;
  line-height: 1.4;
}

/* Consistent cell content styling */
.job-row > div {
  font-size: 13px;
  color: #1a1a1a;
}

/* Status and badge styling */
.job-row .badge {
  font-size: 11px;
  font-weight: 500;
  padding: 4px 8px;
  border-radius: 6px;
}

.job-actions-left {
  justify-self: start;
}

.job-actions-middle {
  justify-self: center;
}

.col-dropdowns {
  justify-self: end;
}

.table-responsive-wrapper {
  overflow-x: auto;
  overflow-y: visible;
  -webkit-overflow-scrolling: touch;
}

.table-responsive-wrapper::-webkit-scrollbar {
  height: 8px;
}

.table-responsive-wrapper::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

.table-responsive-wrapper::-webkit-scrollbar-thumb {
  background: #85BB65;
  border-radius: 10px;
}

.table-responsive-wrapper::-webkit-scrollbar-thumb:hover {
  background: #6fa852;
}
</style>

<div class="container-xl">
    <div class="job-section shadow-lg p-3 rounded-3">
        <div class="d-flex justify-content-between align-items-center ml-15-px" style="margin-bottom:30px;">
            <h6 class="app-card-title mb-0">Archived Jobs</h6>
            <div class="col-dropdowns d-flex gap-2">
              <!-- Menu Dropdown -->
              <div class="menu-dropdown position-relative">
                <button type="button" class="menu-dropdown-btn dropdown-cstm"><span>Menu</span></button>
                <div class="dropdown-panel menu-panel custom-dropdown hidden">
                  <a href="{{ path('app_provider_download_data', {'type': 'archived'}) }}" class="menu-item" style="text-decoration: none; color: inherit;"><svg width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16.44 8.8999C20.04 9.2099 21.51 11.0599 21.51 15.1099V15.2399C21.51 19.7099 19.72 21.4999 15.25 21.4999H8.73998C4.26998 21.4999 2.47998 19.7099 2.47998 15.2399V15.1099C2.47998 11.0899 3.92998 9.2399 7.46998 8.9099" stroke="#121C0C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 15.0001V3.62012" stroke="#121C0C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M15.35 5.85L12 2.5L8.65002 5.85" stroke="#121C0C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg> Export Report</a>
                </div>
              </div>
            </div>
        </div>

        {% if archivedApplications is defined and archivedApplications|length > 0 %}
            {% set applications = archivedApplications %}
            {% set status = 'archived' %}
            {% include 'provider/job/_application_list.html.twig' %}
        {% else %}
            <p class="mb-0 ml-15-px mt-3" style="font-size: 18px; color: #121C0C;">No archived jobs right now.</p>
        {% endif %}                                                  
    </div>
</div>
{% endblock %}

{% block footer_scripts %}
<script>
// Force apply styles via JavaScript - COMPLETE OVERRIDE - Run multiple times to ensure it sticks
function applySpacingStyles() {
    // Reset and apply container-xl styles
    const container = document.querySelector('.container-xl');
    if (container) {
        container.style.setProperty('position', 'relative', 'important');
        container.style.setProperty('padding-left', '0', 'important');
        container.style.setProperty('padding-right', '30px', 'important');
        container.style.setProperty('margin-left', '0', 'important');
        container.style.setProperty('margin-right', '0', 'important');
        container.style.setProperty('transform', 'none', 'important');
        container.style.setProperty('max-width', '100%', 'important');
        container.style.setProperty('width', '100%', 'important');
    }
    
    // Reset app-content
    const appContent = document.querySelector('.app-content');
    if (appContent) {
        appContent.style.setProperty('position', 'relative', 'important');
        appContent.style.setProperty('padding-left', '0', 'important');
        appContent.style.setProperty('padding-right', '0', 'important');
        appContent.style.setProperty('margin-left', '0', 'important');
        appContent.style.setProperty('margin-right', '0', 'important');
        appContent.style.setProperty('max-width', '100%', 'important');
        appContent.style.setProperty('width', '100%', 'important');
    }
    
    // Reset app-wrapper
    const appWrapper = document.querySelector('.app-wrapper');
    if (appWrapper) {
        appWrapper.style.setProperty('position', 'relative', 'important');
        if (window.innerWidth >= 1200) {
            appWrapper.style.setProperty('margin-left', '250px', 'important');
            appWrapper.style.setProperty('transform', 'translateX(-150px)', 'important');
            appWrapper.style.setProperty('width', 'calc(100% - 250px + 150px)', 'important');
        } else {
            appWrapper.style.setProperty('margin-left', '0', 'important');
            appWrapper.style.setProperty('transform', 'none', 'important');
            appWrapper.style.setProperty('width', '100%', 'important');
        }
        appWrapper.style.setProperty('margin-right', '0', 'important');
        appWrapper.style.setProperty('padding-left', '0', 'important');
        appWrapper.style.setProperty('padding-right', '0', 'important');
    }
}

// Run immediately
document.addEventListener('DOMContentLoaded', applySpacingStyles);

// Run after a short delay to override any late-loading styles
setTimeout(applySpacingStyles, 100);
setTimeout(applySpacingStyles, 500);

// Re-apply on window resize to override any responsive changes
window.addEventListener('resize', function() {
    setTimeout(applySpacingStyles, 50);
});
</script>

<script>
// Rank editing functionality for archived applications
document.addEventListener('DOMContentLoaded', function () {
    const rankDisplays = document.querySelectorAll('.rank-display');
    const rankInputs = document.querySelectorAll('.rank-input');

    function saveRank(input) {
        let value = parseFloat(input.value);
        const applicationId = input.dataset.applicationId;
        const wrapper = input.closest('.rank-input-wrapper');
        const display = wrapper ? wrapper.previousElementSibling : input.previousElementSibling;

        if (isNaN(value)) {
            showErrorAlert('Invalid Score', 'Score must be a number between 1 and 10.');
            input.value = input.dataset.originalValue || '';
            return;
        }

        // Clamp and round to nearest 0.5
        if (value < 1) value = 1;
        if (value > 10) value = 10;
        value = Math.round(value * 2) / 2;

        if (value === parseFloat(input.dataset.originalValue)) {
            if (wrapper) {
                wrapper.classList.add('hidden');
            } else {
                input.classList.add('hidden');
            }
            if (display) display.classList.remove('hidden');
            return;
        }

        // AJAX request
        fetch('{{ path("app_update_application_rank") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ applicationId, rank: value })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                if (display) {
                    // Format the value to 1 decimal place
                    const formattedValue = parseFloat(value).toFixed(1);
                    display.textContent = formattedValue + '/10';
                    display.classList.remove('hidden');
                }
                input.dataset.originalValue = value;
                if (wrapper) {
                    wrapper.classList.add('hidden');
                } else {
                    input.classList.add('hidden');
                }
                // Show toast
                let msg = document.getElementById('rank-success-msg');
                if (!msg) {
                    msg = document.createElement('div');
                    msg.id = 'rank-success-msg';
                    msg.style.position = 'fixed';
                    msg.style.top = '20px';
                    msg.style.right = '20px';
                    msg.style.backgroundColor = '#4CAF50';
                    msg.style.color = 'white';
                    msg.style.padding = '10px 15px';
                    msg.style.borderRadius = '5px';
                    msg.style.zIndex = '9999';
                    document.body.appendChild(msg);
                }
                msg.textContent = 'Score updated successfully!';
                msg.style.display = 'block';
                if (msg.timeoutId) clearTimeout(msg.timeoutId);
                msg.timeoutId = setTimeout(() => { msg.style.display = 'none'; }, 2000);
            } else {
                showErrorAlert('Update Failed', 'Failed to update score: ' + (data.message || 'Unknown error'));
                input.value = input.dataset.originalValue || '';
            }
        })
        .catch(err => {
            console.error('Fetch error:', err);
            showErrorAlert('Server Error', 'Server error while updating score.');
            input.value = input.dataset.originalValue || '';
        });
    }

    // Initialize original values
    rankInputs.forEach(input => input.dataset.originalValue = input.value || '');

    // Click to edit
    rankDisplays.forEach(display => {
        display.addEventListener('click', function () {
            // Hide this display first
            this.classList.add('hidden');
            
            // Find and show the wrapper
            const wrapper = this.nextElementSibling;
            if (wrapper && wrapper.classList.contains('rank-input-wrapper')) {
                wrapper.classList.remove('hidden');
                const input = wrapper.querySelector('.rank-input');
                if (input) {
                    // Small delay to ensure CSS has applied
                    setTimeout(() => {
                        input.focus();
                        input.select();
                    }, 10);
                }
            }
        });
    });

    // Tick button click handlers
    document.querySelectorAll('.rank-save-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const applicationId = this.dataset.applicationId;
            const wrapper = this.closest('.rank-input-wrapper');
            const input = wrapper ? wrapper.querySelector('.rank-input') : null;
            if (input && input.dataset.applicationId === applicationId) {
                saveRank(input);
            }
        });
    });

    // Blur & key events
    rankInputs.forEach(input => {
        // Don't save on blur - only on tick button or Enter key
        input.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveRank(input);
            }
            if (e.key === 'Escape') {
                const wrapper = input.closest('.rank-input-wrapper');
                const display = wrapper ? wrapper.previousElementSibling : input.previousElementSibling;
                input.value = input.dataset.originalValue || '';
                if (wrapper) {
                    wrapper.classList.add('hidden');
                } else {
                    input.classList.add('hidden');
                }
                if (display) display.classList.remove('hidden');
            }
        });
    });
});

  // Single-selection feature: prevent multiple checkboxes from being selected
  document.addEventListener('DOMContentLoaded', function() {
    // Delegated change listener to catch any checkbox state changes reliably
    document.addEventListener('change', (e) => {
      const target = e.target;
      if (!target) return;
      if (target.classList && (target.classList.contains('job-checkbox') || target.classList.contains('job-check'))) {
        // Enforce single selection
        if (target.checked) {
          // Get all checkboxes (including split view ones)
          const allCheckboxes = document.querySelectorAll('.job-checkbox, .job-check');
          const otherChecked = Array.from(allCheckboxes).find(cb => cb !== target && cb.checked);
          if (otherChecked) {
            // Prevent this checkbox from being checked and show alert
            target.checked = false;
            showWarningAlert('Multiple Selection', 'You cannot select multiple values');
            return;
          }
        }
      }
    });
  });
</script>

<script>
// Menu dropdown functionality
document.addEventListener('DOMContentLoaded', function() {
    const menuBtn = document.querySelector('.menu-dropdown-btn');
    const menuPanel = document.querySelector('.menu-panel');

    function toggleDropdown(panel, btn) {
        const isOpen = !panel.classList.contains('hidden');
        closeAllDropdowns();
        if (!isOpen) panel.classList.remove('hidden');
    }

    function closeAllDropdowns() {
        if (menuPanel) menuPanel.classList.add('hidden');
    }

    if (menuBtn && menuPanel) {
        menuBtn.addEventListener('click', e => {
            e.stopPropagation();
            toggleDropdown(menuPanel, menuBtn);
        });

        document.addEventListener('click', e => {
            if (!menuPanel.contains(e.target) && !menuBtn.contains(e.target)) {
                closeAllDropdowns();
            }
        });
    }
});
</script>
{% endblock %}
