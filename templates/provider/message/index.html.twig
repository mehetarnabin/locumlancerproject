{% extends 'provider/base.html.twig' %}

{% block title %}Messages{% endblock %}

{% block provider_body %}
<style>
* {
    box-sizing: border-box;
}

body {
    overflow-x: hidden;
}

/* Override parent container padding */
.app-content {
    padding: 32px 0 !important;
    margin: 0 !important;
    max-width: 100% !important;
    display: flex !important;
    justify-content: center !important;
}

/* Override any container padding */
.container-xl,
.container-fluid,
.container,
.app-wrapper {
    padding-left: 0 !important;
    padding-right: 0 !important;
    margin-left: auto !important;
    margin-right: auto !important;
    max-width: 100% !important;
}

/* Main wrapper - centered in viewport */
.email-app-wrapper {
    height: calc(100vh - 60px);
    display: flex;
    justify-content: center;
    align-items: stretch;
    padding: 0 !important;
    margin: 0 auto !important;
    background: #fff;
    width: calc(100% - 48px);
    max-width: 1400px;
    overflow: hidden;
    position: relative;
    border: 1px solid #e6eef6;
    border-radius: 16px;
    box-shadow: 0 12px 30px rgba(17, 24, 39, 0.08);
}

.email-app-container {
    width: 100%;
    display: flex;
    gap: 0;
    height: 100%;
    align-items: stretch;
    padding: 0 !important;
    margin: 0 !important;
    overflow: hidden;
    min-width: 0;
    background: #fff;
    border-radius: 16px;
}

/* Right Sidebar */
.right-sidebar {
    width: 88px;
    background: #fff;
    border-radius: 0 16px 16px 0;
    padding: 24px 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    box-shadow: none;
    flex-shrink: 0;
    position: relative;
    order: 2;
    border-left: 1px solid #e6eef6;
    height: 100%;
    overflow: visible;
    z-index: 10;
}

.sidebar-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    text-decoration: none;
}

.sidebar-icon:hover {
    background: #f1f3f4;
    transform: scale(1.08);
}

/* Tooltip styling */
.sidebar-icon {
    position: relative;
}

.sidebar-icon::before {
    content: attr(data-tooltip);
    position: absolute;
    right: calc(100% + 12px);
    top: 50%;
    transform: translateY(-50%);
    background: #3c4043;
    color: #fff;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 10000;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.sidebar-icon:hover::before {
    opacity: 1;
}

.sidebar-icon::after {
    content: '';
    position: absolute;
    right: calc(100% + 4px);
    top: 50%;
    transform: translateY(-50%);
    border: 5px solid transparent;
    border-left-color: #3c4043;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 10001;
}

.sidebar-icon:hover::after {
    opacity: 1;
}

.sidebar-icon:active {
    transform: scale(0.95);
}

.sidebar-icon.active {
    background: #e8f5e9;
}

.sidebar-icon.active::after {
    content: '';
    position: absolute;
    right: -20px;
    top: 50%;
    transform: translateY(-50%);
    width: 3px;
    height: 32px;
    background: #85BB65;
    border-radius: 2px 0 0 2px;
}

.sidebar-icon svg {
    width: 28px;
    height: 28px;
}

.sidebar-icon.calendar svg {
    color: #1a73e8;
}

.sidebar-icon.interview svg {
    color: #ea4335;
}

.sidebar-icon.document svg {
    color: #fbbc04;
}


/* Messages Page */
.messages-page {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #fff;
    border-radius: 0;
    box-shadow: none;
    overflow: hidden;
    border: none;
    border-right: 1px solid #e6eef6;
    order: 1;
    min-width: 0;
    height: 100%;
    margin: 0;
}

.messages-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 24px;
    border-bottom: 1px solid #e6eef6;
    border-top: 1px solid #e6eef6;
    background: #fff;
    flex-shrink: 0;
}

.messages-header h6 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
    color: #121C0C;
}

.messages-container {
    display: flex;
    gap: 0;
    flex: 1;
    overflow: hidden;
    min-width: 0;
}

.messages-sidebar {
    background: #fff;
    border-right: 1px solid #e6eef6;
    padding: 24px 20px;
    width: 240px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    overflow-x: hidden;
    position: relative;
}

.messages-sidebar .new-message-btn {
    background: #85BB65;
    color: #fff;
    border: none;
    border-radius: 12px;
    padding: 12px 16px;
    font-weight: 500;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: center;
    width: 100%;
    margin-bottom: 16px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 4px rgba(133, 187, 101, 0.2);
    cursor: pointer;
    font-size: 14px;
    position: relative;
    overflow: hidden;
}

.messages-sidebar .new-message-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    transform: translate(-50%, -50%);
    transition: width 0.4s ease, height 0.4s ease;
}

.messages-sidebar .new-message-btn:hover::before {
    width: 300px;
    height: 300px;
}

.messages-sidebar .new-message-btn:hover {
    background: #6fa050;
    color: #fff;
    text-decoration: none;
    box-shadow: 0 4px 12px rgba(133, 187, 101, 0.4);
    transform: translateY(-2px);
}

.messages-sidebar .new-message-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(133, 187, 101, 0.2);
}

.messages-sidebar .new-message-btn svg {
    width: 20px;
    height: 20px;
}

.messages-sidebar .folder-list {
    list-style: none;
    padding: 0;
    margin: 0;
    overflow: hidden;
    width: 100%;
}

.messages-sidebar .folder-item {
    margin-bottom: 4px;
}

.messages-sidebar .folder-link {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 10px 16px;
    border-radius: 0 24px 24px 0;
    text-decoration: none;
    color: #5f6368;
    font-weight: 500;
    font-size: 14px;
    transition: all 0.2s ease;
    margin-right: 8px;
    position: relative;
}

.messages-sidebar .folder-link::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    background: #85BB65;
    border-radius: 0 4px 4px 0;
    transition: width 0.2s ease, height 0.2s ease;
}

.messages-sidebar .folder-link:hover {
    background: #f1f3f4;
    color: #121C0C;
    text-decoration: none;
    transform: translateX(4px);
}

.messages-sidebar .folder-link:hover::before {
    width: 3px;
    height: 60%;
}

.messages-sidebar .folder-link.active {
    background: #e8f5e9;
    color: #85BB65;
    font-weight: 600;
}

.messages-sidebar .folder-link.active::before {
    width: 3px;
    height: 60%;
}

.messages-sidebar .folder-link.active:hover {
    background: #d4edda;
    color: #6fa050;
}

.messages-sidebar .folder-link svg {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
}

.messages-sidebar .folder-link .badge {
    margin-left: auto;
    background: #85BB65;
    color: #fff;
    font-size: 12px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 12px;
    min-width: 20px;
    text-align: center;
}

.messages-content {
    flex: 1;
    background: #fff;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-width: 0;
    border-top: 1px solid #e6eef6;
    border-bottom: 1px solid #e6eef6;
}

.messages-content-header {
    padding: 12px 20px;
    border-bottom: 1px solid #f1f3f4;
    display: flex;
    align-items: center;
    gap: 16px;
    background: #fff;
    flex-shrink: 0;
}

.messages-content-header .select-all {
    display: flex;
    align-items: center;
    gap: 8px;
}

.messages-content-header .select-all input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #85BB65;
}

.messages-content-header .select-all input[type="checkbox"]:checked {
    background-color: #85BB65;
    border-color: #85BB65;
}

.messages-content-header .select-all label {
    margin: 0;
    font-size: 14px;
    color: #5f6368;
    cursor: pointer;
}

.messages-content-body {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 0;
    background: #fff;
}

.messages-search {
    padding: 12px 20px;
    border-bottom: 1px solid #f1f3f4;
    background: #fff;
    flex-shrink: 0;
}

.messages-search .input-group {
    display: flex;
    gap: 8px;
    align-items: center;
    background: #f1f3f4;
    border-radius: 24px;
    padding: 8px 16px;
    transition: all 0.2s ease;
    width: 100%;
    box-sizing: border-box;
}

.messages-search .input-group:focus-within {
    background: #fff;
    box-shadow: 0 0 0 2px rgba(133, 187, 101, 0.2);
}

.messages-search .input-group svg {
    width: 20px;
    height: 20px;
    color: #5f6368;
    flex-shrink: 0;
}

.messages-search input {
    flex: 1;
    padding: 4px 8px;
    border: none;
    background: transparent;
    border-radius: 0;
    font-size: 14px;
    color: #121C0C;
    min-width: 0;
    width: 100%;
    box-sizing: border-box;
}

.messages-search input:focus {
    outline: none;
}

.messages-search button {
    background: transparent;
    color: #5f6368;
    border: none;
    padding: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
}

.messages-search button:hover {
    color: #121C0C;
}

.messages-list {
    display: flex;
    flex-direction: column;
    gap: 0;
    overflow-x: hidden;
    width: 100%;
}

.message-item {
    background: #fff;
    border-bottom: 1px solid #f1f3f4;
    padding: 14px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.2s ease;
    color: inherit;
    cursor: pointer;
    position: relative;
    min-width: 0;
    width: 100%;
    box-sizing: border-box;
}

.message-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 0;
    background: #85BB65;
    transition: width 0.2s ease;
}

.message-item:hover {
    background: #f8f9fa;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    transform: translateX(2px);
}

.message-item:hover::before {
    width: 3px;
}

.message-item:active {
    transform: translateX(0);
}

.message-item.read {
    background: #fff;
}

.message-item.read .message-sender {
    font-weight: 400;
    color: #5f6368;
}

.message-item.unread {
    background: #fff;
}

.message-item.unread .message-sender {
    font-weight: 600;
    color: #121C0C;
}

.message-item .message-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
    flex-shrink: 0;
    accent-color: #85BB65;
}

.message-item .message-checkbox:checked {
    background-color: #85BB65;
    border-color: #85BB65;
}

.message-item > a {
    flex: 1;
    display: flex;
    align-items: center;
    min-width: 0;
    width: 100%;
    box-sizing: border-box;
    gap: 16px;
    text-decoration: none;
    color: inherit;
}

.message-item > a:hover {
    text-decoration: none;
    color: inherit;
}

.message-avatar {
    width: 48px;
    height: 48px;
    min-width: 48px;
    min-height: 48px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #e6eef6;
}

.message-content {
    flex: 1;
    min-width: 0;
}

.message-sender {
    font-weight: 600;
    font-size: 14px;
    color: #121C0C;
    margin-bottom: 4px;
    line-height: 1.4;
}

.message-text {
    font-size: 14px;
    color: #5f6368;
    line-height: 1.5;
    word-wrap: break-word;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    white-space: nowrap;
    max-width: 100%;
    text-overflow: ellipsis;
}

.message-meta {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 8px;
    min-width: 100px;
}

.message-actions {
    display: flex;
    align-items: center;
    flex-shrink: 0;
    margin-left: 8px;
}

.message-badge {
    background: #85BB65;
    color: #fff;
    font-size: 11px;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 10px;
    white-space: nowrap;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.message-time {
    font-size: 12px;
    color: #5f6368;
    white-space: nowrap;
    font-weight: 400;
}

.message-delete-btn {
    background: transparent;
    border: none;
    padding: 6px;
    cursor: pointer;
    opacity: 0.5;
    transition: all 0.2s ease;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.message-delete-btn:hover {
    opacity: 1;
    background: #fee;
    color: #d32f2f;
    transform: scale(1.1);
}

.message-delete-btn:active {
    transform: scale(0.95);
}

.empty-messages {
    text-align: center;
    padding: 60px 20px;
    color: #6b7280;
}

.empty-messages-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 20px;
    opacity: 0.3;
}

.pagination-wrapper {
    margin-top: 24px;
    display: flex;
    justify-content: center;
}

/* Compose Modal Styles */
.compose-modal {
    position: fixed;
    bottom: 0;
    right: 40px;
    width: 600px;
    max-height: 90vh;
    background: #fff;
    border-radius: 8px 8px 0 0;
    box-shadow: 0 -4px 24px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    z-index: 1000;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid #e6eef6;
    border-bottom: none;
    animation: slideUp 0.3s ease-out;
    overflow: hidden;
}

@keyframes slideUp {
    from {
        transform: translateY(100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.compose-modal.hidden {
    display: none;
}

.compose-modal.minimized {
    height: 48px;
    max-height: 48px;
}

.compose-modal-header {
    background: #404040;
    color: #fff;
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 8px 8px 0 0;
    cursor: move;
    user-select: none;
    flex-shrink: 0;
}

.compose-modal-title {
    font-size: 14px;
    font-weight: 500;
}

.compose-modal-actions {
    display: flex;
    gap: 4px;
    align-items: center;
}

.compose-modal-btn {
    background: transparent;
    border: none;
    color: #fff;
    padding: 6px 8px;
    cursor: pointer;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    min-width: 32px;
    min-height: 32px;
}

.compose-modal-btn:hover {
    background: rgba(255,255,255,0.15);
    transform: scale(1.1);
}

.compose-modal-btn:active {
    transform: scale(0.95);
}

.compose-modal-body {
    display: flex;
    flex-direction: column;
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    min-height: 400px;
    background: #fff;
}

.compose-field {
    padding: 10px 16px;
    border-bottom: 1px solid #f1f3f4;
    display: flex;
    align-items: center;
    flex-shrink: 0;
}

.compose-field input,
.compose-field select {
    width: 100%;
    border: none;
    outline: none;
    font-size: 14px;
    padding: 6px 0;
    color: #121C0C;
    background: transparent;
    font-family: inherit;
}

.compose-field input:focus,
.compose-field select:focus {
    outline: none;
}

.compose-field input::placeholder {
    color: #9aa0a6;
}

.compose-select {
    cursor: pointer;
}

.compose-select option {
    padding: 8px;
}

.compose-editor {
    flex: 1;
    padding: 16px;
    overflow: visible;
    min-height: 200px;
    background: #fff;
    display: flex;
    flex-direction: column;
}

.compose-editor textarea {
    width: 100%;
    min-height: 200px;
    border: none;
    outline: none;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    overflow-y: auto;
    flex: 1;
    color: #121C0C;
    line-height: 1.6;
    padding: 0;
    box-sizing: border-box;
}

.compose-editor textarea::placeholder {
    color: #9aa0a6;
}

.compose-footer {
    padding: 12px 16px;
    border-top: 1px solid #f1f3f4;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fff;
    flex-shrink: 0;
}

.compose-footer-left {
    display: flex;
    align-items: center;
}

.compose-send-btn {
    background: #85BB65;
    color: #fff;
    border: none;
    border-radius: 24px;
    padding: 10px 24px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
    box-shadow: 0 1px 2px rgba(133, 187, 101, 0.2);
}

.compose-send-btn:hover {
    background: #6fa050;
    box-shadow: 0 2px 4px rgba(133, 187, 101, 0.3);
}

.compose-footer-right {
    display: flex;
    gap: 4px;
    align-items: center;
}

.compose-toolbar-btn {
    background: transparent;
    border: none;
    color: #5f6368;
    padding: 8px;
    cursor: pointer;
    border-radius: 4px;
    display: flex;
    align-items: center;
    transition: all 0.2s ease;
    position: relative;
}

.compose-toolbar-btn:hover {
    background: #f1f3f4;
    color: #121C0C;
    transform: scale(1.1);
}

.compose-toolbar-btn:active {
    transform: scale(0.95);
}

/* Templates Dropdown Styling */
.templates-dropdown-wrapper {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #e6eef6;
}

.templates-dropdown-container {
    position: relative;
    z-index: 10;
}

.templates-dropdown-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    width: 100%;
    margin-right: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 16px;
    border-radius: 0 24px 24px 0;
    transition: all 0.2s ease;
    margin-right: 8px;
}

.templates-dropdown-btn:hover {
    background: #f1f3f4;
    color: #121C0C;
}

.templates-dropdown-btn.active .dropdown-arrow {
    transform: rotate(180deg);
}

.templates-dropdown-menu {
    position: fixed;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border: 1px solid #e6eef6;
    padding: 6px;
    z-index: 10000;
    list-style: none;
    margin: 0;
    min-width: 200px;
    max-width: 220px;
    max-height: 350px;
    overflow-y: auto;
}

.templates-dropdown-menu li {
    margin: 0;
    padding: 0;
}

.templates-dropdown-menu .template-item {
    display: block;
    padding: 8px 10px;
    border-radius: 6px;
    transition: all 0.2s ease;
    cursor: pointer;
    margin-bottom: 2px;
    text-decoration: none;
    color: inherit;
}

.templates-dropdown-menu .template-item:hover {
    background: #F4F9F1;
    color: #121C0C;
}

.templates-dropdown-menu .template-item:active {
    background: #e8f5e9;
}

/* Scrollbar for dropdown */
.templates-dropdown-menu::-webkit-scrollbar {
    width: 6px;
}

.templates-dropdown-menu::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 4px;
}

.templates-dropdown-menu::-webkit-scrollbar-track {
    background: transparent;
}
</style>

<div class="email-app-wrapper">
    <div class="email-app-container">
        <!-- Messages Page -->
        <div class="messages-page">
    <div class="messages-header">
        <h6>Messages</h6>
    </div>

    <div class="messages-container">
        <!-- Sidebar -->
        <div class="messages-sidebar">
            <button type="button" class="new-message-btn" onclick="openComposeModal()">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span>Compose</span>
            </button>
            
            <ul class="folder-list">
                <li class="folder-item">
                    <a href="{{ path('app_provider_messages', {'type': 'inbox'}) }}" 
                       class="folder-link {% if app.request.get('type') == '' or app.request.get('type') == 'inbox' %}active{% endif %}">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 13H21L20 7H4L3 13ZM3 13L2 19H22L21 13M9 17H15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <span>Inbox</span>
                        <span class="badge">3</span>
                    </a>
                </li>
                <li class="folder-item">
                    <a href="{{ path('app_provider_messages', {'type': 'sent'}) }}" 
                       class="folder-link {% if app.request.get('type') == 'sent' %}active{% endif %}">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>Sent</span>
                    </a>
                </li>
                <li class="folder-item">
                    <a href="{{ path('app_provider_messages', {'type': 'drafts'}) }}" 
                       class="folder-link {% if app.request.get('type') == 'drafts' %}active{% endif %}" onclick="showDrafts(event)">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 7V5C3 3.89543 3.89543 3 5 3H19C20.1046 3 21 3.89543 21 5V7M3 7L5 21H19L21 7M3 7H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>Drafts</span>
                        <span class="badge" id="drafts-count" style="display: none;">0</span>
                    </a>
                </li>
                <li class="folder-item">
                    <a href="{{ path('app_provider_messages', {'type': 'trash'}) }}" 
                       class="folder-link {% if app.request.get('type') == 'trash' %}active{% endif %}" onclick="showTrash(event)">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 6H5H21M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>Trash</span>
                        <span class="badge" id="trash-count" style="display: none;">0</span>
                    </a>
                </li>
            </ul>

            <!-- Email Templates Dropdown -->
            <div class="templates-dropdown-wrapper">
                <div class="templates-dropdown-container">
                    <button class="folder-link templates-dropdown-btn" type="button" id="templatesDropdownBtn">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 20px; height: 20px;">
                                <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M16 13H8M16 17H8M10 9H8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            <span>Email Templates</span>
                        </div>
                        <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px; margin-left: auto; transition: transform 0.2s ease;">
                            <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <ul class="templates-dropdown-menu" id="templatesDropdownMenu" style="display: none;">
                        <li>
                            <a class="template-item" href="javascript:void(0);" data-template="request">
                                <div style="font-weight: 500; color: #121C0C; font-size: 13px; line-height: 1.3;">Quick Check-in</div>
                                <div style="font-size: 11px; color: #6b7280; margin-top: 2px; line-height: 1.3;">Follow up on opportunity</div>
                            </a>
                        </li>
                        <li>
                            <a class="template-item" href="javascript:void(0);" data-template="thank">
                                <div style="font-weight: 500; color: #121C0C; font-size: 13px; line-height: 1.3;">Thank You</div>
                                <div style="font-size: 11px; color: #6b7280; margin-top: 2px; line-height: 1.3;">Thank for conversation</div>
                            </a>
                        </li>
                        <li>
                            <a class="template-item" href="javascript:void(0);" data-template="follow">
                                <div style="font-weight: 500; color: #121C0C; font-size: 13px; line-height: 1.3;">Follow Up</div>
                                <div style="font-size: 11px; color: #6b7280; margin-top: 2px; line-height: 1.3;">Following up on role</div>
                            </a>
                        </li>
                        <li>
                            <a class="template-item" href="javascript:void(0);" data-template="details">
                                <div style="font-weight: 500; color: #121C0C; font-size: 13px; line-height: 1.3;">Request Details</div>
                                <div style="font-size: 11px; color: #6b7280; margin-top: 2px; line-height: 1.3;">Request additional info</div>
                            </a>
                        </li>
                        <li>
                            <a class="template-item" href="javascript:void(0);" data-template="review">
                                <div style="font-weight: 500; color: #121C0C; font-size: 13px; line-height: 1.3;">Feedback</div>
                                <div style="font-size: 11px; color: #6b7280; margin-top: 2px; line-height: 1.3;">Share process feedback</div>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Messages Content -->
        <div class="messages-content">
            <!-- Search -->
            <div class="messages-search">
                <form action="" method="get" class="input-group">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
                        <path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <input type="text" name="keyword" class="form-control" 
                           placeholder="Search in messages" 
                           value="{{ app.request.get('keyword') }}">
                    {% if app.request.get('type') %}
                        <input type="hidden" name="type" value="{{ app.request.get('type') }}">
                    {% endif %}
                    <button type="submit" class="btn">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 18L18 6M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                </form>
            </div>
            
            <!-- Content Header -->
            <div class="messages-content-header">
                <div class="select-all">
                    <input type="checkbox" id="select-all-checkbox">
                    <label for="select-all-checkbox">Select all</label>
                </div>
            </div>
            
            <!-- Messages List -->
            <div class="messages-content-body">

                {% if messages|length > 0 %}
                    <div class="messages-list">
                        {% for message in messages %}
                            {% set senderName = app.request.get('type') == 'sent' ? message.receiver.name|default(message.receiver.email) : message.sender.name|default(message.sender.email) %}
                            {% set senderAvatar = app.request.get('type') == 'sent' 
                                ? (message.receiver.profilePictureFilename ? '/uploads/' ~ message.receiver.id ~ '/' ~ message.receiver.profilePictureFilename : asset('assets/img/user-image.png'))
                                : (message.sender.profilePictureFilename ? '/uploads/' ~ message.sender.id ~ '/' ~ message.sender.profilePictureFilename : asset('assets/img/user-image.png')) %}
                            {% set isRead = message.seen|default(false) %}
                            {% set messageText = message.text|striptags|slice(0, 100) %}
                            
                            <div class="message-item {% if not isRead %}unread{% else %}read{% endif %}">
                                <input type="checkbox" class="message-checkbox" data-message-id="{{ message.id }}">
                                <a href="{{ path('app_provider_message_show', {'id': message.id}) }}" style="display: flex; align-items: center; gap: 16px; flex: 1; text-decoration: none; color: inherit;">
                                    <img src="{{ senderAvatar }}" alt="{{ senderName }}" class="message-avatar">
                                    <div class="message-content">
                                        <div class="message-sender">{{ senderName }}</div>
                                        <div class="message-text">{{ messageText|raw }}{% if message.text|striptags|length > 100 %}...{% endif %}</div>
                                    </div>
                                    <div class="message-meta">
                                        {% if not isRead and app.request.get('type') != 'sent' %}
                                            <span class="message-badge">New</span>
                                        {% endif %}
                                        <div class="message-time">{{ message.createdAt|time_diff }}</div>
                                    </div>
                                </a>
                                <div class="message-actions">
                                    <button type="button" 
                                            onclick="deleteMessage('{{ message.id }}', this)"
                                            class="message-delete-btn"
                                            data-csrf="{{ csrf_token('delete' ~ message.id) }}"
                                            title="Delete message">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M3 6H5H21M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Pagination -->
                    {% if messages.nbPages > 1 %}
                        <div class="pagination-wrapper">
                            {{ pagerfanta(messages, 'twitter_bootstrap5') }}
                        </div>
                    {% endif %}
                {% else %}
                    <div class="empty-messages">
                        <svg class="empty-messages-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 13H21L20 7H4L3 13ZM3 13L2 19H22L21 13M9 17H15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <p>No messages found.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="right-sidebar">
            <a href="{{ path('app_provider_interview_calendar') }}" 
               class="sidebar-icon calendar {% if app.request.get('_route') == 'app_provider_interview_calendar' %}active{% endif %}" 
               data-tooltip="Calendar"
               onmouseover="this.setAttribute('title', '');"
               onmouseout="this.setAttribute('title', 'Calendar');">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                    <path d="M16 2V6M8 2V6M3 10H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M8 14H8.01M12 14H12.01M16 14H16.01M8 18H8.01M12 18H12.01M16 18H16.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </a>
            <a href="{{ path('app_provider_jobs_applications') }}?status=interview" 
               class="sidebar-icon interview {% if app.request.get('status') == 'interview' %}active{% endif %}" 
               data-tooltip="Interview Links"
               onmouseover="this.setAttribute('title', '');"
               onmouseout="this.setAttribute('title', 'Interview Links');">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M17 20H22V18C22 16.3431 20.6569 15 19 15C18.0444 15 17.1931 15.4468 16.6438 16.1429M17 20H7M17 20V18C17 15.2386 14.7614 13 12 13C9.23858 13 7 15.2386 7 18V20M7 20H2V18C2 16.3431 3.34315 15 5 15C5.95561 15 6.80686 15.4468 7.35625 16.1429M15 7C15 9.20914 13.2091 11 11 11C8.79086 11 7 9.20914 7 7C7 4.79086 8.79086 3 11 3C13.2091 3 15 4.79086 15 7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </a>
            <a href="{{ path('app_provider_documents') }}" 
               class="sidebar-icon document {% if app.request.get('_route') == 'app_provider_documents' %}active{% endif %}" 
               data-tooltip="Document Center"
               onmouseover="this.setAttribute('title', '');"
               onmouseout="this.setAttribute('title', 'Document Center');">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M16 13H8M16 17H8M10 9H8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </a>
        </div>
    </div>
</div>

<!-- Compose Modal -->
<div id="compose-modal" class="compose-modal hidden">
        <div class="compose-modal-header">
            <span class="compose-modal-title">New Message</span>
            <div class="compose-modal-actions">
                <button type="button" class="compose-modal-btn" onclick="minimizeComposeModal()" title="Minimize">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
                <button type="button" class="compose-modal-btn" onclick="closeComposeModal()" title="Close">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
        </div>
        <form id="compose-form" action="{{ path('app_provider_messages_new') }}" method="post" enctype="multipart/form-data" class="compose-modal-body">
            <div class="compose-field">
                <select name="receiver" id="compose-receiver" class="compose-select" required>
                    <option value="">-- Select Employer --</option>
                </select>
            </div>
            <div class="compose-field">
                <input type="text" name="subject" id="compose-subject" placeholder="Subject">
            </div>
            <div class="compose-editor">
                <textarea name="message" id="compose-message" placeholder="Compose email" required></textarea>
            </div>
            <div class="compose-footer">
                <div class="compose-footer-left">
                    <button type="submit" class="compose-send-btn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Send
                    </button>
                </div>
                <div class="compose-footer-right">
                    <button type="button" class="compose-toolbar-btn" onclick="document.getElementById('compose-attachment').click()" title="Attach files">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <input type="file" id="compose-attachment" name="attachment" style="display: none;" multiple>
                    <button type="button" class="compose-toolbar-btn" title="More options">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 13C12.5523 13 13 12.5523 13 12C13 11.4477 12.5523 11 12 11C11.4477 11 11 11.4477 11 12C11 12.5523 11.4477 13 12 13Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 6C12.5523 6 13 5.55228 13 5C13 4.44772 12.5523 4 12 4C11.4477 4 11 4.44772 11 5C11 5.55228 11.4477 6 12 6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 20C12.5523 20 13 19.5523 13 19C13 18.4477 12.5523 18 12 18C11.4477 18 11 18.4477 11 19C11 19.5523 11.4477 20 12 20Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <button type="button" class="compose-toolbar-btn" onclick="deleteCurrentDraft()" title="Delete draft">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 6H5H21M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </form>
    </div>
{% endblock %}

{% block footer_scripts %}
<script>
let isDragging = false;
let currentX;
let currentY;
let initialX;
let initialY;
let xOffset = 0;
let yOffset = 0;

const composeModal = document.getElementById('compose-modal');
const composeHeader = composeModal?.querySelector('.compose-modal-header');

// Helper function to auto-resize textarea
function autoResizeTextarea(textarea) {
    if (!textarea) return;
    
    // Reset height to auto to get accurate scrollHeight
    textarea.style.height = 'auto';
    
    // Calculate new height based on content
    const scrollHeight = textarea.scrollHeight;
    const minHeight = 200;
    const maxHeight = window.innerHeight * 0.5; // Max 50% of viewport height
    const newHeight = Math.min(Math.max(scrollHeight + 10, minHeight), maxHeight);
    
    // Set new height
    textarea.style.height = newHeight + 'px';
    
    // Scroll to top to show the beginning
    textarea.scrollTop = 0;
}

function openComposeModal() {
    const modal = document.getElementById('compose-modal');
    if (!modal) return;
    
    modal.classList.remove('hidden');
    modal.classList.remove('minimized');
    
    // Reset position
    xOffset = 0;
    yOffset = 0;
    modal.style.transform = 'translate(0, 0)';
    
    // Ensure body is visible
    const body = modal.querySelector('.compose-modal-body');
    if (body) {
        body.style.display = 'flex';
    }
    
    // Load employers
    loadEmployers();
    
    // Auto-resize textarea if it has content
    const messageTextarea = document.getElementById('compose-message');
    if (messageTextarea && messageTextarea.value) {
        setTimeout(() => {
            autoResizeTextarea(messageTextarea);
        }, 50);
    }
}

function closeComposeModal(skipAutoSave = false) {
    const modal = document.getElementById('compose-modal');
    const form = document.getElementById('compose-form');
    const receiver = document.getElementById('compose-receiver')?.value || '';
    const subject = document.getElementById('compose-subject')?.value || '';
    const message = document.getElementById('compose-message')?.value || '';
    
    // Auto-save to drafts if there's content (unless explicitly skipped)
    if (!skipAutoSave && (receiver || subject || message)) {
        saveDraft(receiver, subject, message);
    }
    
    modal.classList.add('hidden');
    // Reset form
    if (form) {
        form.reset();
    }
    updateDraftsCount();
}

function minimizeComposeModal() {
    const modal = document.getElementById('compose-modal');
    modal.classList.toggle('minimized');
    if (modal.classList.contains('minimized')) {
        modal.querySelector('.compose-modal-body').style.display = 'none';
    } else {
        modal.querySelector('.compose-modal-body').style.display = 'flex';
    }
}

// Make modal draggable
if (composeHeader) {
    composeHeader.addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', dragEnd);
}

function dragStart(e) {
    if (e.target.closest('.compose-modal-btn')) {
        return; // Don't drag if clicking on buttons
    }
    
    initialX = e.clientX - xOffset;
    initialY = e.clientY - yOffset;

    if (e.target === composeHeader || composeHeader.contains(e.target)) {
        isDragging = true;
    }
}

function drag(e) {
    if (isDragging) {
        e.preventDefault();
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;

        xOffset = currentX;
        yOffset = currentY;

        setTranslate(currentX, currentY, composeModal);
    }
}

function dragEnd(e) {
    initialX = currentX;
    initialY = currentY;
    isDragging = false;
}

function setTranslate(xPos, yPos, el) {
    el.style.transform = `translate(${xPos}px, ${yPos}px)`;
}

// Handle form submission
document.getElementById('compose-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const button = this.querySelector('.compose-send-btn');
    const originalText = button.innerHTML;
    
    // Clear draft when sending
    const receiver = document.getElementById('compose-receiver').value;
    const subject = document.getElementById('compose-subject').value;
    const message = document.getElementById('compose-message').value;
    clearCurrentDraft(receiver, subject, message);
    
    button.disabled = true;
    button.innerHTML = '<span>Sending...</span>';
    
    try {
        const response = await fetch(this.action, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            // Check if response is JSON or HTML redirect
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                const result = await response.json();
                if (result.success) {
                    closeComposeModal();
                    if (typeof showToast === 'function') {
                        showToast('success', 'Message sent successfully');
                    } else {
                        alert('Message sent successfully');
                    }
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    alert(result.error || 'Failed to send message');
                }
            } else {
                // HTML response - likely a redirect, reload the page
                closeComposeModal();
                if (typeof showToast === 'function') {
                    showToast('success', 'Message sent successfully');
                }
                setTimeout(() => window.location.reload(), 1000);
            }
        } else {
            alert('Failed to send message');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while sending the message');
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
});

function clearCurrentDraft(receiver, subject, message) {
    const drafts = JSON.parse(localStorage.getItem('message_drafts') || '[]');
    const filtered = drafts.filter(d => 
        !(d.receiver === receiver && d.subject === subject && d.message === message)
    );
    localStorage.setItem('message_drafts', JSON.stringify(filtered));
    updateDraftsCount();
}

function deleteCurrentDraft() {
    const receiver = document.getElementById('compose-receiver')?.value || '';
    const subject = document.getElementById('compose-subject')?.value || '';
    const message = document.getElementById('compose-message')?.value || '';
    
    if (receiver || subject || message) {
        if (confirm('Delete this draft?')) {
            clearCurrentDraft(receiver, subject, message);
            closeComposeModal(true); // Skip auto-save when deleting
        }
    } else {
        closeComposeModal(true);
    }
}

// Load employers when modal opens
async function loadEmployers() {
    try {
        const response = await fetch('{{ path('app_provider_messages_new') }}');
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const select = doc.querySelector('select[name="receiver"]');
        
        if (select) {
            const composeSelect = document.getElementById('compose-receiver');
            composeSelect.innerHTML = select.innerHTML;
        }
    } catch (error) {
        console.error('Error loading employers:', error);
    }
}

// Drafts and Trash functionality
function saveDraft(receiver, subject, message) {
    const drafts = JSON.parse(localStorage.getItem('message_drafts') || '[]');
    const draft = {
        id: Date.now(),
        receiver: receiver || '',
        subject: subject || '',
        message: message || '',
        timestamp: new Date().toISOString()
    };
    drafts.unshift(draft);
    // Keep only last 50 drafts
    if (drafts.length > 50) {
        drafts.pop();
    }
    localStorage.setItem('message_drafts', JSON.stringify(drafts));
    updateDraftsCount();
}

function loadDraft(draftId) {
    const drafts = JSON.parse(localStorage.getItem('message_drafts') || '[]');
    const draft = drafts.find(d => d.id === draftId);
    if (draft) {
        document.getElementById('compose-receiver').value = draft.receiver || '';
        document.getElementById('compose-subject').value = draft.subject || '';
        document.getElementById('compose-message').value = draft.message || '';
        openComposeModal();
    }
}

function deleteDraft(draftId) {
    const drafts = JSON.parse(localStorage.getItem('message_drafts') || '[]');
    const filtered = drafts.filter(d => d.id !== draftId);
    localStorage.setItem('message_drafts', JSON.stringify(filtered));
    updateDraftsCount();
    if (document.getElementById('drafts-container')) {
        showDrafts();
    }
}

function showDrafts(event) {
    if (event) {
        event.preventDefault();
    }
    // Update URL without reload
    const url = new URL(window.location);
    url.searchParams.set('type', 'drafts');
    window.history.pushState({}, '', url);
    const drafts = JSON.parse(localStorage.getItem('message_drafts') || '[]');
    const container = document.querySelector('.messages-content-body');
    
    // Hide search and select all when showing drafts
    document.querySelector('.messages-search')?.style.setProperty('display', 'none');
    document.querySelector('.messages-content-header')?.style.setProperty('display', 'none');
    
    if (drafts.length === 0) {
        container.innerHTML = `
            <div class="empty-messages">
                <svg class="empty-messages-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 7V5C3 3.89543 3.89543 3 5 3H19C20.1046 3 21 3.89543 21 5V7M3 7L5 21H19L21 7M3 7H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <p>No drafts found.</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="messages-list">';
    drafts.forEach(draft => {
        const date = new Date(draft.timestamp);
        const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        html += `
            <div class="message-item">
                <div style="display: flex; align-items: center; gap: 12px; flex: 1; cursor: pointer;" onclick="loadDraft(${draft.id})">
                    <div class="message-content" style="flex: 1;">
                        <div class="message-sender">${escapeHtml(draft.subject) || '(No subject)'}</div>
                        <div class="message-text">${escapeHtml(draft.message.substring(0, 100))}${draft.message.length > 100 ? '...' : ''}</div>
                    </div>
                    <div class="message-meta">
                        <div class="message-time">${dateStr}</div>
                    </div>
                </div>
                <div class="message-actions">
                    <button class="message-delete-btn" onclick="event.stopPropagation(); deleteDraft(${draft.id})" title="Delete draft">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 6H5H21M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function showTrash(event) {
    if (event) {
        event.preventDefault();
    }
    // Update URL without reload
    const url = new URL(window.location);
    url.searchParams.set('type', 'trash');
    window.history.pushState({}, '', url);
    const trash = JSON.parse(localStorage.getItem('message_trash') || '[]');
    const container = document.querySelector('.messages-content-body');
    
    // Hide search and select all when showing trash
    document.querySelector('.messages-search')?.style.setProperty('display', 'none');
    document.querySelector('.messages-content-header')?.style.setProperty('display', 'none');
    
    if (trash.length === 0) {
        container.innerHTML = `
            <div class="empty-messages">
                <svg class="empty-messages-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 6H5H21M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <p>Trash is empty.</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="messages-list">';
    trash.forEach(item => {
        const date = new Date(item.timestamp);
        const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        html += `
            <div class="message-item">
                <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                    <div class="message-content" style="flex: 1;">
                        <div class="message-sender">${escapeHtml(item.subject || item.sender || 'Deleted Message')}</div>
                        <div class="message-text">${item.message ? escapeHtml(item.message.substring(0, 100)) + (item.message.length > 100 ? '...' : '') : ''}</div>
                    </div>
                    <div class="message-meta">
                        <div class="message-time">${dateStr}</div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function updateDraftsCount() {
    const drafts = JSON.parse(localStorage.getItem('message_drafts') || '[]');
    const trash = JSON.parse(localStorage.getItem('message_trash') || '[]');
    const draftsBadge = document.getElementById('drafts-count');
    const trashBadge = document.getElementById('trash-count');
    
    if (draftsBadge) {
        if (drafts.length > 0) {
            draftsBadge.textContent = drafts.length;
            draftsBadge.style.display = 'block';
        } else {
            draftsBadge.style.display = 'none';
        }
    }
    
    if (trashBadge) {
        if (trash.length > 0) {
            trashBadge.textContent = trash.length;
            trashBadge.style.display = 'block';
        } else {
            trashBadge.style.display = 'none';
        }
    }
}

// Auto-save draft every 30 seconds
let draftAutoSaveInterval;
['compose-receiver', 'compose-subject', 'compose-message'].forEach(id => {
    const element = document.getElementById(id);
    if (element) {
        element.addEventListener('input', function() {
            clearTimeout(draftAutoSaveInterval);
            draftAutoSaveInterval = setTimeout(() => {
                const receiver = document.getElementById('compose-receiver')?.value || '';
                const subject = document.getElementById('compose-subject')?.value || '';
                const message = document.getElementById('compose-message')?.value || '';
                if (receiver || subject || message) {
                    saveDraft(receiver, subject, message);
                }
            }, 30000); // Auto-save after 30 seconds of inactivity
        });
    }
});

// ============================================================================
// UPDATED: AJAX DELETE FUNCTIONALITY AND BULK ACTIONS
// ============================================================================

// Single message delete function (AJAX)
async function deleteMessage(messageId, button) {
    if (!confirm('Are you sure you want to delete this message?')) {
        return;
    }

    const originalContent = button.innerHTML;
    const csrfToken = button.getAttribute('data-csrf');
    
    // Show loading state
    button.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="spinner">
            <path d="M12 2V6M12 18V22M6 12H2M22 12H18M19.07 4.93L16.24 7.76M7.76 16.24L4.93 19.07M19.07 19.07L16.24 16.24M7.76 7.76L4.93 4.93" 
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    `;
    button.disabled = true;

    try {
        const formData = new FormData();
        formData.append('_token', csrfToken);

        const response = await fetch(`/provider/${messageId}/delete`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            // Find the message item and remove it with animation
            const messageItem = button.closest('.message-item');
            messageItem.style.transition = 'all 0.3s ease';
            messageItem.style.opacity = '0';
            messageItem.style.transform = 'translateX(-20px)';
            
            // Remove from DOM after animation
            setTimeout(() => {
                messageItem.remove();
                
                // Show success message
                showToast('success', result.message || 'Message deleted successfully');
                
                // Update message count if needed
                updateMessageCount();
                
            }, 300);
        } else {
            showToast('error', result.message || 'Failed to delete message');
            button.innerHTML = originalContent;
            button.disabled = false;
        }
    } catch (error) {
        console.error('Error deleting message:', error);
        showToast('error', 'An error occurred while deleting the message');
        button.innerHTML = originalContent;
        button.disabled = false;
    }
}

// Bulk delete function
async function deleteMessageBulk(messageId) {
    try {
        const csrfToken = document.querySelector(`[data-message-id="${messageId}"]`)?.closest('.message-item')
            .querySelector('.message-delete-btn')?.getAttribute('data-csrf');
        
        if (!csrfToken) {
            console.error('CSRF token not found for message:', messageId);
            return false;
        }

        const formData = new FormData();
        formData.append('_token', csrfToken);

        const response = await fetch(`/provider/${messageId}/delete`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            // Find and remove the message item with animation
            const messageItem = document.querySelector(`[data-message-id="${messageId}"]`)?.closest('.message-item');
            if (messageItem) {
                messageItem.style.transition = 'all 0.3s ease';
                messageItem.style.opacity = '0';
                messageItem.style.transform = 'translateX(-20px)';
                
                setTimeout(() => {
                    if (messageItem.parentElement) {
                        messageItem.remove();
                    }
                }, 300);
            }
            return true;
        } else {
            console.error('Delete failed for message:', messageId, result.message);
            return false;
        }
    } catch (error) {
        console.error('Error deleting message:', messageId, error);
        return false;
    }
}

// Bulk mark as read function
async function markAsReadBulk(messageId) {
    try {
        const response = await fetch(`/provider/${messageId}/mark-read`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const result = await response.json();

        if (result.success) {
            // Update UI
            const messageItem = document.querySelector(`[data-message-id="${messageId}"]`)?.closest('.message-item');
            if (messageItem) {
                messageItem.classList.remove('unread');
                messageItem.classList.add('read');
                
                // Remove "New" badge if present
                const badge = messageItem.querySelector('.message-badge');
                if (badge) {
                    badge.remove();
                }
            }
            return true;
        } else {
            console.error('Mark as read failed for message:', messageId);
            return false;
        }
    } catch (error) {
        console.error('Error marking message as read:', messageId, error);
        return false;
    }
}

// UPDATED: Bulk action buttons functionality
document.getElementById('delete-btn')?.addEventListener('click', async function() {
    const selected = Array.from(document.querySelectorAll('.message-checkbox:checked')).map(cb => cb.dataset.messageId);
    if (selected.length === 0) {
        showToast('error', 'Please select at least one message');
        return;
    }
    
    if (confirm(`Are you sure you want to delete ${selected.length} message(s)?`)) {
        const button = this;
        const originalText = button.innerHTML;
        
        // Show loading state
        button.disabled = true;
        button.innerHTML = '<span class="loading-spinner"></span> Deleting...';
        
        try {
            // Delete messages sequentially to avoid overwhelming the server
            let successCount = 0;
            for (const messageId of selected) {
                const success = await deleteMessageBulk(messageId);
                if (success) successCount++;
            }
            
            if (successCount > 0) {
                showToast('success', `Successfully deleted ${successCount} message(s)`);
                updateMessageCount();
            }
            
            if (successCount < selected.length) {
                showToast('warning', `${selected.length - successCount} message(s) could not be deleted`);
            }
            
        } catch (error) {
            console.error('Error deleting messages:', error);
            showToast('error', 'Some messages could not be deleted');
        } finally {
            button.disabled = false;
            button.innerHTML = originalText;
            
            // Uncheck select all checkbox
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
            }
            
            // Hide bulk actions
            toggleBulkActions(false);
        }
    }
});

document.getElementById('mark-read-btn')?.addEventListener('click', async function() {
    const selected = Array.from(document.querySelectorAll('.message-checkbox:checked')).map(cb => cb.dataset.messageId);
    if (selected.length === 0) {
        showToast('error', 'Please select at least one message');
        return;
    }
    
    const button = this;
    const originalText = button.innerHTML;
    
    // Show loading state
    button.disabled = true;
    button.innerHTML = '<span class="loading-spinner"></span> Marking...';
    
    try {
        // Mark messages as read sequentially
        const results = await Promise.allSettled(
            selected.map(messageId => markAsReadBulk(messageId))
        );
        
        const successful = results.filter(result => result.status === 'fulfilled').length;
        
        if (successful > 0) {
            showToast('success', `Marked ${successful} message(s) as read`);
        }
        
        if (successful < selected.length) {
            showToast('warning', `${selected.length - successful} message(s) could not be marked as read`);
        }
        
    } catch (error) {
        console.error('Error marking messages as read:', error);
        showToast('error', 'An error occurred while marking messages as read');
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
        
        // Uncheck select all checkbox
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = false;
        }
        
        // Hide bulk actions
        toggleBulkActions(false);
    }
});

// Update select all checkbox functionality
document.getElementById('select-all-checkbox')?.addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.message-checkbox');
    const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
    
    checkboxes.forEach(cb => cb.checked = this.checked);
    
    // Show/hide bulk action buttons based on selection
    toggleBulkActions(anyChecked || this.checked);
});

// Individual checkbox change handler
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('message-checkbox')) {
        const anyChecked = Array.from(document.querySelectorAll('.message-checkbox')).some(cb => cb.checked);
        toggleBulkActions(anyChecked);
        
        // Update select all checkbox state
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        if (selectAllCheckbox) {
            const allCheckboxes = document.querySelectorAll('.message-checkbox');
            const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
            const someChecked = Array.from(allCheckboxes).some(cb => cb.checked);
            
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = someChecked && !allChecked;
        }
    }
});

// Toggle bulk action buttons visibility
function toggleBulkActions(show) {
    const deleteBtn = document.getElementById('delete-btn');
    const markReadBtn = document.getElementById('mark-read-btn');
    
    if (deleteBtn) {
        deleteBtn.style.display = show ? 'inline-block' : 'none';
    }
    if (markReadBtn) {
        markReadBtn.style.display = show ? 'inline-block' : 'none';
    }
}

// Update message count (optional)
function updateMessageCount() {
    const messageItems = document.querySelectorAll('.message-item');
    const emptyState = document.querySelector('.empty-messages');
    
    if (messageItems.length === 0 && emptyState) {
        emptyState.style.display = 'block';
    }
    
    // Update badge counts if you have them
    const inboxBadge = document.querySelector('.folder-link[href*="inbox"] .badge');
    if (inboxBadge) {
        const currentCount = parseInt(inboxBadge.textContent) || 0;
        if (currentCount > 0) {
            inboxBadge.textContent = currentCount - 1;
        }
    }
}

// Toast notification function
function showToast(type, message) {
    // If you have an existing toast system, use it
    if (typeof window.showToast === 'function') {
        window.showToast(type, message);
        return;
    }
    
    // Simple toast implementation
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <span class="toast-message">${message}</span>
            <button class="toast-close" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    // Add styles if not already present
    if (!document.querySelector('#toast-styles')) {
        const styles = document.createElement('style');
        styles.id = 'toast-styles';
        styles.textContent = `
            .toast-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                border-left: 4px solid #85BB65;
                z-index: 10000;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            }
            .toast-error { border-left-color: #dc3545; }
            .toast-success { border-left-color: #85BB65; }
            .toast-warning { border-left-color: #ffc107; }
            .toast-content {
                padding: 12px 16px;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            .toast-message {
                font-size: 14px;
                color: #121C0C;
            }
            .toast-close {
                background: none;
                border: none;
                font-size: 18px;
                cursor: pointer;
                margin-left: 10px;
                color: #6b7280;
            }
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            .loading-spinner {
                display: inline-block;
                width: 14px;
                height: 14px;
                border: 2px solid currentColor;
                border-radius: 50%;
                border-top-color: transparent;
                animation: spin 1s ease-in-out infinite;
                margin-right: 6px;
            }
            .spinner {
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(styles);
    }
    
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}

// Initialize - hide bulk actions by default
document.addEventListener('DOMContentLoaded', function() {
    toggleBulkActions(false);
});

// ============================================================================
// END OF UPDATED FUNCTIONALITY
// ============================================================================

// Email Templates Configuration
const emailTemplates = {
    request: {
        subject: () => 'Quick check-in on this opportunity',
        message: () => `Hi there,\n\nI hope you're doing well. I'm reaching out to check in on this opportunity. I'm still very interested and would be happy to provide any additional information you might need from me.\n\nThanks so much for your time!\n\nBest,\n[YOUR NAME]`
    },
    thank: {
        subject: () => 'Thank you for the conversation',
        message: () => `Hi there,\n\nThank you again for the time you spent discussing this position. I appreciated the conversation and learning more about the team.\n\nIf there's anything else you need from me, please let me knowI'm excited about the opportunity.\n\nWarm regards,\n[YOUR NAME]`
    },
    follow: {
        subject: () => 'Following up on this opportunity',
        message: () => `Hi there,\n\nI wanted to follow up regarding this role. I'm still very enthusiastic about the opportunity and happy to share any additional information that would be helpful.\n\nThanks again for your time and consideration.\n\nBest,\n[YOUR NAME]`
    },
    details: {
        subject: () => 'Request for additional details',
        message: () => `Hi there,\n\nThanks for the update on this role. Could you share any additional details or next steps so I can prepare accordingly?\n\nI appreciate the guidance and look forward to hearing from you.\n\nBest regards,\n[YOUR NAME]`
    },
    review: {
        subject: () => 'Feedback on the process',
        message: () => `Hi there,\n\nI wanted to share feedback on the recent process. Below are a few notes that might be helpful. Please feel free to edit or add your own comments.\n\n[Add your review or feedback here]\n\nThank you for the experience!\n\nBest,\n[YOUR NAME]`
    }
};

// Auto-resize textarea on input
document.addEventListener('DOMContentLoaded', function() {
    const messageTextarea = document.getElementById('compose-message');
    if (messageTextarea) {
        messageTextarea.addEventListener('input', function() {
            autoResizeTextarea(this);
        });
    }
});

// Handle template dropdown toggle
document.addEventListener('DOMContentLoaded', function() {
    const dropdownBtn = document.getElementById('templatesDropdownBtn');
    const dropdownMenu = document.getElementById('templatesDropdownMenu');
    const dropdownContainer = document.querySelector('.templates-dropdown-container');
    
    if (dropdownBtn && dropdownMenu && dropdownContainer) {
        // Function to position dropdown
        function positionDropdown() {
            const rect = dropdownBtn.getBoundingClientRect();
            dropdownMenu.style.top = (rect.bottom + 4) + 'px';
            dropdownMenu.style.left = rect.left + 'px';
            dropdownMenu.style.width = rect.width + 'px';
        }
        
        // Toggle dropdown
        dropdownBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            const isOpen = dropdownMenu.style.display === 'block';
            
            if (!isOpen) {
                positionDropdown();
                dropdownMenu.style.display = 'block';
                dropdownBtn.classList.add('active');
            } else {
                dropdownMenu.style.display = 'none';
                dropdownBtn.classList.remove('active');
            }
        });
        
        // Reposition on scroll/resize
        window.addEventListener('scroll', function() {
            if (dropdownMenu.style.display === 'block') {
                positionDropdown();
            }
        }, true);
        
        window.addEventListener('resize', function() {
            if (dropdownMenu.style.display === 'block') {
                positionDropdown();
            }
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!dropdownBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
                dropdownMenu.style.display = 'none';
                dropdownBtn.classList.remove('active');
            }
        });
        
        // Handle template selection
        document.querySelectorAll('.template-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const templateType = this.dataset.template;
                const template = emailTemplates[templateType];
                
                if (!template) return;
                
                // Close dropdown
                dropdownMenu.style.display = 'none';
                dropdownBtn.classList.remove('active');
                
                // Open compose modal
                openComposeModal();
                
                // Populate with template data
                setTimeout(() => {
                    const subjectInput = document.getElementById('compose-subject');
                    const messageTextarea = document.getElementById('compose-message');
                    
                    if (subjectInput) {
                        subjectInput.value = template.subject();
                    }
                    
                    if (messageTextarea) {
                        const templateMessage = template.message();
                        messageTextarea.value = templateMessage;
                        
                        // Auto-resize textarea to fit content
                        setTimeout(() => {
                            autoResizeTextarea(messageTextarea);
                        }, 150);
                    }
                }, 100);
            });
        });
    }
});

// Handle drafts/trash navigation
if (window.location.search.includes('type=drafts')) {
    showDrafts();
} else if (window.location.search.includes('type=trash')) {
    showTrash();
} else {
    // Show search and header for inbox/sent
    document.querySelector('.messages-search')?.style.setProperty('display', 'block');
    document.querySelector('.messages-content-header')?.style.setProperty('display', 'flex');
}

// Restore search/header when navigating back to inbox/sent
document.querySelectorAll('.folder-link').forEach(link => {
    if (link.href && (link.href.includes('type=inbox') || link.href.includes('type=sent') || (!link.href.includes('type=')))) {
        link.addEventListener('click', function() {
            setTimeout(() => {
                document.querySelector('.messages-search')?.style.setProperty('display', 'block');
                document.querySelector('.messages-content-header')?.style.setProperty('display', 'flex');
            }, 100);
        });
    }
});
</script>
{% endblock %}