{% extends 'provider/base.html.twig' %}

{% block title %}Messages{% endblock %}

{% block provider_body %}
<style>
* {
    box-sizing: border-box;
}

body {
    overflow-x: hidden;
}

/* Override parent container padding */
.app-content {
    padding: 32px 0 !important;
    margin: 0 !important;
    max-width: 100% !important;
    display: flex !important;
    justify-content: center !important;
    background: #f5f7fa !important;
}

/* Override any container padding */
.container-xl,
.container-fluid,
.container,
.app-wrapper {
    padding-left: 0 !important;
    padding-right: 0 !important;
    margin-left: auto !important;
    margin-right: auto !important;
    max-width: 100% !important;
}

/* Main wrapper - centered in viewport */
.email-app-wrapper {
    height: calc(100vh - 60px);
    display: flex;
    justify-content: center;
    align-items: stretch;
    padding: 0 !important;
    margin: 0 auto !important;
    background: #fff;
    width: calc(100% - 48px);
    max-width: 1400px;
    overflow: hidden;
    position: relative;
    border: 1px solid #e6eef6;
    border-radius: 16px;
    box-shadow: 0 12px 30px rgba(17, 24, 39, 0.08);
}

.email-app-container {
    width: 100%;
    display: flex;
    gap: 0;
    height: 100%;
    align-items: stretch;
    padding: 0 !important;
    margin: 0 !important;
    overflow: hidden;
    min-width: 0;
    background: #fff;
    border-radius: 16px;
}

/* Right Sidebar */
.right-sidebar {
    width: 88px;
    background: #fff;
    border-radius: 0 16px 16px 0;
    padding: 24px 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    box-shadow: none;
    flex-shrink: 0;
    position: relative;
    order: 2;
    border-left: 1px solid #e6eef6;
    height: 100%;
}

.sidebar-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    text-decoration: none;
}

.sidebar-icon:hover {
    background: #f1f3f4;
    transform: scale(1.08);
}

.sidebar-icon:active {
    transform: scale(0.95);
}

.sidebar-icon.active {
    background: #e8f5e9;
}

.sidebar-icon.active::after {
    content: '';
    position: absolute;
    right: -20px;
    top: 50%;
    transform: translateY(-50%);
    width: 3px;
    height: 32px;
    background: #85BB65;
    border-radius: 2px 0 0 2px;
}

.sidebar-icon svg {
    width: 28px;
    height: 28px;
}

.sidebar-icon.calendar svg {
    color: #1a73e8;
}

.sidebar-icon.interview svg {
    color: #ea4335;
}

.sidebar-icon.document svg {
    color: #fbbc04;
}

/* Messages Page */
.messages-page {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #fff;
    border-radius: 0;
    box-shadow: none;
    overflow: hidden;
    border: none;
    border-right: 1px solid #e6eef6;
    order: 1;
    min-width: 0;
    height: 100%;
    margin: 0;
}

.messages-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 24px;
    border-bottom: 1px solid #e6eef6;
    border-top: 1px solid #e6eef6;
    background: #fff;
    flex-shrink: 0;
}

.messages-header h6 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
    color: #121C0C;
}

.messages-container {
    display: flex;
    gap: 0;
    flex: 1;
    overflow: hidden;
    min-width: 0;
}

.messages-sidebar {
    background: #fff;
    border-right: 1px solid #e6eef6;
    padding: 24px 20px;
    width: 240px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.messages-sidebar .new-message-btn {
    background: #85BB65;
    color: #fff;
    border: none;
    border-radius: 12px;
    padding: 12px 16px;
    font-weight: 500;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: center;
    width: 100%;
    margin-bottom: 16px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 4px rgba(133, 187, 101, 0.2);
    cursor: pointer;
    font-size: 14px;
    position: relative;
    overflow: hidden;
}

.messages-sidebar .new-message-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    transform: translate(-50%, -50%);
    transition: width 0.4s ease, height 0.4s ease;
}

.messages-sidebar .new-message-btn:hover::before {
    width: 300px;
    height: 300px;
}

.messages-sidebar .new-message-btn:hover {
    background: #6fa050;
    color: #fff;
    text-decoration: none;
    box-shadow: 0 4px 12px rgba(133, 187, 101, 0.4);
    transform: translateY(-2px);
}

.messages-sidebar .new-message-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(133, 187, 101, 0.2);
}

.messages-sidebar .new-message-btn svg {
    width: 20px;
    height: 20px;
}

.messages-sidebar .folder-list {
    list-style: none;
    padding: 0;
    margin: 0;
    overflow: hidden;
    width: 100%;
}

.messages-sidebar .folder-item {
    margin-bottom: 4px;
}

.messages-sidebar .folder-link {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 10px 16px;
    border-radius: 0 24px 24px 0;
    text-decoration: none;
    color: #5f6368;
    font-weight: 500;
    font-size: 14px;
    transition: all 0.2s ease;
    margin-right: 8px;
    position: relative;
}

.messages-sidebar .folder-link::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    background: #85BB65;
    border-radius: 0 4px 4px 0;
    transition: width 0.2s ease, height 0.2s ease;
}

.messages-sidebar .folder-link:hover {
    background: #f1f3f4;
    color: #121C0C;
    text-decoration: none;
    transform: translateX(4px);
}

.messages-sidebar .folder-link:hover::before {
    width: 3px;
    height: 60%;
}

.messages-sidebar .folder-link.active {
    background: #e8f5e9;
    color: #85BB65;
    font-weight: 600;
}

.messages-sidebar .folder-link.active::before {
    width: 3px;
    height: 60%;
}

.messages-sidebar .folder-link.active:hover {
    background: #d4edda;
    color: #6fa050;
}

.messages-sidebar .folder-link svg {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
}

.messages-sidebar .folder-link .badge {
    margin-left: auto;
    background: #85BB65;
    color: #fff;
    font-size: 12px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 12px;
    min-width: 20px;
    text-align: center;
}

.messages-content {
    flex: 1;
    background: #fff;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-width: 0;
    border-top: 1px solid #e6eef6;
    border-bottom: 1px solid #e6eef6;
}

.messages-content-header {
    padding: 12px 20px;
    border-bottom: 1px solid #f1f3f4;
    display: flex;
    align-items: center;
    gap: 16px;
    background: #fff;
    flex-shrink: 0;
}

.messages-content-header .select-all {
    display: flex;
    align-items: center;
    gap: 8px;
}

.messages-content-header .select-all input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #85BB65;
}

.messages-content-header .select-all input[type="checkbox"]:checked {
    background-color: #85BB65;
    border-color: #85BB65;
}

.messages-content-header .select-all label {
    margin: 0;
    font-size: 14px;
    color: #5f6368;
    cursor: pointer;
}

.messages-content-body {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 0;
    background: #fff;
}

.messages-search {
    padding: 12px 20px;
    border-bottom: 1px solid #f1f3f4;
    background: #fff;
    flex-shrink: 0;
}

.messages-search .input-group {
    display: flex;
    gap: 8px;
    align-items: center;
    background: #f1f3f4;
    border-radius: 24px;
    padding: 8px 16px;
    transition: all 0.2s ease;
    width: 100%;
    box-sizing: border-box;
}

.messages-search .input-group:focus-within {
    background: #fff;
    box-shadow: 0 0 0 2px rgba(133, 187, 101, 0.2);
}

.messages-search .input-group svg {
    width: 20px;
    height: 20px;
    color: #5f6368;
    flex-shrink: 0;
}

.messages-search input {
    flex: 1;
    padding: 4px 8px;
    border: none;
    background: transparent;
    border-radius: 0;
    font-size: 14px;
    color: #121C0C;
    min-width: 0;
    width: 100%;
    box-sizing: border-box;
}

.messages-search input:focus {
    outline: none;
}

.messages-search button {
    background: transparent;
    color: #5f6368;
    border: none;
    padding: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
}

.messages-search button:hover {
    color: #121C0C;
}

.messages-list {
    display: flex;
    flex-direction: column;
    gap: 0;
    overflow-x: hidden;
    width: 100%;
}

.message-item {
    background: #fff;
    border-bottom: 1px solid #f1f3f4;
    padding: 14px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.2s ease;
    color: inherit;
    cursor: pointer;
    position: relative;
    min-width: 0;
    width: 100%;
    box-sizing: border-box;
}

.message-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 0;
    background: #85BB65;
    transition: width 0.2s ease;
}

.message-item:hover {
    background: #f8f9fa;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    transform: translateX(2px);
}

.message-item:hover::before {
    width: 3px;
}

.message-item:active {
    transform: translateX(0);
}

.message-item.read {
    background: #fff;
}

.message-item.read .message-sender {
    font-weight: 400;
    color: #5f6368;
}

.message-item.unread {
    background: #fff;
}

.message-item.unread .message-sender {
    font-weight: 600;
    color: #121C0C;
}

.message-item.draft-item {
    background: #f8f9fa !important;
    border-left: 3px solid #85BB65;
}

.message-item.draft-item:hover {
    background: #e8f5e9 !important;
}

.message-item.draft-item .message-sender {
    color: #85BB65 !important;
    font-weight: 600;
}

.message-item.draft-item .message-text {
    color: #5f6368 !important;
}

.message-item.trash-item {
    background: #f8f9fa !important;
    border-left: 3px solid #dc3545;
    opacity: 0.7;
}

.message-item.trash-item:hover {
    background: #f1f3f4 !important;
    opacity: 0.9;
}

.message-item.trash-item .message-sender {
    color: #6c757d !important;
    font-weight: 500;
}

.message-item.trash-item .message-text {
    color: #6c757d !important;
}

.message-item .message-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
    flex-shrink: 0;
    accent-color: #85BB65;
}

.message-item .message-checkbox:checked {
    background-color: #85BB65;
    border-color: #85BB65;
}

.message-item > a {
    flex: 1;
    display: flex;
    align-items: center;
    min-width: 0;
    width: 100%;
    box-sizing: border-box;
    gap: 16px;
    text-decoration: none;
    color: inherit;
}

.message-item > a:hover {
    text-decoration: none;
    color: inherit;
}

.message-avatar {
    width: 48px;
    height: 48px;
    min-width: 48px;
    min-height: 48px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #e6eef6;
}

.message-content {
    flex: 1;
    min-width: 0;
}

.message-sender {
    font-weight: 600;
    font-size: 14px;
    color: #121C0C;
    margin-bottom: 4px;
    line-height: 1.4;
}

.message-text {
    font-size: 14px;
    color: #5f6368;
    line-height: 1.5;
    word-wrap: break-word;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    white-space: nowrap;
    max-width: 100%;
    text-overflow: ellipsis;
}

.message-meta {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 8px;
    min-width: 100px;
}

.message-actions {
    display: flex;
    align-items: center;
    flex-shrink: 0;
    margin-left: 8px;
}

.message-badge {
    background: #85BB65;
    color: #fff;
    font-size: 11px;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 10px;
    white-space: nowrap;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.draft-badge {
    background: #85BB65 !important;
}

.trash-badge {
    background: #dc3545 !important;
}

.message-time {
    font-size: 12px;
    color: #5f6368;
    white-space: nowrap;
    font-weight: 400;
}

.message-delete-btn {
    background: transparent;
    border: none;
    padding: 6px;
    cursor: pointer;
    opacity: 0.5;
    transition: all 0.2s ease;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.message-delete-btn:hover {
    opacity: 1;
    background: #fee;
    color: #d32f2f;
    transform: scale(1.1);
}

.message-delete-btn:active {
    transform: scale(0.95);
}

.restore-btn {
    background: transparent;
    border: none;
    padding: 6px;
    cursor: pointer;
    opacity: 0.6;
    transition: all 0.2s ease;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 8px;
}

.restore-btn:hover {
    opacity: 1;
    background: #e8f5e9;
    color: #85BB65;
    transform: scale(1.1);
}

.restore-btn:active {
    transform: scale(0.95);
}

.empty-messages {
    text-align: center;
    padding: 60px 20px;
    color: #6b7280;
}

.empty-messages-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 20px;
    opacity: 0.3;
}

.pagination-wrapper {
    margin-top: 24px;
    display: flex;
    justify-content: center;
}

.empty-trash-btn {
    background: #dc3545;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
}

.empty-trash-btn:hover {
    background: #c82333;
}

.empty-trash-btn:active {
    transform: scale(0.95);
}

/* Compose Modal Styles */
.compose-modal {
    position: fixed;
    bottom: 0;
    right: 40px;
    width: 600px;
    max-height: 600px;
    background: #fff;
    border-radius: 8px 8px 0 0;
    box-shadow: 0 -4px 24px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    z-index: 1000;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid #e6eef6;
    border-bottom: none;
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from {
        transform: translateY(100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.compose-modal.hidden {
    display: none;
}

.compose-modal.minimized {
    height: 48px;
    max-height: 48px;
}

.compose-modal-header {
    background: #404040;
    color: #fff;
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 8px 8px 0 0;
    cursor: move;
    user-select: none;
    flex-shrink: 0;
}

.compose-modal-title {
    font-size: 14px;
    font-weight: 500;
}

.compose-modal-actions {
    display: flex;
    gap: 4px;
    align-items: center;
}

.compose-modal-btn {
    background: transparent;
    border: none;
    color: #fff;
    padding: 6px 8px;
    cursor: pointer;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    min-width: 32px;
    min-height: 32px;
}

.compose-modal-btn:hover {
    background: rgba(255,255,255,0.15);
    transform: scale(1.1);
}

.compose-modal-btn:active {
    transform: scale(0.95);
}

.compose-modal-body {
    display: flex;
    flex-direction: column;
    flex: 1;
    overflow: hidden;
    min-height: 400px;
    max-height: 550px;
    background: #fff;
}

.compose-field {
    padding: 10px 16px;
    border-bottom: 1px solid #f1f3f4;
    display: flex;
    align-items: center;
    flex-shrink: 0;
}

.compose-field input,
.compose-field select {
    width: 100%;
    border: none;
    outline: none;
    font-size: 14px;
    padding: 6px 0;
    color: #121C0C;
    background: transparent;
    font-family: inherit;
}

.compose-field input:focus,
.compose-field select:focus {
    outline: none;
}

.compose-field input::placeholder {
    color: #9aa0a6;
}

.compose-select {
    cursor: pointer;
}

.compose-select option {
    padding: 8px;
}

.compose-editor {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
    min-height: 200px;
    max-height: 300px;
    background: #fff;
}

.compose-editor textarea {
    width: 100%;
    height: 100%;
    border: none;
    outline: none;
    font-size: 14px;
    font-family: inherit;
    resize: none;
    color: #121C0C;
    line-height: 1.6;
    padding: 0;
}

.compose-editor textarea::placeholder {
    color: #9aa0a6;
}

.compose-footer {
    padding: 12px 16px;
    border-top: 1px solid #f1f3f4;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fff;
    flex-shrink: 0;
}

.compose-footer-left {
    display: flex;
    align-items: center;
    gap: 8px;
}

.compose-send-btn {
    background: #85BB65;
    color: #fff;
    border: none;
    border-radius: 24px;
    padding: 10px 24px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
    box-shadow: 0 1px 2px rgba(133, 187, 101, 0.2);
}

.compose-send-btn:hover {
    background: #6fa050;
    box-shadow: 0 2px 4px rgba(133, 187, 101, 0.3);
}

.compose-footer-right {
    display: flex;
    gap: 4px;
    align-items: center;
}

.compose-toolbar-btn {
    background: transparent;
    border: none;
    color: #5f6368;
    padding: 8px;
    cursor: pointer;
    border-radius: 4px;
    display: flex;
    align-items: center;
    transition: all 0.2s ease;
    position: relative;
}

.compose-toolbar-btn:hover {
    background: #f1f3f4;
    color: #121C0C;
    transform: scale(1.1);
}

.compose-toolbar-btn:active {
    transform: scale(0.95);
}

/* Draft indicator */
.compose-draft-indicator {
    background: #e8f5e9;
    border-left: 3px solid #85BB65;
    padding: 8px 12px;
    margin: 0 16px 16px;
    border-radius: 4px;
    font-size: 12px;
    color: #2e7d32;
    display: none;
    align-items: center;
    gap: 8px;
}

.compose-draft-indicator.visible {
    display: flex;
}

.auto-save-notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #85BB65;
    color: white;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 12px;
    z-index: 10000;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    display: none;
}

.auto-save-notification.visible {
    display: block;
}
</style>

<div class="email-app-wrapper">
    <div class="email-app-container">
        <!-- Messages Page -->
        <div class="messages-page">
            <div class="messages-header">
                <h6>
                    {% if current_type == 'drafts' %}
                        Drafts ({{ draft_count }})
                    {% elseif current_type == 'sent' %}
                        Sent Messages
                    {% elseif current_type == 'trash' %}
                        Trash ({{ trash_count }})
                    {% else %}
                        Inbox
                    {% endif %}
                </h6>
                {% if current_type == 'trash' and trash_count > 0 %}
                <button type="button" class="empty-trash-btn" onclick="emptyTrash()">
                    Empty Trash
                </button>
                {% endif %}
            </div>

            <div class="messages-container">
                <!-- Sidebar -->
                <div class="messages-sidebar">
                    <button type="button" class="new-message-btn" onclick="openComposeModal()">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <span>Compose</span>
                    </button>
                    
                    <ul class="folder-list">
                        <li class="folder-item">
                            <a href="{{ path('app_provider_messages', {'type': 'inbox'}) }}" 
                               class="folder-link {% if current_type == 'inbox' or current_type is empty %}active{% endif %}">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M3 13H21L20 7H4L3 13ZM3 13L2 19H22L21 13M9 17H15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                <span>Inbox</span>
                            </a>
                        </li>
                        <li class="folder-item">
                            <a href="{{ path('app_provider_messages', {'type': 'sent'}) }}" 
                               class="folder-link {% if current_type == 'sent' %}active{% endif %}">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span>Sent</span>
                            </a>
                        </li>
                        <li class="folder-item">
                            <a href="{{ path('app_provider_messages', {'type': 'drafts'}) }}" 
                               class="folder-link {% if current_type == 'drafts' %}active{% endif %}">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M3 7V5C3 3.89543 3.89543 3 5 3H19C20.1046 3 21 3.89543 21 5V7M3 7L5 21H19L21 7M3 7H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span>Drafts</span>
                                {% if draft_count > 0 %}
                                    <span class="badge draft-badge" id="drafts-count">{{ draft_count }}</span>
                                {% endif %}
                            </a>
                        </li>
                        <li class="folder-item">
                            <a href="{{ path('app_provider_messages', {'type': 'trash'}) }}" 
                               class="folder-link {% if current_type == 'trash' %}active{% endif %}">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M3 6H5H21M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span>Trash</span>
                                {% if trash_count > 0 %}
                                    <span class="badge trash-badge" id="trash-count">{{ trash_count }}</span>
                                {% endif %}
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Messages Content -->
                <div class="messages-content">
                    <!-- Search - Hide for trash -->
                    {% if current_type != 'trash' %}
                    <div class="messages-search">
                        <form action="" method="get" class="input-group">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
                                <path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            <input type="text" name="keyword" class="form-control" 
                                   placeholder="Search in messages" 
                                   value="{{ app.request.get('keyword') }}">
                            {% if current_type %}
                                <input type="hidden" name="type" value="{{ current_type }}">
                            {% endif %}
                            <button type="submit" class="btn">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M6 18L18 6M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </button>
                        </form>
                    </div>
                    {% endif %}
                    
                    <!-- Content Header - Hide for trash -->
                    {% if current_type != 'trash' %}
                    <div class="messages-content-header">
                        <div class="select-all">
                            <input type="checkbox" id="select-all-checkbox">
                            <label for="select-all-checkbox">Select all</label>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Messages List -->
                    <div class="messages-content-body">
                        {% if messages|length > 0 %}
                            <div class="messages-list">
                                {% for message in messages %}
                                    {% if current_type == 'drafts' %}
                                        {# Draft item template #}
                                        {% set receiverName = message.receiver ? message.receiver.name|default(message.receiver.email) : 'No receiver' %}
                                        {% set receiverAvatar = message.receiver and message.receiver.profilePictureFilename ? '/uploads/' ~ message.receiver.id ~ '/' ~ message.receiver.profilePictureFilename : asset('assets/img/user-image.png') %}
                                        
                                        <div class="message-item draft-item" data-draft-id="{{ message.id }}">
                                            <input type="checkbox" class="message-checkbox" data-message-id="{{ message.id }}">
                                            <div style="display: flex; align-items: center; gap: 16px; flex: 1; cursor: pointer;" onclick="loadDraftFromServer('{{ message.id }}')">
                                                <img src="{{ receiverAvatar }}" alt="{{ receiverName }}" class="message-avatar">
                                                <div class="message-content">
                                                    <div class="message-sender">To: {{ receiverName }}</div>
                                                    <div class="message-text">{{ message.text|striptags|slice(0, 100) }}{% if message.text|striptags|length > 100 %}...{% endif %}</div>
                                                </div>
                                                <div class="message-meta">
                                                    <div class="message-time">{{ message.savedAt ? message.savedAt|date('M j, Y g:i A') : message.createdAt|date('M j, Y g:i A') }}</div>
                                                </div>
                                            </div>
                                            <div class="message-actions">
                                                <button class="message-delete-btn" onclick="event.stopPropagation(); deleteDraftFromServer('{{ message.id }}')" title="Delete draft">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M3 6H5H21M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    {% elseif current_type == 'trash' %}
                                        {# Trash item template #}
                                        {% set senderName = message.sender.name|default(message.sender.email) %}
                                        {% set senderAvatar = message.sender.profilePictureFilename ? '/uploads/' ~ message.sender.id ~ '/' ~ message.sender.profilePictureFilename : asset('assets/img/user-image.png') %}
                                        {% set messageText = message.text|striptags|slice(0, 100) %}
                                        
                                        <div class="message-item trash-item" data-message-id="{{ message.id }}">
                                            <div style="display: flex; align-items: center; gap: 16px; flex: 1;">
                                                <img src="{{ senderAvatar }}" alt="{{ senderName }}" class="message-avatar">
                                                <div class="message-content">
                                                    <div class="message-sender">{{ senderName }}</div>
                                                    <div class="message-text">{{ messageText }}{% if message.text|striptags|length > 100 %}...{% endif %}</div>
                                                </div>
                                                <div class="message-meta">
                                                    <div class="message-time">{{ message.deletedAt|date('M j, Y g:i A') }}</div>
                                                    <div class="message-actions">
                                                        <button class="restore-btn" onclick="restoreMessage('{{ message.id }}')" title="Restore message">
                                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                                <path d="M14 10l-2 2 2 2M10 10l2 2-2 2M16 4a12 12 0 00-8 20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                                            </svg>
                                                        </button>
                                                        <button class="message-delete-btn" onclick="permanentlyDeleteMessage('{{ message.id }}')" title="Delete permanently">
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                                <path d="M3 6H5H21M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% else %}
                                        {# Regular message item template #}
                                        {% set senderName = current_type == 'sent' ? message.receiver.name|default(message.receiver.email) : message.sender.name|default(message.sender.email) %}
                                        {% set senderAvatar = current_type == 'sent' 
                                            ? (message.receiver.profilePictureFilename ? '/uploads/' ~ message.receiver.id ~ '/' ~ message.receiver.profilePictureFilename : asset('assets/img/user-image.png'))
                                            : (message.sender.profilePictureFilename ? '/uploads/' ~ message.sender.id ~ '/' ~ message.sender.profilePictureFilename : asset('assets/img/user-image.png')) %}
                                        {% set isRead = message.seen|default(false) %}
                                        {% set messageText = message.text|striptags|slice(0, 100) %}
                                        
                                        <div class="message-item {% if not isRead and current_type != 'sent' %}unread{% else %}read{% endif %}">
                                            <input type="checkbox" class="message-checkbox" data-message-id="{{ message.id }}">
                                            <a href="{{ path('app_provider_message_show', {'id': message.id}) }}" style="display: flex; align-items: center; gap: 16px; flex: 1; text-decoration: none; color: inherit;">
                                                <img src="{{ senderAvatar }}" alt="{{ senderName }}" class="message-avatar">
                                                <div class="message-content">
                                                    <div class="message-sender">{{ senderName }}</div>
                                                    <div class="message-text">{{ messageText }}{% if message.text|striptags|length > 100 %}...{% endif %}</div>
                                                </div>
                                                <div class="message-meta">
                                                    {% if not isRead and current_type != 'sent' %}
                                                        <span class="message-badge">New</span>
                                                    {% endif %}
                                                    <div class="message-time">{{ message.createdAt|time_diff }}</div>
                                                </div>
                                            </a>
                                            <div class="message-actions">
                                                <a href="{{ path('app_provider_message_delete', {'id': message.id}) }}" 
                                                   onclick="return confirm('Are you sure? Do you want to move this message to trash?');"
                                                   class="message-delete-btn">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M3 6H5H21M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                    </svg>
                                                </a>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>

                            <!-- Pagination -->
                            {% if messages.nbPages > 1 %}
                                <div class="pagination-wrapper">
                                    {{ pagerfanta(messages, 'twitter_bootstrap5') }}
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="empty-messages">
                                <svg class="empty-messages-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    {% if current_type == 'drafts' %}
                                        <path d="M3 7V5C3 3.89543 3.89543 3 5 3H19C20.1046 3 21 3.89543 21 5V7M3 7L5 21H19L21 7M3 7H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    {% elseif current_type == 'trash' %}
                                        <path d="M3 6H5H21M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    {% else %}
                                        <path d="M3 13H21L20 7H4L3 13ZM3 13L2 19H22L21 13M9 17H15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    {% endif %}
                                </svg>
                                <p>
                                    {% if current_type == 'drafts' %}
                                        No drafts found.
                                    {% elseif current_type == 'sent' %}
                                        No sent messages found.
                                    {% elseif current_type == 'trash' %}
                                        Trash is empty.
                                    {% else %}
                                        No messages found.
                                    {% endif %}
                                </p>
                                {% if current_type == 'drafts' %}
                                    <button onclick="openComposeModal()" style="background: #85BB65; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px;">
                                        Create New Message
                                    </button>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Right Sidebar -->
                <div class="right-sidebar">
                    <a href="{{ path('app_provider_interview_calendar') }}" 
                       class="sidebar-icon calendar {% if app.request.get('_route') == 'app_provider_interview_calendar' %}active{% endif %}" 
                       title="Calendar">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                            <path d="M16 2V6M8 2V6M3 10H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <path d="M8 14H8.01M12 14H12.01M16 14H16.01M8 18H8.01M12 18H12.01M16 18H16.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </a>
                    <a href="{{ path('app_provider_jobs_applications') }}?status=interview" 
                       class="sidebar-icon interview {% if app.request.get('status') == 'interview' %}active{% endif %}" 
                       title="Interview Links">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M17 20H22V18C22 16.3431 20.6569 15 19 15C18.0444 15 17.1931 15.4468 16.6438 16.1429M17 20H7M17 20V18C17 15.2386 14.7614 13 12 13C9.23858 13 7 15.2386 7 18V20M7 20H2V18C2 16.3431 3.34315 15 5 15C5.95561 15 6.80686 15.4468 7.35625 16.1429M15 7C15 9.20914 13.2091 11 11 11C8.79086 11 7 9.20914 7 7C7 4.79086 8.79086 3 11 3C13.2091 3 15 4.79086 15 7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </a>
                    <a href="{{ path('app_provider_documents') }}" 
                       class="sidebar-icon document {% if app.request.get('_route') == 'app_provider_documents' %}active{% endif %}" 
                       title="Document Center">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M16 13H8M16 17H8M10 9H8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </a>
                </div>
            </div>
        </div>

        <!-- COMPOSE MODAL -->
        <div id="compose-modal" class="compose-modal hidden">
            <div class="compose-modal-header">
                <span class="compose-modal-title">New Message</span>
                <div class="compose-modal-actions">
                    <button type="button" class="compose-modal-btn" onclick="minimizeComposeModal()" title="Minimize">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                    <button type="button" class="compose-modal-btn" onclick="closeComposeModal()" title="Close">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
            </div>
            <form id="compose-form" action="{{ path('app_provider_messages_new') }}" method="post" enctype="multipart/form-data" class="compose-modal-body">
                <input type="hidden" name="draft_id" id="compose-draft-id">
                <div class="compose-draft-indicator" id="draft-indicator">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 7V5C3 3.89543 3.89543 3 5 3H19C20.1046 3 21 3.89543 21 5V7M3 7L5 21H19L21 7M3 7H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <span>Editing draft - Auto-saving...</span>
                </div>
                <div class="compose-field">
                    <select name="receiver" id="compose-receiver" class="compose-select" required>
                        <option value="">-- Select Employer --</option>
                        {% for employer in employers %}
                            <option value="{{ employer.id }}">{{ employer.name }} {% if employer.email %}[{{ employer.email }}]{% endif %}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="compose-editor">
                    <textarea name="message" id="compose-message" placeholder="Compose your message..." required></textarea>
                </div>
                <div class="compose-footer">
                    <div class="compose-footer-left">
                        <button type="button" id="save-draft-btn" class="compose-toolbar-btn" onclick="saveAsDraft()" title="Save as draft">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 7V5C3 3.89543 3.89543 3 5 3H19C20.1046 3 21 3.89543 21 5V7M3 7L5 21H19L21 7M3 7H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            Save Draft
                        </button>
                        <button type="submit" class="compose-send-btn" id="send-message-btn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Send
                        </button>
                    </div>
                    <div class="compose-footer-right">
                        <button type="button" class="compose-toolbar-btn" onclick="document.getElementById('compose-attachment').click()" title="Attach files">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <input type="file" id="compose-attachment" name="attachment" style="display: none;">
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Auto-save notification -->
<div id="auto-save-notification" class="auto-save-notification">
    Draft saved
</div>
{% endblock %}

{% block footer_scripts %}
<script>
// Draft functionality
let currentDraftId = null;
let autoSaveInterval = null;
let autoSaveTimeout = null;

// Initialize draft auto-save
function initializeDraftAutoSave() {
    const messageInput = document.getElementById('compose-message');
    const receiverInput = document.getElementById('compose-receiver');
    
    if (messageInput) {
        // Clear any existing interval
        if (autoSaveInterval) {
            clearInterval(autoSaveInterval);
        }
        
        // Auto-save every 15 seconds when there's content
        autoSaveInterval = setInterval(() => {
            saveDraftToServer();
        }, 15000);
        
        // Debounced save on input (2 seconds after typing stops)
        ['input', 'change'].forEach(eventType => {
            if (messageInput) {
                messageInput.addEventListener(eventType, () => {
                    clearTimeout(autoSaveTimeout);
                    autoSaveTimeout = setTimeout(() => {
                        saveDraftToServer();
                    }, 2000);
                });
            }
            
            if (receiverInput) {
                receiverInput.addEventListener('change', () => {
                    saveDraftToServer();
                });
            }
        });
    }
}

// Save draft to server
async function saveDraftToServer() {
    const receiver = document.getElementById('compose-receiver')?.value || '';
    const message = document.getElementById('compose-message')?.value || '';
    
    // Don't save if no content
    if (!message.trim() && !receiver) {
        return;
    }
    
    try {
        const response = await fetch('{{ path('app_provider_draft_save') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                id: currentDraftId,
                receiver_id: receiver,
                message: message
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (!currentDraftId) {
                currentDraftId = result.draft.id;
                document.getElementById('compose-draft-id').value = currentDraftId;
                document.getElementById('draft-indicator').classList.add('visible');
            }
            showAutoSaveNotification();
            updateDraftsCount();
        }
    } catch (error) {
        console.error('Error saving draft:', error);
    }
}

// Load draft from server
async function loadDraftFromServer(draftId) {
    try {
        const response = await fetch(`/provider/messages/draft/${draftId}`);
        const result = await response.json();
        
        if (result.success) {
            const draft = result.draft;
            document.getElementById('compose-receiver').value = draft.receiver_id || '';
            document.getElementById('compose-message').value = draft.message || '';
            document.getElementById('compose-draft-id').value = draftId;
            currentDraftId = draftId;
            
            document.getElementById('draft-indicator').classList.add('visible');
            openComposeModal();
            initializeDraftAutoSave();
        }
    } catch (error) {
        console.error('Error loading draft:', error);
        alert('Error loading draft');
    }
}

// Delete draft from server
async function deleteDraftFromServer(draftId) {
    if (!confirm('Are you sure you want to delete this draft?')) return;
    
    try {
        const response = await fetch(`/provider/messages/draft/${draftId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Remove the draft item from UI
            const draftItem = document.querySelector(`[data-draft-id="${draftId}"]`);
            if (draftItem) {
                draftItem.style.transition = 'all 0.3s ease';
                draftItem.style.opacity = '0';
                draftItem.style.transform = 'translateX(-20px)';
                setTimeout(() => draftItem.remove(), 300);
            }
            
            updateDraftsCount();
            showToast('success', 'Draft deleted successfully');
        }
    } catch (error) {
        console.error('Error deleting draft:', error);
        alert('Error deleting draft');
    }
}

// Save as draft explicitly
function saveAsDraft() {
    const form = document.getElementById('compose-form');
    const draftInput = document.createElement('input');
    draftInput.type = 'hidden';
    draftInput.name = 'save_as_draft';
    draftInput.value = '1';
    form.appendChild(draftInput);
    form.submit();
}

// Show auto-save notification
function showAutoSaveNotification() {
    const notification = document.getElementById('auto-save-notification');
    notification.classList.add('visible');
    
    setTimeout(() => {
        notification.classList.remove('visible');
    }, 2000);
}

// Update drafts count
async function updateDraftsCount() {
    try {
        const response = await fetch('{{ path('app_provider_drafts_count') }}');
        const result = await response.json();
        
        const draftsBadge = document.getElementById('drafts-count');
        if (draftsBadge && result.count > 0) {
            draftsBadge.textContent = result.count;
        } else if (draftsBadge && result.count === 0) {
            draftsBadge.style.display = 'none';
        }
    } catch (error) {
        console.error('Error updating drafts count:', error);
    }
}

// Trash functionality
async function restoreMessage(messageId) {
    if (!confirm('Restore this message?')) return;
    
    try {
        const response = await fetch(`/provider/messages/restore/${messageId}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Remove the message from UI
            const messageItem = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageItem) {
                messageItem.style.transition = 'all 0.3s ease';
                messageItem.style.opacity = '0';
                messageItem.style.transform = 'translateX(-20px)';
                setTimeout(() => messageItem.remove(), 300);
            }
            
            updateTrashCount();
            showToast('success', 'Message restored successfully');
        }
    } catch (error) {
        console.error('Error restoring message:', error);
        alert('Error restoring message');
    }
}

async function permanentlyDeleteMessage(messageId) {
    if (!confirm('Permanently delete this message? This action cannot be undone.')) return;
    
    try {
        const response = await fetch(`/provider/messages/permanent-delete/${messageId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Remove the message from UI
            const messageItem = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageItem) {
                messageItem.style.transition = 'all 0.3s ease';
                messageItem.style.opacity = '0';
                messageItem.style.transform = 'translateX(-20px)';
                setTimeout(() => messageItem.remove(), 300);
            }
            
            updateTrashCount();
            showToast('success', 'Message permanently deleted');
        }
    } catch (error) {
        console.error('Error deleting message:', error);
        alert('Error deleting message');
    }
}

async function emptyTrash() {
    if (!confirm('Empty trash? This will permanently delete all messages in trash. This action cannot be undone.')) return;
    
    try {
        const response = await fetch('/provider/messages/empty-trash', {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Clear the messages list
            const messagesList = document.querySelector('.messages-list');
            if (messagesList) {
                messagesList.innerHTML = '';
            }
            
            updateTrashCount();
            showToast('success', 'Trash emptied successfully');
            
            // Show empty state
            const container = document.querySelector('.messages-content-body');
            container.innerHTML = `
                <div class="empty-messages">
                    <svg class="empty-messages-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 6H5H21M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <p>Trash is empty.</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error emptying trash:', error);
        alert('Error emptying trash');
    }
}

async function updateTrashCount() {
    try {
        const response = await fetch('{{ path('app_provider_trash_count') }}');
        const result = await response.json();
        
        const trashBadge = document.getElementById('trash-count');
        if (trashBadge && result.count > 0) {
            trashBadge.textContent = result.count;
            trashBadge.style.display = 'block';
        } else if (trashBadge) {
            trashBadge.style.display = 'none';
        }
    } catch (error) {
        console.error('Error updating trash count:', error);
    }
}

// Open compose modal
function openComposeModal() {
    const modal = document.getElementById('compose-modal');
    if (!modal) return;
    
    modal.classList.remove('hidden');
    modal.classList.remove('minimized');
    
    // Reset position
    modal.style.transform = 'translate(0, 0)';
    
    // Ensure body is visible
    const body = modal.querySelector('.compose-modal-body');
    if (body) {
        body.style.display = 'flex';
    }
    
    // Initialize auto-save for new messages
    if (!currentDraftId) {
        initializeDraftAutoSave();
    }
}

// Close compose modal
function closeComposeModal() {
    const modal = document.getElementById('compose-modal');
    const form = document.getElementById('compose-form');
    
    // Save any unsaved changes
    saveDraftToServer();
    
    // Clear auto-save interval
    if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
        autoSaveInterval = null;
    }
    
    if (autoSaveTimeout) {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = null;
    }
    
    modal.classList.add('hidden');
    
    // Reset form and state
    if (form) {
        form.reset();
    }
    currentDraftId = null;
    document.getElementById('compose-draft-id').value = '';
    document.getElementById('draft-indicator').classList.remove('visible');
}

// Minimize compose modal
function minimizeComposeModal() {
    const modal = document.getElementById('compose-modal');
    modal.classList.toggle('minimized');
    if (modal.classList.contains('minimized')) {
        modal.querySelector('.compose-modal-body').style.display = 'none';
    } else {
        modal.querySelector('.compose-modal-body').style.display = 'flex';
    }
}

// Modal drag functionality
let isDragging = false;
let currentX, currentY, initialX, initialY, xOffset = 0, yOffset = 0;
const composeModal = document.getElementById('compose-modal');
const composeHeader = composeModal?.querySelector('.compose-modal-header');

if (composeHeader) {
    composeHeader.addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', dragEnd);
}

function dragStart(e) {
    if (e.target.closest('.compose-modal-btn')) return;
    
    initialX = e.clientX - xOffset;
    initialY = e.clientY - yOffset;

    if (e.target === composeHeader || composeHeader.contains(e.target)) {
        isDragging = true;
    }
}

function drag(e) {
    if (isDragging) {
        e.preventDefault();
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;

        xOffset = currentX;
        yOffset = currentY;

        setTranslate(currentX, currentY, composeModal);
    }
}

function dragEnd() {
    initialX = currentX;
    initialY = currentY;
    isDragging = false;
}

function setTranslate(xPos, yPos, el) {
    el.style.transform = `translate(${xPos}px, ${yPos}px)`;
}

// Form submission handling
document.getElementById('compose-form')?.addEventListener('submit', function(e) {
    const receiver = document.getElementById('compose-receiver').value;
    const message = document.getElementById('compose-message').value;
    
    if (!receiver || !message.trim()) {
        e.preventDefault();
        alert('Please select a receiver and enter a message');
        return;
    }
    
    // Clear draft on send
    if (currentDraftId) {
        // The draft will be converted to a real message by the server
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateDraftsCount();
    updateTrashCount();
    
    // Update delete links to show trash confirmation
    const deleteLinks = document.querySelectorAll('a[href*="delete"]');
    deleteLinks.forEach(link => {
        if (link.href.includes('/delete/')) {
            link.addEventListener('click', function(e) {
                if (!confirm('Are you sure? This message will be moved to trash.')) {
                    e.preventDefault();
                }
            });
        }
    });
});

// Toast notification function (if not already defined)
function showToast(type, message) {
    // Implement your toast notification system
    alert(message); // Fallback
}
</script>
{% endblock %}