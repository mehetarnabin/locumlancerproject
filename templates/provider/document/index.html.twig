{% extends 'provider/base.html.twig' %}

{% block title %}Documents{% endblock %}

{% block provider_body %}
<style>
/* Layout reset to match dashboard spacing */
body.app .app-wrapper,
.app-wrapper {
    display: block !important;
    justify-content: unset !important;
    align-items: unset !important;
    width: 100% !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
}

@media (min-width: 1200px) {
    body.app .app-wrapper,
    .app-wrapper {
        margin-left: 250px !important;
        transform: translateX(-150px) !important;
        width: calc(100% - 250px + 150px) !important;
    }
}

body.app .app-wrapper .app-content,
.app-wrapper .app-content,
.app-content {
    padding-top: 80px !important;
    padding-bottom: 48px !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
    max-width: 100% !important;
    width: 100% !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    box-sizing: border-box !important;
}

@media (min-width: 1200px) {
    body.app .app-wrapper .app-content,
    .app-wrapper .app-content,
    .app-content {
        width: 100% !important;
        max-width: 100% !important;
    }
}

body.app .app-wrapper .app-content .container-xl,
.app-wrapper .app-content .container-xl,
.app-content .container-xl,
body .app-content .container-xl,
div.container-xl,
[class*="container-xl"],
.container-xl {
    position: relative !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    padding-left: 0 !important;
    padding-right: 30px !important;
    max-width: 100% !important;
    width: 100% !important;
    transform: none !important;
    box-sizing: border-box !important;
}

@media (max-width: 1199.98px) {
    body.app .app-wrapper .app-content .container-xl,
    .app-wrapper .app-content .container-xl,
    .app-content .container-xl,
    body .app-content .container-xl,
    div.container-xl,
    [class*="container-xl"],
    .container-xl {
        padding-left: 20px !important;
        padding-right: 20px !important;
    }
}

/* Modern card styles matching profile page */
.card.app-card-settings {
    border: none;
    background: #fff;
    margin-bottom: 24px;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(16,24,40,0.06);
    padding: 0;
    display: flex;
    flex-direction: column;
}

.card.app-card-settings .card-body {
    padding: 24px;
    flex: 1;
    display: flex;
    flex-direction: column;
}

.card-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.card-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin: 0;
    color: #0f172a;
}

.app-page-title {
    color: #0f172a;
    font-size: 2rem;
    font-weight: 600;
    margin: 0 0 32px 4px;
}

/* Form styling */
.form-label {
    font-weight: 500;
    color: #0f172a;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.form-control, .form-select {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 0.875rem;
    transition: all 0.2s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #85BB65;
    box-shadow: 0 0 0 3px rgba(133, 187, 101, 0.1);
    outline: none;
}

/* Upload dropzone styling */
.upload-dropzone {
    border: 2px dashed #85BB65;
    border-radius: 12px;
    background: #F4F9F1;
    padding: 40px 20px;
    text-align: center;
    position: relative;
    cursor: pointer;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.upload-dropzone:hover {
    background: #f0f5ec;
    border-color: #6FA050;
}

.dropzone-input {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
    z-index: 10;
}

.dropzone-content {
    position: relative;
    z-index: 1;
}

.upload-text {
    font-size: 1rem;
    font-weight: 500;
    margin-top: 12px;
    color: #374151;
}

.upload-subtext {
    font-size: 0.85rem;
    color: #6B7280;
    margin-top: 6px;
}

.file-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    background: #85BB65;
    color: white;
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    gap: 8px;
    z-index: 3;
    font-weight: 500;
}

.file-remove-btn {
    background: none;
    border: none;
    color: white;
    font-size: 1rem;
    line-height: 1;
    cursor: pointer;
    padding: 0;
    margin-left: 8px;
}

/* Button styling */
.btn-primary, .btn-upload {
    background: #85BB65;
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    font-weight: 500;
    color: white;
    transition: all 0.2s ease;
}

.btn-primary:hover, .btn-upload:hover {
    background: #6FA050;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(133, 187, 101, 0.3);
}

.btn-secondary {
    background: #f3f4f6;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 10px 20px;
    font-weight: 500;
    color: #374151;
    transition: all 0.2s ease;
}

.btn-secondary:hover {
    background: #e5e7eb;
    border-color: #d1d5db;
}

/* Table styling */
.table {
    margin-bottom: 0;
}

.table thead th {
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    font-weight: 600;
    font-size: 0.92rem;
    color: #0f172a;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 14px 16px;
}

.document-table {
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
}

.document-table tbody tr {
    background: #fff;
    transition: background 0.2s ease, box-shadow 0.2s ease;
}

.document-table tbody tr + tr td {
    border-top: 1px solid #f1f5f9;
}

.document-table tbody tr:hover {
    background: #f9fcff;
    box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.05);
}

.document-table td {
    padding: 16px;
    font-size: 0.95rem;
    color: #111827;
    vertical-align: middle;
}

.document-table td strong {
    font-weight: 600;
    color: #0f172a;
}

.table tbody td {
    padding: 16px;
    vertical-align: middle;
    border-bottom: 1px solid #f3f4f6;
    color: #374151;
    font-size: 0.875rem;
}

.table tbody tr:hover {
    background: #F9FAFB;
}

.table tbody tr:last-child td {
    border-bottom: none;
}

/* Action buttons */
.action-buttons {
    display: flex;
    gap: 8px;
    align-items: center;
}

.action-btn {
    min-width: 32px;
    min-height: 32px;
    width: auto;
    height: auto;
    padding: 6px 12px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    border-radius: 6px;
    background: #F4F9F1;
    border: 1px solid #e6eef6;
    transition: all 0.2s ease;
    text-decoration: none;
    font-size: 13px;
    color: #374151;
    cursor: pointer;
}

.action-btn:has(img) {
    width: 32px;
    height: 32px;
    padding: 0;
}

.action-btn:hover {
    background: #85BB65;
    border-color: #85BB65;
    transform: translateY(-1px);
}

.action-btn img {
    width: 16px;
    height: 16px;
}

.action-btn:hover img {
    filter: brightness(0) invert(1);
}

/* Split View Styles */
.split-view-container {
    display: none;
    grid-template-columns: minmax(350px, 1fr) 1.5fr;
    gap: 20px;
    margin-top: 20px;
    height: 70vh;
    position: relative;
    transition: grid-template-columns 0.3s ease, gap 0.3s ease;
}

.split-view-container.list-collapsed {
    grid-template-columns: 1fr !important;
    gap: 0 !important;
}

.split-view-container.list-collapsed > .split-document-list {
    display: none !important;
    grid-column: none !important;
    width: 0 !important;
    min-width: 0 !important;
    max-width: 0 !important;
    padding: 0 !important;
    margin: 0 !important;
    overflow: hidden !important;
    opacity: 0 !important;
    visibility: hidden !important;
    position: absolute !important;
    left: -9999px !important;
}

.split-view-container.list-collapsed > .split-document-details {
    grid-column: 1 / -1 !important;
    width: 100% !important;
    max-width: 100% !important;
}

.split-view-container .split-document-list {
    width: 100%;
    opacity: 1;
    transition: all 0.3s ease;
    position: relative;
    display: block;
}

.list-toggle-btn {
    display: none;
    position: fixed;
    background: #fff;
    border: 1px solid #e6eef6;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    padding: 0;
    cursor: pointer;
    z-index: 1000;
    box-shadow: 0 2px 8px rgba(11,22,40,0.15);
    transition: all 0.3s ease;
    align-items: center;
    justify-content: center;
}

.list-toggle-btn:hover {
    background: #F4F9F1;
    border-color: #85BB65;
    box-shadow: 0 4px 12px rgba(133, 187, 101, 0.3);
}

.list-toggle-btn:hover svg {
    transform: scale(1.1);
}

.split-view-container.list-collapsed .list-toggle-btn:hover svg {
    transform: rotate(180deg) scale(1.1);
}

.list-toggle-btn svg {
    width: 18px;
    height: 18px;
    transition: transform 0.3s ease;
}

.split-view-container.list-collapsed .list-toggle-btn svg {
    transform: rotate(180deg);
}

.split-document-list {
    background: #F4F9F1;
    border: 1px solid #e6eef6;
    border-radius: 10px;
    padding: 16px;
    overflow-y: auto;
    box-shadow: 0 2px 6px rgba(11,22,40,0.03);
    position: relative;
}

.split-document-card {
    background: #fff;
    border: 1px solid #e6eef6;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.split-document-card:hover {
    border-color: #85BB65;
    box-shadow: 0 2px 8px rgba(133, 187, 101, 0.15);
}

.split-document-card.active {
    border-color: #85BB65;
    background: #F4F9F1;
    box-shadow: 0 2px 8px rgba(133, 187, 101, 0.2);
}

.split-document-card-header {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 8px;
}

.split-document-card-title {
    font-size: 14px;
    font-weight: 600;
    color: #121C0C;
    margin-bottom: 4px;
}

.split-document-card-company {
    font-size: 12px;
    color: #6b7280;
}

.split-document-summary {
    display: flex;
    gap: 16px;
    margin-top: 8px;
}

.split-document-summary-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.split-document-meta-label {
    font-size: 11px;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.split-document-meta-value {
    font-size: 12px;
    color: #374151;
    font-weight: 500;
}

.split-document-details {
    background: #fff;
    border: 1px solid #e6eef6;
    border-radius: 10px;
    padding: 20px;
    overflow-y: auto;
    overflow-x: hidden;
    box-shadow: 0 2px 6px rgba(11,22,40,0.03);
    position: relative;
}

.no-document-selected {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    color: #9ca3af;
}

.request-preview-container {
    background: #F9FAFB;
    border: 1px dashed #e5e7eb;
    border-radius: 12px;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    min-height: 260px;
}

.request-status-badge {
    border-radius: 999px;
    padding: 6px 16px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.request-status-badge.status-provided {
    background: #E1F5E0;
    color: #1F7A1F;
}

.request-status-badge.status-pending {
    background: #FFF4D9;
    color: #A45D00;
}

.request-meta-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
    gap: 16px;
}

.request-meta-item {
    background: #fff;
    border: 1px solid #e6eef6;
    border-radius: 10px;
    padding: 12px 14px;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.request-meta-item span {
    font-size: 0.7rem;
    font-weight: 600;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.04em;
}

.request-meta-item strong {
    font-size: 0.95rem;
    color: #111827;
    font-weight: 600;
}

.request-instructions {
    background: #fff;
    border: 1px solid #e6eef6;
    border-radius: 10px;
    padding: 16px 18px;
}

.request-instructions h6 {
    font-size: 0.95rem;
    margin-bottom: 6px;
    font-weight: 600;
    color: #111827;
}

.no-document-selected svg {
    margin-bottom: 16px;
    opacity: 0.5;
}

.no-document-selected h4 {
    font-size: 18px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
}

.no-document-selected p {
    font-size: 14px;
    color: #6b7280;
}

#requests-document-content,
#documents-document-content {
    width: 100%;
    height: 100%;
}

.document-preview-container {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.document-preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e6eef6;
}

.document-preview-title {
    font-size: 18px;
    font-weight: 600;
    color: #121C0C;
}

.document-preview-actions {
    display: flex;
    gap: 8px;
}

.document-preview-frame {
    flex: 1;
    width: 100%;
    border: 1px solid #e6eef6;
    border-radius: 8px;
    overflow: hidden;
    background: #f9fafb;
}

.document-preview-frame iframe,
.document-preview-frame embed,
.document-preview-frame object {
    width: 100%;
    height: 100%;
    border: none;
}

.document-preview-frame img {
    width: 100%;
    height: auto;
    max-height: 100%;
    object-fit: contain;
}

#requests-split-view-btn.active,
#documents-split-view-btn.active {
    background: #85BB65;
    color: #fff;
}

#requests-split-view-btn.active svg,
#documents-split-view-btn.active svg {
    stroke: #fff;
}

/* Document select styling */
.document-select {
    min-width: 200px;
    font-size: 0.875rem;
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6B7280;
}

.empty-state-icon {
    font-size: 3rem;
    margin-bottom: 16px;
    opacity: 0.5;
}

/* Category badge */
.category-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 500;
    background: #EAF3E4;
    color: #4B5563;
}

/* Tabs Styling */
.documents-tabs {
    display: flex;
    border-bottom: 1px solid #e5e7eb;
    margin: 40px 0 24px 0;
    background: #fff;
    border-radius: 12px 12px 0 0;
    padding: 0 24px;
}

.documents-tab {
    padding: 16px 24px;
    border: none;
    background: none;
    font-weight: 500;
    color: #6b7280;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
    position: relative;
}

.documents-tab:hover {
    color: #374151;
    background: #f9fafb;
}

.documents-tab.active {
    color: #85BB65;
    border-bottom-color: #85BB65;
}

.documents-tab.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: #85BB65;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* History Table Styling */
.history-table .action-badge {
    padding: 4px 12px;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 500;
}

.action-badge.uploaded {
    background: #E1F5E0;
    color: #1F7A1F;
}

.action-badge.updated {
    background: #FFF4D9;
    color: #A45D00;
}

.action-badge.deleted {
    background: #FEE2E2;
    color: #DC2626;
}

.action-badge.assigned {
    background: #E0F2FE;
    color: #0369A1;
}

/* Credentials Section */
.credentials-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.credential-card {
    background: #fff;
    border: 1px solid #e6eef6;
    border-radius: 12px;
    padding: 20px;
    transition: all 0.2s ease;
}

.credential-card:hover {
    border-color: #85BB65;
    box-shadow: 0 4px 12px rgba(133, 187, 101, 0.1);
}

.credential-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
}

.credential-icon {
    width: 40px;
    height: 40px;
    background: #F4F9F1;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #85BB65;
}

.credential-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #0f172a;
    margin: 0;
}

.credential-description {
    color: #6b7280;
    font-size: 0.9rem;
    margin-bottom: 16px;
    line-height: 1.5;
}

.credential-actions {
    display: flex;
    gap: 8px;
}

/* Credentialing Links specific styles */
.credential-meta {
    background: #f8fafc;
    border-radius: 6px;
    padding: 8px 12px;
    border: 1px solid #e6eef6;
}

.credential-card .text-sm {
    font-size: 0.8rem;
}

.url-preview {
    word-break: break-all;
}

/* Empty states */
.empty-state-compact {
    text-align: center;
    padding: 40px 20px;
    color: #6B7280;
}

.empty-state-compact .empty-state-icon {
    font-size: 2rem;
    margin-bottom: 12px;
    opacity: 0.5;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .table-responsive {
        overflow-x: auto;
    }
    
    .action-buttons {
        flex-direction: column;
        gap: 4px;
    }
    
    .documents-tabs {
        flex-wrap: wrap;
        padding: 0 16px;
    }
    
    .documents-tab {
        padding: 12px 16px;
        font-size: 0.9rem;
    }
    
    .credentials-grid {
        grid-template-columns: 1fr;
    }
    
    .credential-actions {
        flex-direction: column;
    }
    
    .credential-actions .action-btn {
        justify-content: center;
    }
}
</style>

    <div class="container-xl">
    <h1 class="app-page-title">Documents</h1>

   {# Document Requests Table - Only Pending Requests #}
<div class="card app-card-settings">
    <div class="card-body">
        <div class="card-header-row">
            <h5 class="card-title">Pending Document Requests</h5>
            <button id="requests-split-view-btn" class="action-btn" title="Split View">
                <svg class="icon-image" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 3H10V10H3V3Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M14 3H21V10H14V3Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M3 14H10V21H3V14Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M14 14H21V21H14V14Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Split View
            </button>
        </div>

        <div class="table-responsive" id="requests-list-view">
            <table class="table document-table align-middle">
                <thead>
                    <tr>
                        <th>S. No</th>
                        <th>Document Name</th>
                        <th>Job</th>
                        <th>Requested By</th>
                        <th>Requested At</th>
                        <th>Status</th>
                        <th>Assign Document</th>
                    </tr>
                </thead>
                <tbody>
                    {% set pendingDocumentRequests = documentRequests|filter(request => request.providedAt is null) %}
                    {% if pendingDocumentRequests|length > 0 %}
                        {% for documentRequest in pendingDocumentRequests %}
                            {% set document = documentRequest.document %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td><strong>{{ documentRequest.name }}</strong></td>
                                <td>
                                    {% if documentRequest.application and documentRequest.application.job %}
                                        {{ documentRequest.application.job.title }}
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if documentRequest.application and documentRequest.application.employer %}
                                        <div>
                                            <strong>{{ documentRequest.application.employer.companyName }}</strong><br/>
                                            <small class="text-muted">
                                                {% if documentRequest.application.employer.contactEmail %}
                                                    {{ documentRequest.application.employer.contactEmail }}
                                                {% elseif documentRequest.application.employer.email %}
                                                    {{ documentRequest.application.employer.email }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </small>
                                        </div>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>{{ documentRequest.createdAt|date('m/d/Y') }}</td>
                                <td>
                                    <span class="text-warning">Pending</span>
                                </td>
                                <td>
                                    <select class="form-control form-select document-select" 
                                            data-request-id="{{ documentRequest.id }}"
                                            style="min-width: 200px;">
                                        <option value="">Select Document</option>
                                        {% for documentObj in documents %}
                                            <option {% if documentObj == documentRequest.document %}selected{% endif %} 
                                                    value="{{ documentObj.id }}">
                                                {{ documentObj.category ?: documentObj.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="empty-state-icon">ðŸ“‹</div>
                                <p class="mb-0">No pending document requests found.</p>
                                <p class="text-muted small mt-2">All document requests have been provided.</p>
                                <div class="mt-3">
                                    <p class="small text-info">
                                        <strong>How to get document requests:</strong><br>
                                        1. Apply to jobs<br>
                                        2. Employers may request additional documents<br>
                                        3. Check back after submitting applications
                                    </p>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        </div>
        
        {# Split View for Document Requests - Only Pending Requests #}
        <div class="split-view-container" id="requests-split-view-container" style="display: none;">
            <button class="list-toggle-btn" id="requests-list-toggle-btn" style="display: none;" title="Toggle document list">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15 6L9 12L15 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <!-- Left Side: Document List -->
            <div class="split-document-list" id="requests-split-list">
                {% set pendingDocumentRequests = documentRequests|filter(request => request.providedAt is null) %}
                {% for documentRequest in pendingDocumentRequests %}
                    {% set document = documentRequest.document %}
                    {% set job = documentRequest.application.job %}
                    {% set employer = documentRequest.application.employer %}
                    {% set locationParts = [] %}
                    {% if job and job.city %}
                        {% set locationParts = locationParts|merge([job.city]) %}
                    {% endif %}
                    {% if job and job.state %}
                        {% set locationParts = locationParts|merge([job.state]) %}
                    {% endif %}
                    {% if job and job.country %}
                        {% set locationParts = locationParts|merge([job.country]) %}
                    {% endif %}
                    {% set jobLocation = locationParts|join(', ') %}
                    {% set jobNeed = job and job.need ? job.need : '' %}
                    {% set jobSchedule = job and job.schedule ? job.schedule : '' %}
                    {% set jobId = job and job.jobId ? job.jobId : '' %}
                    <div
                        class="split-document-card"
                        data-request-id="{{ documentRequest.id }}"
                        data-request-name="{{ documentRequest.name|e('html_attr') }}"
                        data-job-title="{{ job ? job.title|e('html_attr') : 'Job' }}"
                        data-employer="{{ employer ? employer.companyName|e('html_attr') : 'Employer' }}"
                        data-requested-at="{{ documentRequest.createdAt|date('M d, Y') }}"
                        data-status="Pending"
                        data-job-location="{{ jobLocation|e('html_attr') }}"
                        data-job-need="{{ jobNeed|e('html_attr') }}"
                        data-job-schedule="{{ jobSchedule|e('html_attr') }}"
                        data-job-id="{{ jobId|e('html_attr') }}"
                        data-document-id="{{ document ? document.id : '' }}"
                        data-document-url="{{ document ? asset('uploads/' ~ document.user.id ~ '/' ~ document.fileName) : '' }}"
                    >
                        <div class="split-document-card-header">
                            <div class="flex-grow-1">
                                <div class="split-document-card-title">{{ documentRequest.name }}</div>
                                <div class="split-document-card-company">{{ job ? job.title : 'Job' }}</div>
                            </div>
                        </div>
                        <div class="split-document-summary">
                            <div class="split-document-summary-item">
                                <span class="split-document-meta-label">Requested:</span>
                                <span class="split-document-meta-value">{{ documentRequest.createdAt|date('m/d/Y') }}</span>
                            </div>
                            <div class="split-document-summary-item">
                                <span class="split-document-meta-label">Status:</span>
                                <span class="split-document-meta-value">Pending</span>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <!-- Right Side: Document Preview -->
            <div class="split-document-details" id="requests-split-details">
                <div class="no-document-selected">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8 12H16M8 16H16M8 8H12M12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <h4>Select a document to view</h4>
                    <p>Click on any document from the list to see its preview here.</p>
                </div>
                <div id="requests-document-content" style="display: none;"></div>
            </div>
        </div>
    </div>

        {# Document Upload Form #}
    <div class="card app-card-settings">
            <div class="card-body">
            <div class="card-header-row">
                <h5 class="card-title">{{ editMode is defined ? 'Edit Document' : 'Upload Document' }}</h5>
            </div>
            
            {{ form_start(form, {'attr': {'class': 'needs-validation', 'novalidate': 'novalidate', 'enctype': 'multipart/form-data'}}) }}
            
            <div class="row g-4">
                {# Document Name Field (Category) #}
                <div class="col-12">
                        <div class="mb-3">
                        {{ form_label(form.category, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.category, {'attr': {'class': 'form-select'}}) }}
                        {{ form_errors(form.category) }}
                    </div>
                        </div>

                {# File Upload Dropzone #}
                <div class="col-12">
                    <div class="mb-3">
                        <label class="form-label">Choose File (PDF or DOCX)</label>
                        <div class="upload-dropzone position-relative" id="uploadDropzone">
                            {{ form_widget(form.fileName, {
                                'attr': {
                                    'class': 'dropzone-input',
                                    'id': 'fileInput',
                                    'accept': '.pdf,.doc,.docx',
                                    'onchange': 'handleFileChange(this)'
                                }
                            }) }}
                            
                            <div id="fileBadge" class="file-badge" style="display:none;">
                                <span id="fileNameText"></span>
                                <button type="button" class="file-remove-btn" onclick="clearFile()">Ã—</button>
                            </div>

                            <div class="dropzone-content">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#85BB65" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                </svg>
                                <p class="upload-text mb-1">Drag and drop or click to upload</p>
                                <p class="upload-subtext mb-0">Max File Size: 8MB | Allowed Types: PDF, DOC, DOCX</p>
                            </div>
                        </div>
                        {{ form_errors(form.fileName) }}
                    </div>
                </div>

                {# Issue Date #}
                <div class="col-12 col-md-6">
                    <div class="mb-3">
                        {{ form_label(form.issueDate, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.issueDate, {'attr': {'class': 'form-control js-datepicker', 'id': 'document_issueDate'}}) }}
                        {{ form_errors(form.issueDate) }}
                    </div>
                </div>

                {# Expiration Date #}
                <div class="col-12 col-md-6">
                    <div class="mb-3">
                        {{ form_label(form.expirationDate, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.expirationDate, {'attr': {'class': 'form-control js-datepicker', 'id': 'document_expirationDate'}}) }}
                        <span id="expiration-date-help" class="text-muted small d-block mt-1" style="display: none;"></span>
                        {{ form_errors(form.expirationDate) }}
                    </div>
                </div>
                </div>

            <div class="d-flex justify-content-end gap-2 mt-4">
                {% if editMode is defined %}
                    <a href="{{ path('app_provider_documents') }}" class="btn btn-secondary">Cancel</a>
                {% endif %}
                <button type="submit" class="btn btn-primary btn-upload">
                    {{ editMode is defined ? 'Update Document' : 'Upload Document' }}
                </button>
            </div>
            
                {{ form_end(form) }}
            </div>
        </div>


    {# Uploaded Documents Table #}
    <div class="card app-card-settings">
        <div class="card-body">
            <div class="card-header-row">
                <h5 class="card-title">Uploaded Documents</h5>
                <button id="documents-split-view-btn" class="action-btn" title="Split View">
                    <svg class="icon-image" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 3H10V10H3V3Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M14 3H21V10H14V3Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M3 14H10V21H3V14Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M14 14H21V21H14V14Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Split View
                </button>
            </div>
            
            <div class="table-responsive" id="documents-list-view">
                <table class="table document-table align-middle">
                    <thead>
                        <tr>
                            <th>S. No</th>
                            <th>Document Name</th>
                            <th>Issue Date</th>
                            <th>Expiration Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for document in documents %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>
                                    <strong>{{ document.category ?: document.name }}</strong>
                                </td>
                                <td>{{ document.issueDate ? document.issueDate|date('m/d/Y') : '-' }}</td>
                                <td>
                                    {% if document.expirationDate %}
                                        {% set daysUntilExpiry = (document.expirationDate|date('U') - 'now'|date('U')) / 86400 %}
                                        {% if daysUntilExpiry < 0 %}
                                            <span class="text-danger">{{ document.expirationDate|date('m/d/Y') }} <small>(Expired)</small></span>
                                        {% elseif daysUntilExpiry <= 30 %}
                                            <span class="text-warning">{{ document.expirationDate|date('m/d/Y') }} <small>(Expiring Soon)</small></span>
                                        {% else %}
                                            {{ document.expirationDate|date('m/d/Y') }}
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="{{ path('app_provider_document_view', {'id': document.id}) }}"
                                           class="action-btn" 
                                           title="View Document">
                                            <img src="{{ asset('assets/icons/shared-folder.png') }}" alt="View"/>
                                        </a>
                                        <a href="{{ path('app_provider_document_edit', {'id': document.id}) }}"
                                           class="action-btn"
                                           title="Edit Document">
                                            <img src="{{ asset('assets/icons/compose.png') }}" alt="Edit"/>
                                        </a>
                                        <a href="{{ path('app_provider_document_delete', {'id': document.id}) }}"
                                           class="action-btn delete-document-btn"
                                           title="Delete Document"
                                           data-document-name="{{ document.category ?: document.name }}"
                                           data-document-id="{{ document.id }}">
                                            <img src="{{ asset('assets/icons/trash-bin.png') }}" alt="Delete"/>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="6" class="empty-state">
                                    <div class="empty-state-icon">ðŸ“„</div>
                                    <p class="mb-0">No documents uploaded yet.</p>
                                    <p class="text-muted small mt-2">Upload your first document using the form above.</p>
                                </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                </div>
            </div>
            
            {# Split View for Uploaded Documents #}
            <div class="split-view-container" id="documents-split-view-container" style="display: none;">
                <button class="list-toggle-btn" id="documents-list-toggle-btn" style="display: none;" title="Toggle document list">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 6L9 12L15 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <!-- Left Side: Document List -->
                <div class="split-document-list" id="documents-split-list">
                    {% for document in documents %}
                        <div class="split-document-card" data-document-id="{{ document.id }}" data-document-url="{{ asset('uploads/' ~ document.user.id ~ '/' ~ document.fileName) }}" data-document-name="{{ document.category ?: document.name }}">
                            <div class="split-document-card-header">
                                <div class="flex-grow-1">
                                    <div class="split-document-card-title">{{ document.category ?: document.name }}</div>
                                    <div class="split-document-card-company">{{ document.issueDate ? document.issueDate|date('m/d/Y') : 'No Issue Date' }}</div>
                                </div>
                            </div>
                            <div class="split-document-summary">
                                <div class="split-document-summary-item">
                                    <span class="split-document-meta-label">Issue:</span>
                                    <span class="split-document-meta-value">{{ document.issueDate ? document.issueDate|date('m/d/Y') : '-' }}</span>
                                </div>
                                <div class="split-document-summary-item">
                                    <span class="split-document-meta-label">Expires:</span>
                                    <span class="split-document-meta-value">
                                        {% if document.expirationDate %}
                                            {{ document.expirationDate|date('m/d/Y') }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Right Side: Document Preview -->
                <div class="split-document-details" id="documents-split-details">
                    <div class="no-document-selected">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 12H16M8 16H16M8 8H12M12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <h4>Select a document to view</h4>
                        <p>Click on any document from the list to see its preview here.</p>
                    </div>
                    <div id="documents-document-content" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    {# Tabs Section - Only My Documents, History, and Credentials #}
    <div class="documents-tabs">
        <button class="documents-tab active" data-tab="my-documents">My Documents</button>
        <button class="documents-tab" data-tab="history">History</button>
        <button class="documents-tab" data-tab="credentials">Credentials</button>
    </div>

    {# My Documents Tab - This is just a placeholder since we already show documents above #}
    <div class="tab-content active" id="my-documents-tab">
        <div class="card app-card-settings">
            <div class="card-body">
                <div class="card-header-row">
                    <h5 class="card-title">My Documents Overview</h5>
                </div>
                <p class="text-muted">Your documents are displayed in the sections above. Use the upload form to add new documents or manage existing ones in the table.</p>
            </div>
        </div>
    </div>

    {# History Tab #}
    <div class="tab-content" id="history-tab">
        <div class="card app-card-settings">
            <div class="card-body">
                <div class="card-header-row">
                    <h5 class="card-title">Document History</h5>
                </div>

                <div class="table-responsive">
                    <table class="table document-table history-table align-middle">
                        <thead>
                            <tr>
                                <th>S. No</th>
                                <th>Document Name</th>
                                <th>Action</th>
                                <th>Date & Time</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set historyEntries = [] %}
                            
                            {# Add document upload history #}
                            {% for document in documents %}
                                {% set historyEntries = historyEntries|merge([{
                                    'name': document.category ?: document.name,
                                    'action': 'uploaded',
                                    'date': document.createdAt,
                                    'details': 'Document uploaded to your library'
                                }]) %}
                                
                                {% if document.updatedAt and document.updatedAt != document.createdAt %}
                                    {% set historyEntries = historyEntries|merge([{
                                        'name': document.category ?: document.name,
                                        'action': 'updated',
                                        'date': document.updatedAt,
                                        'details': 'Document information updated'
                                    }]) %}
                                {% endif %}
                            {% endfor %}
                            
                            {# Add document assignment history #}
                            {% for documentRequest in documentRequests %}
                                {% if documentRequest.providedAt %}
                                    {% set historyEntries = historyEntries|merge([{
                                        'name': documentRequest.name,
                                        'action': 'assigned',
                                        'date': documentRequest.providedAt,
                                        'details': 'Document assigned to ' ~ (documentRequest.application.employer.companyName ?? 'employer')
                                    }]) %}
                                {% endif %}
                            {% endfor %}
                            
                            {# Sort history by date (newest first) #}
                            {% set historyEntries = historyEntries|sort((a, b) => b.date <=> a.date) %}
                            
                            {% if historyEntries|length > 0 %}
                                {% for entry in historyEntries %}
                                    <tr>
                                        <td>{{ loop.index }}</td>
                                        <td>
                                            <strong>{{ entry.name }}</strong>
                                        </td>
                                        <td>
                                            {% if entry.action == 'uploaded' %}
                                                <span class="action-badge uploaded">Uploaded</span>
                                            {% elseif entry.action == 'updated' %}
                                                <span class="action-badge updated">Updated</span>
                                            {% elseif entry.action == 'assigned' %}
                                                <span class="action-badge assigned">Assigned</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ entry.date|date('m/d/Y g:i A') }}</td>
                                        <td>
                                            <small class="text-muted">{{ entry.details }}</small>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="empty-state-compact">
                                        <div class="empty-state-icon">ðŸ“Š</div>
                                        <p class="mb-0">No history available</p>
                                        <p class="text-muted small mt-2">Your document activities will appear here</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    {# Credentials Tab - Updated with Credentialing Links #}
    <div class="tab-content" id="credentials-tab">
        <div class="card app-card-settings">
            <div class="card-body">
                <div class="card-header-row">
                    <h5 class="card-title">External Links</h5>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-primary">{{ credentialingLinks|length }} Links</span>
                    </div>
                </div>

                {% if credentialingLinks|length > 0 %}
                    <div class="credentials-grid">
                        {% for link in credentialingLinks %}
                            <div class="credential-card">
                                <div class="credential-header">
                                    <div class="credential-icon">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                                        </svg>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="credential-title">{{ link.title }}</h6>
                                        <div class="d-flex align-items-center gap-2 mt-1">
                                            {% if link.sender %}
                                                <small class="text-muted">From: {{ link.sender }}</small>
                                            {% endif %}
                                            <small class="text-muted">â€¢</small>
                                            <small class="text-muted">{{ link.createdAt|date('M d, Y') }}</small>
                                        </div>
                                    </div>
                                </div>
                                
                                {% if link.description %}
                                    <p class="credential-description">{{ link.description }}</p>
                                {% endif %}
                                
                                <div class="credential-meta mb-3">
                                    <div class="d-flex align-items-center gap-2 text-sm text-muted">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                                        </svg>
                                        <span class="url-preview">{{ link.url|replace({'https://': '', 'http://': ''})|slice(0, 50) }}{{ link.url|length > 50 ? '...' : '' }}</span>
                                    </div>
                                </div>

                                <div class="credential-actions">
                                    <a href="{{ link.url }}" 
                                       target="_blank" 
                                       rel="noopener noreferrer"
                                       class="action-btn btn-primary"
                                       title="Open this external link in a new tab">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                            <polyline points="15 3 21 3 21 9"/>
                                            <line x1="10" y1="14" x2="21" y2="3"/>
                                        </svg>
                                        Open Link
                                    </a>
                                    
                                    <button type="button" 
                                            class="action-btn btn-secondary copy-link-btn"
                                            data-url="{{ link.url }}"
                                            title="Copy link to clipboard">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                        </svg>
                                        Copy URL
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state-compact">
                        <div class="empty-state-icon">ðŸ”—</div>
                        <h4>No External Links</h4>
                        <p class="text-muted">You don't have any external links shared with you yet.</p>
                        <div class="mt-3">
                            <p class="small text-info">
                                <strong>About External Links:</strong><br>
                                â€¢ Employers or systems may share links with you here<br>
                                â€¢ Links can open forms, upload pages, or any external service<br>
                                â€¢ All links open in new browser tabs for security<br>
                                â€¢ You can copy links to access them later
                            </p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block footer_scripts %}
    <script src="{{ asset('assets/admin/js/form-validation.js') }}"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        // Tab functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Tab switching
            document.querySelectorAll('.documents-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs and contents
                    document.querySelectorAll('.documents-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Show corresponding content
                    const tabId = this.getAttribute('data-tab');
                    const content = document.getElementById(`${tabId}-tab`);
                    if (content) {
                        content.classList.add('active');
                    }
                });
            });

            // Initialize flatpickr
            if (typeof flatpickr !== 'undefined') {
                document.querySelectorAll('.js-datepicker').forEach(function(input) {
                    if (!input._flatpickr) {
                        flatpickr(input, {
                            dateFormat: "Y-m-d"
                        });
                    }
                });
            } else if (typeof $ !== 'undefined' && $.fn.flatpickr) {
                $(".js-datepicker").flatpickr();
            }

            // File upload dropzone functionality
            const dropzone = document.getElementById('uploadDropzone');
            const fileInput = document.getElementById('fileInput');

            if (dropzone && fileInput) {
                // Click to upload
                dropzone.addEventListener('click', function(e) {
                    if (e.target.closest('.file-badge') || e.target.closest('.file-remove-btn')) {
                        return;
                    }
                    fileInput.click();
                });

                // Drag and drop
                dropzone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    dropzone.style.background = '#e8f4e8';
                });

                dropzone.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    dropzone.style.background = '#F4F9F1';
                });

                dropzone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    dropzone.style.background = '#F4F9F1';
                    
                    if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                        fileInput.files = e.dataTransfer.files;
                        handleFileChange(fileInput);
                    }
                });
            }

            // Document request assignment with SweetAlert
            document.querySelectorAll('.document-select').forEach(select => {
                select.addEventListener('change', function() {
                    const documentId = this.value;
                    const requestId = this.dataset.requestId;
                    const selectElement = this;

                    if (!documentId) return;

                    // Show loading state
                    const originalValue = selectElement.value;
                    selectElement.disabled = true;

                    // FIX: Add /provider prefix to match the controller route
                    fetch(`/provider/document-request/${requestId}/assign-document`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRF-TOKEN': '{{ csrf_token("assign_document") }}'
                        },
                        body: JSON.stringify({ documentId: documentId })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        selectElement.disabled = false;
                        if (data.success) {
                            // Success handling
                            const row = selectElement.closest('tr');
                            row.style.opacity = '0.5';
                            setTimeout(() => {
                                row.remove();
                                updateEmptyState();
                                
                                // Also remove from split view if it exists
                                const splitCard = document.querySelector(`.split-document-card[data-request-id="${requestId}"]`);
                                if (splitCard) {
                                    splitCard.remove();
                                    updateSplitViewEmptyState();
                                }
                            }, 500);
                            
                            showSuccessAlert('Success!', data.message || 'Document provided successfully.');
                        } else {
                            selectElement.value = originalValue;
                            showErrorAlert('Error', data.message || 'Unable to provide document. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        selectElement.disabled = false;
                        selectElement.value = originalValue;
                        showErrorAlert('Error', 'An error occurred while assigning the document. Please try again.');
                    });
                });
            });

            // Form validation with SweetAlert
            const documentForm = document.querySelector('form.needs-validation');
            if (documentForm) {
                documentForm.addEventListener('submit', function(e) {
                    // Validate form before submission
                    if (!this.checkValidity()) {
                        e.preventDefault();
                        e.stopPropagation();
                        this.classList.add('was-validated');
                        showWarningAlert('Validation Error', 'Please fill in all required fields correctly.');
                        return false;
                    }

                    // Show loading state on button
                    const submitButton = this.querySelector('button[type="submit"]');
                    if (submitButton) {
                        const originalButtonText = submitButton.innerHTML;
                        submitButton.disabled = true;
                        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
                        
                        // Re-enable button after a delay in case of errors
                        setTimeout(() => {
                            submitButton.disabled = false;
                            submitButton.innerHTML = originalButtonText;
                        }, 5000);
                    }
                });
            }

            // Check for flash messages and show SweetAlert
            {% for label, messages in app.flashes %}
                {% for message in messages %}
                    {% if label == 'success' %}
                        showSuccessAlert('Success!', '{{ message|e('js') }}');
                    {% elseif label == 'error' %}
                        showErrorAlert('Error!', '{{ message|e('js') }}');
                    {% elseif label == 'warning' %}
                        showWarningAlert('Warning!', '{{ message|e('js') }}');
                    {% else %}
                        showInfoAlert('Information', '{{ message|e('js') }}');
                    {% endif %}
                {% endfor %}
            {% endfor %}

            // Document expiration date logic
            const documentCategorySelect = document.querySelector('select[name*="[category]"]');
            const issueDateInput = document.getElementById('document_issueDate');
            const expirationDateInput = document.getElementById('document_expirationDate');
            const expirationDateHelp = document.getElementById('expiration-date-help');
            const expirationDateContainer = expirationDateInput?.closest('.mb-3');

            // Documents that require expiration date (fillable issue/expiry)
            const requiresExpirationDate = [
                'Life support certifications',
                'Active and Inactive medical licenses',
                'All DEAs',
                'CSR (Controlled Substance Registration)'
            ];

            // Documents with auto-expiry of 1 year
            const autoExpiryDocuments = [
                'Negative TB test (TST vs IGRA) in the last 12 months (or if positive a CXR is required)',
                'Influenza vaccine proof',
                'COVID-19 vaccine proof',
                'Mask fit testing'
            ];

            function updateExpirationDateLogic() {
                if (!documentCategorySelect || !expirationDateInput || !expirationDateContainer) return;

                const selectedCategory = documentCategorySelect.value;
                const expirationDateLabel = expirationDateContainer.querySelector('label');
                const expirationDateField = expirationDateInput.closest('.mb-3');

                if (!selectedCategory) {
                    expirationDateField.style.display = 'block';
                    expirationDateInput.required = false;
                    expirationDateHelp.style.display = 'none';
                    expirationDateInput.value = '';
                    return;
                }

                // Check if document requires expiration date
                if (requiresExpirationDate.includes(selectedCategory)) {
                    expirationDateField.style.display = 'block';
                    expirationDateInput.required = true;
                    expirationDateHelp.style.display = 'none';
                    expirationDateHelp.textContent = '';
                    if (expirationDateLabel) {
                        expirationDateLabel.innerHTML = 'Expiration Date <span class="text-danger">*</span>';
                    }
                } 
                // Check if document has auto-expiry
                else if (autoExpiryDocuments.includes(selectedCategory)) {
                    expirationDateField.style.display = 'block';
                    expirationDateInput.required = false;
                    expirationDateHelp.style.display = 'block';
                    expirationDateHelp.textContent = 'This document will auto-expire 1 year from the issue date.';
                    if (expirationDateLabel) {
                        expirationDateLabel.innerHTML = 'Expiration Date (Auto-calculated)';
                    }
                    // Auto-calculate if issue date is set
                    if (issueDateInput && issueDateInput.value) {
                        calculateAutoExpiry();
                    }
                } 
                // Other documents - expiration date is optional
                else {
                    expirationDateField.style.display = 'block';
                    expirationDateInput.required = false;
                    expirationDateHelp.style.display = 'none';
                    expirationDateHelp.textContent = '';
                    if (expirationDateLabel) {
                        expirationDateLabel.innerHTML = 'Expiration Date';
                    }
                }
            }

            function calculateAutoExpiry() {
                if (!issueDateInput || !expirationDateInput) return;
                
                const selectedCategory = documentCategorySelect.value;
                if (!autoExpiryDocuments.includes(selectedCategory)) return;

                const issueDate = new Date(issueDateInput.value);
                if (isNaN(issueDate.getTime())) return;

                // Add 1 year to issue date
                const expirationDate = new Date(issueDate);
                expirationDate.setFullYear(expirationDate.getFullYear() + 1);

                // Format as YYYY-MM-DD for input
                const year = expirationDate.getFullYear();
                const month = String(expirationDate.getMonth() + 1).padStart(2, '0');
                const day = String(expirationDate.getDate()).padStart(2, '0');
                expirationDateInput.value = `${year}-${month}-${day}`;
            }

            // Listen for category changes
            if (documentCategorySelect) {
                documentCategorySelect.addEventListener('change', updateExpirationDateLogic);
                updateExpirationDateLogic(); // Initialize on page load
            }

            // Listen for issue date changes to auto-calculate expiration
            if (issueDateInput) {
                issueDateInput.addEventListener('change', function() {
                    const selectedCategory = documentCategorySelect.value;
                    if (autoExpiryDocuments.includes(selectedCategory)) {
                        calculateAutoExpiry();
                    }
                });
            }

            // Add helper functions for empty state management
            window.updateEmptyState = function() {
                const tbody = document.querySelector('#requests-list-view tbody');
                const remainingRows = tbody.querySelectorAll('tr');
                
                if (remainingRows.length === 0 || 
                    (remainingRows.length === 1 && remainingRows[0].querySelector('.empty-state'))) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="empty-state-icon">ðŸ“‹</div>
                                <p class="mb-0">No pending document requests found.</p>
                                <p class="text-muted small mt-2">All document requests have been provided.</p>
                            </td>
                        </tr>
                    `;
                }
            };

            window.updateSplitViewEmptyState = function() {
                const splitList = document.getElementById('requests-split-list');
                if (splitList && splitList.children.length === 0) {
                    const noDocumentSelected = document.querySelector('#requests-split-details .no-document-selected');
                    const documentContent = document.getElementById('requests-document-content');
                    if (noDocumentSelected) noDocumentSelected.style.display = 'flex';
                    if (documentContent) documentContent.style.display = 'none';
                }
            };

            // Copy link functionality for credentialing links
            document.querySelectorAll('.copy-link-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const url = this.getAttribute('data-url');
                    navigator.clipboard.writeText(url).then(() => {
                        // Show temporary success feedback
                        const originalHtml = this.innerHTML;
                        this.innerHTML = `
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                            Copied!
                        `;
                        this.classList.add('btn-success');
                        
                        setTimeout(() => {
                            this.innerHTML = originalHtml;
                            this.classList.remove('btn-success');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy: ', err);
                        alert('Failed to copy link to clipboard');
                    });
                });
            });

            // Optional: Track link opens (if needed)
            document.querySelectorAll('a[target="_blank"]').forEach(link => {
                link.addEventListener('click', function() {
                    // You can add analytics here if needed
                    console.log('External link opened:', this.href);
                });
            });
        });

        function handleFileChange(input) {
            const badge = document.getElementById('fileBadge');
            const nameText = document.getElementById('fileNameText');

            if (input && input.files && input.files.length > 0) {
                if (nameText) nameText.textContent = input.files[0].name;
                if (badge) badge.style.display = 'flex';
            } else {
                if (badge) badge.style.display = 'none';
            }
        }

        function clearFile() {
            const input = document.getElementById('fileInput');
            const badge = document.getElementById('fileBadge');

            if (input) {
                input.value = '';
                const event = new Event('change', { bubbles: true });
                input.dispatchEvent(event);
            }
            if (badge) badge.style.display = 'none';
        }

        // Split View Functionality for Document Requests
        document.addEventListener('DOMContentLoaded', function() {
            const requestsSplitViewBtn = document.getElementById('requests-split-view-btn');
            const requestsListView = document.getElementById('requests-list-view');
            const requestsSplitViewContainer = document.getElementById('requests-split-view-container');
            const requestsSplitList = document.getElementById('requests-split-list');
            const requestsSplitDetails = document.getElementById('requests-split-details');
            const requestsDocumentContent = document.getElementById('requests-document-content');
            const requestsNoDocumentSelected = requestsSplitDetails.querySelector('.no-document-selected');
            const requestsToggleBtn = document.getElementById('requests-list-toggle-btn');

            if (requestsSplitViewBtn && requestsListView && requestsSplitViewContainer) {
                requestsSplitViewBtn.addEventListener('click', function() {
                    const isSplitView = requestsSplitViewContainer.style.display === 'grid';
                    
                    if (isSplitView) {
                        // Switch to list view
                        requestsSplitViewContainer.style.display = 'none';
                        requestsListView.style.display = 'block';
                        requestsSplitViewBtn.classList.remove('active');
                        requestsSplitViewBtn.innerHTML = `
                            <svg class="icon-image" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 3H10V10H3V3Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M14 3H21V10H14V3Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M3 14H10V21H3V14Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M14 14H21V21H14V14Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Split View
                        `;
                        if (requestsToggleBtn) requestsToggleBtn.style.display = 'none';
                    } else {
                        // Switch to split view
                        requestsSplitViewContainer.style.display = 'grid';
                        requestsListView.style.display = 'none';
                        requestsSplitViewBtn.classList.add('active');
                        requestsSplitViewBtn.innerHTML = `
                            <svg class="icon-image" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 6H21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                <path d="M3 11H21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                <path d="M3 16H21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                            List View
                        `;
                        if (requestsToggleBtn) {
                            requestsToggleBtn.style.display = 'flex';
                            updateToggleButtonPosition('requests');
                        }
                    }
                });
            }

            // Document card selection for requests
            if (requestsSplitList) {
                requestsSplitList.addEventListener('click', function(e) {
                    const card = e.target.closest('.split-document-card');
                    if (card) {
                        selectDocumentCard(card, 'requests');
                    }
                });
            }

            // Split View Functionality for Uploaded Documents
            const documentsSplitViewBtn = document.getElementById('documents-split-view-btn');
            const documentsListView = document.getElementById('documents-list-view');
            const documentsSplitViewContainer = document.getElementById('documents-split-view-container');
            const documentsSplitList = document.getElementById('documents-split-list');
            const documentsSplitDetails = document.getElementById('documents-split-details');
            const documentsDocumentContent = document.getElementById('documents-document-content');
            const documentsNoDocumentSelected = documentsSplitDetails.querySelector('.no-document-selected');
            const documentsToggleBtn = document.getElementById('documents-list-toggle-btn');

            if (documentsSplitViewBtn && documentsListView && documentsSplitViewContainer) {
                documentsSplitViewBtn.addEventListener('click', function() {
                    const isSplitView = documentsSplitViewContainer.style.display === 'grid';
                    
                    if (isSplitView) {
                        // Switch to list view
                        documentsSplitViewContainer.style.display = 'none';
                        documentsListView.style.display = 'block';
                        documentsSplitViewBtn.classList.remove('active');
                        documentsSplitViewBtn.innerHTML = `
                            <svg class="icon-image" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 3H10V10H3V3Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M14 3H21V10H14V3Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M3 14H10V21H3V14Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M14 14H21V21H14V14Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Split View
                        `;
                        if (documentsToggleBtn) documentsToggleBtn.style.display = 'none';
                    } else {
                        // Switch to split view
                        documentsSplitViewContainer.style.display = 'grid';
                        documentsListView.style.display = 'none';
                        documentsSplitViewBtn.classList.add('active');
                        documentsSplitViewBtn.innerHTML = `
                            <svg class="icon-image" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 6H21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                <path d="M3 11H21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                <path d="M3 16H21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                            List View
                        `;
                        if (documentsToggleBtn) {
                            documentsToggleBtn.style.display = 'flex';
                            updateToggleButtonPosition('documents');
                        }
                    }
                });
            }

            // Document card selection for uploaded documents
            if (documentsSplitList) {
                documentsSplitList.addEventListener('click', function(e) {
                    const card = e.target.closest('.split-document-card');
                    if (card) {
                        selectDocumentCard(card, 'documents');
                    }
                });
            }

            // Function to select document card and render preview
            function selectDocumentCard(card, section) {
                const isRequests = section === 'requests';
                const splitList = isRequests ? requestsSplitList : documentsSplitList;
                const splitDetails = isRequests ? requestsSplitDetails : documentsSplitDetails;
                const documentContent = isRequests ? requestsDocumentContent : documentsDocumentContent;
                const noDocumentSelected = isRequests ? requestsNoDocumentSelected : documentsNoDocumentSelected;
                const linkedDocumentId = card.dataset.documentId;
                const linkedDocumentUrl = card.dataset.documentUrl;
                const formatValue = (val) => {
                    if (!val) return 'â€”';
                    const normalized = String(val).trim();
                    return normalized.length ? normalized : 'â€”';
                };
                
                // Remove active class from all cards
                splitList.querySelectorAll('.split-document-card').forEach(c => {
                    c.classList.remove('active');
                });
                
                // Add active class to selected card
                card.classList.add('active');
                
                // Get document ID and name
                const documentName = card.dataset.documentName || card.querySelector('.split-document-card-title')?.textContent || 'Document';
                const documentId = linkedDocumentId;
                const documentUrl = linkedDocumentUrl;

                if (isRequests) {
                    if (noDocumentSelected) noDocumentSelected.style.display = 'none';
                    documentContent.style.display = 'block';

                    const requestName = card.dataset.requestName || documentName;
                    const jobTitle = card.dataset.jobTitle || '';
                    const employer = card.dataset.employer || '';
                    const requestedAt = card.dataset.requestedAt || '';
                    const status = card.dataset.status || 'Pending';
                    const jobLocation = card.dataset.jobLocation || '';
                    const jobNeed = card.dataset.jobNeed || '';
                    const jobSchedule = card.dataset.jobSchedule || '';
                    const jobId = card.dataset.jobId || '';
                    const statusClass = status.toLowerCase() === 'provided' ? 'status-provided' : 'status-pending';

                    let instructionsMarkup = `
                        <div class="request-instructions">
                            <h6>Next Steps</h6>
                            <p class="mb-1">Select an uploaded document from the dropdown in the list view to provide this request.</p>
                            <p class="mb-0 text-muted small">Once assigned, the status will update automatically.</p>
                        </div>
                    `;

                    if (linkedDocumentId && linkedDocumentUrl) {
                        instructionsMarkup = `
                            <div class="request-instructions">
                                <h6>Linked Document</h6>
                                <p class="mb-3 text-muted small">This request already has a document assigned. You can review it below.</p>
                                <div class="d-flex flex-wrap gap-2">
                                    <a href="/provider/documents/view/${linkedDocumentId}" class="btn btn-primary" style="padding:8px 16px;">View Document</a>
                                    <a href="${linkedDocumentUrl}" target="_blank" class="btn btn-secondary" style="padding:8px 16px;">Open File</a>
                                </div>
                            </div>
                        `;
                    }

                    const jobIdMeta = jobId ? `
                        <div class="request-meta-item">
                            <span>Job ID</span>
                            <strong>${jobId}</strong>
                        </div>
                    ` : '';

                    documentContent.innerHTML = `
                        <div class="request-preview-container">
                            <div class="document-preview-header">
                                <div>
                                    <div class="document-preview-title">${requestName}</div>
                                    <p class="text-muted mb-0">${jobTitle}</p>
                                </div>
                                <span class="request-status-badge ${statusClass}">${status}</span>
                            </div>
                            <div class="request-meta-grid">
                                ${jobIdMeta}
                                <div class="request-meta-item">
                                    <span>Employer</span>
                                    <strong>${formatValue(employer)}</strong>
                                </div>
                                <div class="request-meta-item">
                                    <span>Requested On</span>
                                    <strong>${formatValue(requestedAt)}</strong>
                                </div>
                                <div class="request-meta-item">
                                    <span>Location</span>
                                    <strong>${formatValue(jobLocation)}</strong>
                                </div>
                                <div class="request-meta-item">
                                    <span>Need</span>
                                    <strong>${formatValue(jobNeed)}</strong>
                                </div>
                                <div class="request-meta-item">
                                    <span>Schedule</span>
                                    <strong>${formatValue(jobSchedule)}</strong>
                                </div>
                            </div>
                            ${instructionsMarkup}
                        </div>
                    `;
                    return;
                }
                
                if (documentId && documentUrl) {
                    // Hide empty state, show content
                    if (noDocumentSelected) noDocumentSelected.style.display = 'none';
                    documentContent.style.display = 'block';
                    
                    // Determine file type and render accordingly
                    const fileExtension = documentUrl.split('.').pop().toLowerCase();
                    let previewHTML = '';
                    
                    if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExtension)) {
                        previewHTML = `
                            <div class="document-preview-container">
                                <div class="document-preview-header">
                                    <div class="document-preview-title">${documentName}</div>
                                    <div class="document-preview-actions">
                                        <a href="/provider/documents/view/${documentId}" class="action-btn" title="View Full Page">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M13 3H21V11M21 3L11 13M21 3V7M21 3H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            View Full Page
                                        </a>
                                        <a href="${documentUrl}" target="_blank" class="action-btn" title="Open in New Tab">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M13 3H21V11M21 3L11 13M21 3V7M21 3H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            Open in New Tab
                                        </a>
                                    </div>
                                </div>
                                <div class="document-preview-frame">
                                    <img src="${documentUrl}" alt="${documentName}" />
                                </div>
                            </div>
                        `;
                    } else if (['pdf'].includes(fileExtension)) {
                        previewHTML = `
                            <div class="document-preview-container">
                                <div class="document-preview-header">
                                    <div class="document-preview-title">${documentName}</div>
                                    <div class="document-preview-actions">
                                        <a href="/provider/documents/view/${documentId}" class="action-btn" title="View Full Page">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M13 3H21V11M21 3L11 13M21 3V7M21 3H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            View Full Page
                                        </a>
                                        <a href="${documentUrl}" target="_blank" class="action-btn" title="Open in New Tab">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M13 3H21V11M21 3L11 13M21 3V7M21 3H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            Open in New Tab
                                        </a>
                                    </div>
                                </div>
                                <div class="document-preview-frame">
                                    <iframe src="${documentUrl}" type="application/pdf"></iframe>
                                </div>
                            </div>
                        `;
                    } else {
                        previewHTML = `
                            <div class="document-preview-container">
                                <div class="document-preview-header">
                                    <div class="document-preview-title">${documentName}</div>
                                    <div class="document-preview-actions">
                                        <a href="${documentUrl}" target="_blank" class="action-btn" title="Open in New Tab">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M13 3H21V11M21 3L11 13M21 3V7M21 3H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                        </a>
                                    </div>
                                </div>
                                <div class="document-preview-frame" style="display: flex; align-items: center; justify-content: center; padding: 40px;">
                                    <div style="text-align: center;">
                                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 16px; opacity: 0.5;">
                                            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                        <p style="color: #6b7280; margin-bottom: 16px;">Preview not available for this file type</p>
                                        <div style="display: flex; gap: 8px; justify-content: center;">
                                            <a href="/provider/documents/view/${documentId}" class="action-btn" style="display: inline-flex; padding: 8px 16px;">
                                                View Full Page
                                            </a>
                                            <a href="${documentUrl}" target="_blank" class="action-btn" style="display: inline-flex; padding: 8px 16px;">
                                                Open in New Tab
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    documentContent.innerHTML = previewHTML;
                } else {
                    // No document URL, show message
                    if (noDocumentSelected) noDocumentSelected.style.display = 'flex';
                    documentContent.style.display = 'none';
                }
            }

            // Toggle button functionality for requests
            if (requestsToggleBtn && requestsSplitViewContainer) {
                setupListToggle('requests', requestsToggleBtn, requestsSplitViewContainer, requestsSplitList, requestsSplitDetails);
            }

            // Toggle button functionality for documents
            if (documentsToggleBtn && documentsSplitViewContainer) {
                setupListToggle('documents', documentsToggleBtn, documentsSplitViewContainer, documentsSplitList, documentsSplitDetails);
            }

            function setupListToggle(section, toggleBtn, container, splitList, splitDetails) {
                toggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isCollapsed = container.classList.contains('list-collapsed');
                    
                    if (isCollapsed) {
                        expandList(container, splitList, splitDetails);
                    } else {
                        collapseList(container, splitList, splitDetails);
                    }
                    
                    setTimeout(() => updateToggleButtonPosition(section), 100);
                });

                // Update position on resize and scroll
                window.addEventListener('resize', () => updateToggleButtonPosition(section));
                window.addEventListener('scroll', () => updateToggleButtonPosition(section), true);
            }

            function collapseList(container, splitList, splitDetails) {
                if (!container.classList.contains('list-collapsed')) {
                    container.classList.add('list-collapsed');
                    if (splitList) {
                        splitList.style.display = 'none';
                        splitList.style.width = '0';
                        splitList.style.minWidth = '0';
                        splitList.style.maxWidth = '0';
                        splitList.style.padding = '0';
                        splitList.style.margin = '0';
                        splitList.style.visibility = 'hidden';
                    }
                    if (splitDetails) {
                        splitDetails.style.gridColumn = '1 / -1';
                        splitDetails.style.width = '100%';
                        splitDetails.style.maxWidth = '100%';
                    }
                }
            }

            function expandList(container, splitList, splitDetails) {
                if (container.classList.contains('list-collapsed')) {
                    container.classList.remove('list-collapsed');
                    if (splitList) {
                        splitList.style.display = 'block';
                        splitList.style.width = '';
                        splitList.style.minWidth = '';
                        splitList.style.maxWidth = '';
                        splitList.style.padding = '';
                        splitList.style.margin = '';
                        splitList.style.visibility = 'visible';
                    }
                    if (splitDetails) {
                        splitDetails.style.gridColumn = '';
                        splitDetails.style.width = '';
                        splitDetails.style.maxWidth = '';
                    }
                }
            }

            function updateToggleButtonPosition(section) {
                const isRequests = section === 'requests';
                const toggleBtn = isRequests ? requestsToggleBtn : documentsToggleBtn;
                const container = isRequests ? requestsSplitViewContainer : documentsSplitViewContainer;
                const splitDetails = isRequests ? requestsSplitDetails : documentsSplitDetails;
                
                if (!toggleBtn || !container || container.style.display !== 'grid') {
                    if (toggleBtn) toggleBtn.style.display = 'none';
                    return;
                }
                
                const isCollapsed = container.classList.contains('list-collapsed');
                
                if (isCollapsed) {
                    toggleBtn.style.display = 'flex';
                    if (splitDetails) {
                        const detailsRect = splitDetails.getBoundingClientRect();
                        toggleBtn.style.position = 'fixed';
                        toggleBtn.style.left = (detailsRect.left - 18) + 'px';
                        toggleBtn.style.top = (detailsRect.top + 60) + 'px';
                        toggleBtn.style.transform = 'none';
                    }
                } else {
                    toggleBtn.style.display = 'none';
                }
            }

            // Deep-link: open a specific document request in split view if provided via query param
            (function() {
                try {
                    const params = new URLSearchParams(window.location.search);
                    const openRequestId = params.get('openRequest');
                    if (openRequestId) {
                        // Ensure split view is active
                        if (requestsSplitViewContainer && requestsSplitViewContainer.style.display !== 'grid') {
                            requestsSplitViewBtn && requestsSplitViewBtn.click();
                        }
                        // Find the matching card and select it
                        const targetCard = document.querySelector('.split-document-card[data-request-id="' + openRequestId + '"]');
                        if (targetCard) {
                            selectDocumentCard(targetCard, 'requests');
                            // Optionally collapse list to focus on details
                            if (requestsSplitViewContainer) {
                                collapseList(requestsSplitViewContainer, requestsSplitList, requestsSplitDetails);
                                updateToggleButtonPosition('requests');
                            }
                            // Smooth scroll to details area
                            setTimeout(() => {
                                requestsSplitDetails && requestsSplitDetails.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }, 150);
                        }
                    }
                } catch (e) {
                    console.warn('Deep-link openRequest handler error:', e);
                }
            })();
        });
    </script>
{% endblock %}