{% extends 'admin/base.html.twig' %}

{% block title %}Applications for {{ job.title }}{% endblock %}

{% block admin_body %}
    {% set statusColors = {
        'applied': 'applied',
        'in_review': 'review',
        'interview': 'interview',
        'offered': 'offered',
        'rejected': 'rejected',
        'hired': 'hired',
        'completed': 'completed'
    } %}

    {% set transitionColors = {
        'review': 'warning',
        'interview': 'interview',
        'reject': 'danger',
        'decline': 'danger',
        'offer': 'success',
        'hire': 'success',
        'complete': 'success',
    } %}

    <div class="container-xl">

        <div class="row">
            <div class="col-12">
                <div class="card application-header">
                    <div class="card-body">
                        <div>
                            <h3>{{ job.title }}</h3>
                            <p>{{ job.workType }}</p>
                            <p>{{ job.need }}</p>
                            <p>{{ job.schedule }}</p>
                            <p>{{ job.state ~', '~ job.city }}</p>
                            <p>Expires in {{ job.expirationDate ? job.expirationDate|date('m/d/Y')|ago }}</p>
                        </div>
                        <div class="status">
                            <span class="badge badge-pill bg-{% if job.status == 'published' %}success{% elseif job.status == 'closed' %}danger{% endif %}">{{ job.status|capitalize }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-2">
            <div class="col-12 col-md-4">
                <div class="left-aside">
                {% for application in applications %}
                    {% set provider = application.provider %}
                    {% set user = provider.user %}

                    <a href="{{ path('app_admin_job_applications', {'id': job.id, 'applicationId': application.id}) }}">
                    <div class="card card-v2 {% if app.request.get('applicationId') == application.id or app.request.get('applicationId') is empty and loop.index == 1 %}active-card{% endif %}" id="{{ application.id }}">
                        <div class="card-body">
                            {% if provider.user.profilePicture %}
                                <img src="{{ provider.user.profilePicture }}" width="40px" />
                            {% endif %}
                            <div>
                                <h4>{{ user.name }}</h4>
                                <p><i class="fa fa-clock"></i>{{ application.createdAt|time_diff }}</p>
                                <p><i class="fa fa-star"></i>{{ application.provider.averagePoint ? : 'Not Rated Yet' }}</p>
                                <p><i class="fa fa-map-marked"></i> {{ provider.country~' '~provider.state~' '~provider.city }}</p>
                                <p><i class="fa fa-mobile"></i> {{ provider.phoneMobile }}</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <span class="badge badge-pill is-{{ statusColors[application.status] }}">
                                {{ application.status | replace({'_': ' '}) | title }}
                            </span>
                        </div>
                    </div>
                    </a>
                {% endfor %}
            </div>
            </div>

            {% set application = applicationDetail %}
            {% set provider = application.provider %}

            <div class="col-12 col-md-8">
                <div class="right-aside">
                <div class="card card-v2 mb-3">
                    <div class="card-body">
                        <div>
                            {% if provider.user.profilePicture %}
                            <img src="{{ provider.user.profilePicture }}" width="40px" />
                            {% endif %}
                            <div>
                                <h3>{{ provider.user.name }}'s Application</h3>
                                <p><i class="fa fa-clock"></i> {{ application.createdAt|time_diff }}</p>
                                <p><i class="fa fa-star"></i> {{ application.provider.averagePoint ? : 'Not Rated Yet' }}</p>
                            </div>
                        </div>
                        <span class="badge badge-pill is-{{ statusColors[application.status] }}">
                            {{ application.status | replace({'_': ' '}) | title }}
                        </span>
                    </div>
                </div>

                {% if  provider.cvFilename %}
                    <div class="row">
                    <div class="col-lg-12 mb-4">
                        <h5 class="mb-3 summary-title">CV</h5>
                        <div class="card summary-card shadow-sm border-light">
                            <div class="card-body p-2">
                                <a href="#" data-bs-toggle="modal" data-bs-target="#previewModal{{ provider.id }}">
                                    <i class="fa fa-eye"></i>
                                </a> {{ provider.cvFilename }}

                                <!-- Modal -->
                                <div class="modal fade" id="previewModal{{ provider.id }}" tabindex="-1" aria-labelledby="previewModalLabel{{ provider.id }}" aria-hidden="true">
                                    <div class="modal-dialog modal-xl">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="previewModalLabel{{ provider.id }}">File Preview - {{ provider.cvFilename }}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                {% set filePath = asset('uploads/' ~ provider.user.id ~ '/' ~ provider.cvFilename) %}
                                                {% if provider.cvFilename ends with '.pdf' %}
                                                    <iframe src="{{ filePath }}" width="100%" height="600px" style="border: none;"></iframe>
                                                {% else %}
                                                    <div class="text-center">
                                                        <p><strong>This file type cannot be previewed.</strong></p>
                                                        <a href="{{ filePath }}" class="btn btn-primary" target="_blank" download>Download {{ provider.cvFilename }}</a>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if application.oneFileProvidedAt %}
                    <div class="row">
                        <!-- Basic Information -->
                        <div class="col-lg-12 mb-4">
                            <h5 class="mb-3 summary-title">Basic Information</h5>
                            <div class="card summary-card shadow-sm border-light">
                                <div class="card-body">
                                    <ul class="list-unstyled">
                                        <li><strong>Name:</strong> {{ provider.name }}</li>
                                        <li><strong>Suffix:</strong> {{ provider.suffix }}</li>
                                        <li><strong>Title:</strong> {{ provider.title }}</li>
                                        <li><strong>NPI Number:</strong> {{ provider.npiNumber }}</li>
                                        <li><strong>Date of Birth:</strong> {{ provider.dob | date("m/d/Y") }}</li>
                                        <li><strong>SSN:</strong> {{ provider.ssn }}</li>
                                        <li><strong>Country of Birth:</strong> {{ provider.countryOfBirth }}</li>
                                        <li><strong>State of Birth:</strong> {{ provider.stateOfBirth }}</li>
                                        <li><strong>City of Birth:</strong> {{ provider.cityOfBirth }}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div class="col-lg-12 mb-4">
                            <h5 class="mb-3 summary-title">Contact Information</h5>
                            <div class="card summary-card shadow-sm border-light">
                                <div class="card-body">
                                    <ul class="list-unstyled">
                                        <li><strong>Phone (Home):</strong> {{ provider.phoneHome }}</li>
                                        <li><strong>Phone (Work):</strong> {{ provider.phoneWork }}</li>
                                        <li><strong>Phone (Mobile):</strong> {{ provider.phoneMobile }}</li>
                                        <li><strong>Street Address:</strong> {{ provider.streetAddress }}</li>
                                        <li><strong>City:</strong> {{ provider.city }}</li>
                                        <li><strong>State:</strong> {{ provider.state }}</li>
                                        <li><strong>Country:</strong> {{ provider.country }}</li>
                                        <li><strong>Zip Code:</strong> {{ provider.zipCode }}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-12 mb-4">
                            <h5 class="mb-3 summary-title">Work Preferences</h5>
                            <div class="card summary-card shadow-sm border-light">
                                <div class="card-body">
                                    <ul class="list-unstyled">
                                        <li><strong>Desired Pay Rate:</strong> {{ provider.desiredPayRate }}</li>
                                        <li><strong>Hourly Rate:</strong> {{ provider.payRateHourly }}</li>
                                        <li><strong>Daily Rate:</strong> {{ provider.payRateDaily }}</li>
                                        <li><strong>Desired Hours:</strong> {{ provider.desiredHour }}</li>
                                        <li><strong>Preferred Patient Volume:</strong> {{ provider.preferredPatientVolume }}</li>
                                        <li><strong>Willing to Travel:</strong> {{ provider.willingToTravel ? 'Yes' : 'No' }}</li>
                                        <li><strong>Availability to
                                                Start:</strong> {{ provider.availabilityToStart | date("m/d/Y") }}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <h5 class="mb-3 summary-title">Education & Training</h5>
                        {% for education in educations %}
                            <div class="col-md-12 col-sm-6">
                                <div class="card summary-card shadow-sm border-light mb-3">
                                    <div class="card-body">
                                        <ul class="list-unstyled">
                                            <li><strong>School:</strong> {{ education.school }}</li>
                                            <li><strong>Degree:</strong> {{ education.degree }}</li>
                                            <li><strong>Field of Study:</strong> {{ education.fieldOfStudy }}</li>
                                            <li><strong>Start Date:</strong> {{ education.startDate | date("m/d/Y") }}</li>
                                            <li><strong>End Date:</strong> {{ education.endDate | date("m/d/Y") }}</li>
                                            <li><strong>Grade:</strong> {{ education.grade }}</li>
                                            <li><strong>Description:</strong> {{ education.description }}</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <div class="row">
                        <!-- Work History -->
                        <h5 class="mb-3 summary-title">Work History</h5>
                        {% for experience in experiences %}
                            <div class="col-md-12 col-sm-6">
                                <div class="card summary-card shadow-sm border-light mb-3">
                                    <div class="card-body">
                                        <ul class="list-unstyled">
                                            <li><strong>Title:</strong> {{ experience.title }}</li>
                                            <li><strong>Company:</strong> {{ experience.company }}</li>
                                            <li><strong>Employment Type:</strong> {{ experience.employmentType }}</li>
                                            <li><strong>Start Date:</strong> {{ experience.startDate | date("m/d/Y") }}</li>
                                            <li><strong>End Date:</strong> {{ experience.endDate | date("m/d/Y") }}</li>
                                            <li><strong>Location:</strong> {{ experience.location }}</li>
                                            <li><strong>Location Type:</strong> {{ experience.locationType }}</li>
                                            <li><strong>Description:</strong> {{ experience.description }}</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <div class="row">
                        <!-- Insurances -->
                        <h5 class="mb-3 summary-title">Insurances</h5>
                        {% for insurance in insurances %}
                            <div class="col-md-12 col-sm-6">
                                <div class="card summary-card shadow-sm border-light mb-3">
                                    <div class="card-body">
                                        <ul class="list-unstyled">
                                            <li><strong>Carrier:</strong> {{ insurance.carrier }}</li>
                                            <li><strong>Policy Number:</strong> {{ insurance.policyNumber }}</li>
                                            <li><strong>Amount:</strong> {{ insurance.amount }}</li>
                                            <li><strong>State:</strong> {{ insurance.state }}</li>
                                            <li><strong>City:</strong> {{ insurance.city }}</li>
                                            <li><strong>Effective Date:</strong> {{ insurance.effectiveDate | date("m/d/Y") }}
                                            </li>
                                            <li><strong>Expiration Date:</strong> {{ insurance.expirationDate | date("m/d/Y") }}
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}

                    <!-- Document Requests -->
                    {% if documentRequests|length > 0 %}
                        <div class="row">
                            <div class="col-md-12">
                                <h5 class="mb-3 summary-title">Documents</h5>
                                <table class="table">
                                    <tr>
                                        <th>SN</th>
                                        <th>Name</th>
                                        <th>Requested At</th>
                                        <th>Provided At</th>
                                        <th>File</th>
                                    </tr>
                                    {% for documentRequest in documentRequests %}
                                    {% set document = documentRequest.document %}
                                    <tr>
                                        <td>{{ loop.index }}</td>
                                        <td>{{ documentRequest.name }}</td>
                                        <td>{{ documentRequest.createdAt|date('m/d/Y') }}</td>
                                        <td>{{ documentRequest.providedAt ? documentRequest.providedAt|date('m/d/Y') : '-' }}</td>
                                        <td>
                                            {% if document %}
                                            <a href="{{ asset('uploads/' ~ document.user.id ~ '/' ~ document.fileName) }}" target="_blank">
                                                {{ document.fileName }}
                                            </a>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </table>
                            </div>
                        </div>
                    {% endif %}

                {% if application.contractFileName or application.contractSignedFileName %}
                    <div class="row">
                    <!-- Contracts -->
                    <h5 class="mb-3 summary-title">Contracts</h5>
                        <div class="col-md-12 col-sm-6">
                            <div class="card summary-card shadow-sm border-light mb-3">
                                <div class="card-body">
                                    <ul class="list-unstyled">
                                        {% if application.contractFileName %}
                                        <li><strong>Contract File:</strong>
                                            <a href="{{ asset('uploads/contracts/' ~ application.contractFileName) }}" target="_blank">
                                                {{ application.contractFileName }}
                                            </a>
                                        </li>
                                        {% endif %}
                                        {% if application.contractSignedFileName %}
                                        <li><strong>Signed Contract File:</strong>
                                            <a href="{{ asset('uploads/contracts/' ~ application.contractSignedFileName) }}" target="_blank">
                                                {{ application.contractSignedFileName }}
                                            </a>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

    <!-- Send Contract Modal -->
    <div class="modal fade" id="contractModal" tabindex="-1" role="dialog" aria-labelledby="contractModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contractModalLabel">Send Contract</h5>
                </div>
                <form method="post" action="{{ path('app_employer_application_sendcontract', {'id': application.id}) }}" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="form-group">
                        <input type="file" name="contractFile" required />
                    </div>
                </div>
                <div class="modal-footer">
{#                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>#}
                    <button type="submit" class="btn btn-primary">Send</button>
                </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div class="modal fade" id="reviewModal" tabindex="-1" role="dialog" aria-labelledby="reviewModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reviewModalLabel">Write a Review</h5>
                </div>
                <form method="post" action="{{ path('app_employer_application_review_provider', {'id': application.id}) }}">
                    <div class="modal-body">
                        <div class="form-group mb-2">
                            <textarea name="message" class="form-control" required></textarea>
                        </div>
                        <div class="form-group">
                            <select name="point" class="form-control" required>
                                <option value="5">5</option>
                                <option value="4">4</option>
                                <option value="3">3</option>
                                <option value="2">2</option>
                                <option value="1">1</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
{#                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>#}
                        <button type="submit" class="btn btn-primary">Review</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

{% endblock %}

{% block footer_scripts %}
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
{% endblock %}